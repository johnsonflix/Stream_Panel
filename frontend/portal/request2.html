<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Site - Stream Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/request-site.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #f8fafc;
            min-height: 100vh;
        }

        body.loading .request-container {
            visibility: hidden;
        }

        /* Navigation */
        .request-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 30px;
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid #334155;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .request-nav-brand {
            font-size: 22px;
            font-weight: 700;
            color: #f8fafc;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 0 0 200px;
        }
        .request-nav-brand i {
            color: #6366f1;
        }
        .request-nav-links {
            display: flex;
            gap: 25px;
            align-items: center;
            flex: 1;
            justify-content: center;
        }
        .request-nav-link {
            color: #94a3b8;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.2s;
            cursor: pointer;
        }
        .request-nav-link:hover,
        .request-nav-link.active {
            color: #f8fafc;
        }
        .request-nav-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            margin-left: 6px;
            background: #ef4444;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            border-radius: 9px;
            line-height: 1;
        }
        .request-nav-user {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 0 0 200px;
            justify-content: flex-end;
        }
        .request-nav-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        /* Usage Indicator */
        .usage-indicator {
            position: relative;
        }
        .usage-indicator-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            color: #a5b4fc;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .usage-indicator-btn:hover {
            background: rgba(99, 102, 241, 0.25);
            color: #c7d2fe;
        }
        .usage-indicator-btn i {
            font-size: 14px;
        }
        .usage-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 280px;
            background: #1e293b;
            border: 1px solid #374151;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            overflow: hidden;
        }
        .usage-dropdown.show {
            display: block;
        }
        .usage-dropdown-header {
            padding: 12px 16px;
            background: rgba(99, 102, 241, 0.1);
            border-bottom: 1px solid #374151;
            font-size: 13px;
            font-weight: 600;
            color: #e2e8f0;
        }
        .usage-dropdown-content {
            padding: 12px;
        }
        .usage-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .usage-item:last-child {
            margin-bottom: 0;
        }
        .usage-item-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #94a3b8;
        }
        .usage-item-label i {
            width: 16px;
            text-align: center;
        }
        .usage-item-value {
            font-size: 13px;
            font-weight: 600;
        }
        .usage-item-value.unlimited {
            color: #22c55e;
        }
        .usage-item-value.has-limit {
            color: #f8fafc;
        }
        .usage-item-value.near-limit {
            color: #f59e0b;
        }
        .usage-item-value.at-limit {
            color: #ef4444;
        }
        .usage-progress {
            height: 4px;
            background: #374151;
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }
        .usage-progress-bar {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }
        .usage-progress-bar.low { background: #22c55e; }
        .usage-progress-bar.medium { background: #f59e0b; }
        .usage-progress-bar.high { background: #ef4444; }

        /* Tools Dropdown (Admin Only) */
        .tools-nav-dropdown {
            position: relative;
            display: inline-block;
        }
        .tools-dropdown-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            color: #a5b4fc;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tools-dropdown-toggle:hover {
            background: rgba(99, 102, 241, 0.25);
            color: #c7d2fe;
        }
        .tools-dropdown-menu {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            min-width: 200px;
            background: #1e293b;
            border: 1px solid #374151;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            overflow: hidden;
        }
        .tools-dropdown-menu.show {
            display: block;
        }
        .tools-dropdown-menu a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            color: #e2e8f0;
            text-decoration: none;
            font-size: 14px;
            transition: background 0.15s;
        }
        .tools-dropdown-menu a:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .tools-dropdown-menu .tool-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }
        .tools-dropdown-menu .tool-icon.sonarr { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .tools-dropdown-menu .tool-icon.radarr { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .tools-dropdown-menu .tool-icon.qbittorrent { background: linear-gradient(135deg, #a855f7, #9333ea); }
        .tools-dropdown-menu .tool-icon.sabnzbd { background: linear-gradient(135deg, #f97316, #ea580c); }
        .tools-dropdown-menu .dropdown-footer {
            border-top: 1px solid #374151;
            margin-top: 8px;
            padding-top: 8px;
        }
        .tools-dropdown-menu .dropdown-footer a {
            color: #94a3b8;
            font-size: 13px;
        }

        /* Header Search Bar */
        .request-nav-search {
            position: relative;
            flex: 0 0 400px;
            margin: 0;
        }
        .request-search-input {
            width: 100%;
            padding: 10px 40px 10px 16px;
            background: rgba(30, 41, 59, 0.6);
            border: none;
            border-radius: 8px;
            color: #f8fafc;
            font-size: 14px;
            transition: all 0.3s;
        }
        .request-search-input:focus {
            outline: none;
            background: rgba(30, 41, 59, 0.9);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.4);
        }
        .request-search-input::placeholder {
            color: #64748b;
        }
        .request-search-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 16px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .request-search-btn:hover {
            color: #f8fafc;
        }

        /* Container */
        .request-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 30px 40px;
        }

        /* Section Headers */
        .request-section-header {
            margin: 40px 0 20px;
        }
        .request-section-title {
            font-size: 20px;
            font-weight: 700;
            color: #f8fafc;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .request-section-title i {
            color: #6366f1;
        }

        /* Slider Wrapper with Arrows */
        .slider-wrapper {
            position: relative;
            padding: 0 50px;
        }
        .slider-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            border-radius: 50%;
            color: #f8fafc;
            font-size: 18px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s;
        }
        .slider-wrapper:hover .slider-arrow {
            opacity: 1;
        }
        .slider-arrow:hover {
            background: rgba(15, 23, 42, 0.95);
            border-color: #6366f1;
            transform: translateY(-50%) scale(1.1);
        }
        .slider-arrow.left {
            left: 5px;
        }
        .slider-arrow.right {
            right: 5px;
        }
        .slider-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Media Sliders */
        .media-slider {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 10px 0;
            scroll-behavior: smooth;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
            cursor: grab;
            user-select: none;
        }
        .media-slider::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }
        .media-slider.dragging {
            cursor: grabbing;
            scroll-behavior: auto;
        }
        .media-slider.dragging > * {
            pointer-events: none;
        }

        /* Media Cards */
        .media-card {
            min-width: 160px;
            max-width: 160px;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }
        .media-card:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        .media-card-poster {
            width: 100%;
            height: 240px;
            object-fit: cover;
            border-radius: 8px;
            background: #1e293b;
        }
        .media-card-type {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: #fff;
            letter-spacing: 0.5px;
            z-index: 5;
        }
        .media-card-type.movie {
            background: #3b82f6;
        }
        .media-card-type.tv {
            background: #a855f7;
        }
        .media-card-status {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            border: 2px solid transparent;
            z-index: 5;
        }
        .media-card-status.available {
            background: rgba(34, 197, 94, 0.9);
            border-color: #22c55e;
            color: #fff;
        }
        .media-card-status.pending {
            background: rgba(234, 179, 8, 0.9);
            border-color: #eab308;
            color: #fff;
        }
        .media-card-status.processing {
            background: rgba(59, 130, 246, 0.9);
            border-color: #3b82f6;
            color: #fff;
            animation: pulse 2s ease-in-out infinite;
        }
        .media-card-status.partial {
            background: rgba(34, 197, 94, 0.9);
            border-color: #22c55e;
            color: #fff;
        }
        .media-card-status.partial i {
            font-size: 14px;
            font-weight: bold;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Detail page availability badge */
        .details-availability-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 9999px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .details-availability-badge.available {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22c55e;
            color: #22c55e;
        }
        .details-availability-badge.partial {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22c55e;
            color: #22c55e;
        }
        .details-availability-badge.requested {
            background: rgba(234, 179, 8, 0.2);
            border: 1px solid #eab308;
            color: #eab308;
        }
        .details-availability-badge.processing {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
            color: #3b82f6;
        }
        .details-availability-badge.fourk {
            margin-left: 8px;
        }
        .details-availability-badge.processing.fourk {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid #f59e0b;
            color: #f59e0b;
        }
        .media-card-title {
            margin-top: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #f8fafc;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .media-card-year {
            font-size: 12px;
            color: #94a3b8;
        }

        /* Loading placeholder for posters */
        .loading-placeholder {
            width: 100%;
            height: 240px;
            background: linear-gradient(110deg, #1e293b 8%, #334155 18%, #1e293b 33%);
            background-size: 200% 100%;
            animation: shimmer 1.5s linear infinite;
            border-radius: 8px;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Poster wrap for Recently Added */
        .media-card-poster-wrap {
            position: relative;
            width: 100%;
            aspect-ratio: 2/3;
            overflow: hidden;
            border-radius: 8px;
        }
        .media-card-poster-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        .media-card-poster-wrap .media-card-poster {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s ease;
        }

        /* Recent Requests Slider Cards - Seerr Style with Background */
        .recent-request-card {
            min-width: 340px;
            max-width: 340px;
            height: 180px;
            background: #1e293b;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: row;
            position: relative;
            cursor: pointer;
        }
        .recent-request-card:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        .recent-request-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            filter: brightness(0.3) blur(2px);
        }
        .recent-request-number {
            position: absolute;
            top: 50%;
            left: -15px;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #22c55e;
            color: #fff;
            font-size: 14px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .recent-request-poster-wrap {
            position: relative;
            flex-shrink: 0;
            z-index: 2;
            padding: 12px 0 12px 12px;
        }
        .recent-request-poster-img {
            width: 105px;
            height: 156px;
            object-fit: cover;
            background: #334155;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .recent-request-content,
        .recent-request-details {
            flex: 1;
            padding: 16px 16px 16px 12px;
            display: flex;
            flex-direction: column;
            min-width: 0;
            position: relative;
            z-index: 2;
        }
        .recent-request-year {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 4px;
            font-weight: 500;
        }
        .recent-request-title {
            font-size: 16px;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .recent-request-user {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #cbd5e1;
            margin-bottom: 6px;
        }
        .recent-request-user-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: #fff;
        }
        .recent-request-user-avatar.green { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .recent-request-user-avatar.purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .recent-request-user-avatar.blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .recent-request-user-avatar.orange { background: linear-gradient(135deg, #f97316, #ea580c); }
        .recent-request-seasons {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        .recent-request-seasons span {
            background: rgba(99, 102, 241, 0.3);
            color: #a5b4fc;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            margin-left: 4px;
        }
        .recent-request-bottom {
            margin-top: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .recent-request-status {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
        }
        .recent-request-status.pending,
        .recent-request-status.requested {
            background: rgba(234, 179, 8, 0.25);
            color: #fbbf24;
        }
        .recent-request-status.processing {
            background: rgba(99, 102, 241, 0.25);
            color: #a5b4fc;
        }
        .recent-request-status.approved,
        .recent-request-status.available {
            background: rgba(34, 197, 94, 0.25);
            color: #4ade80;
        }
        .recent-request-status.declined {
            background: rgba(239, 68, 68, 0.25);
            color: #f87171;
        }
        .recent-request-actions {
            display: flex;
            gap: 6px;
            margin-left: auto;
        }
        .recent-request-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .recent-request-btn.approve {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        .recent-request-btn.approve:hover {
            background: rgba(34, 197, 94, 0.4);
        }
        .recent-request-btn.decline {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        .recent-request-btn.decline:hover {
            background: rgba(239, 68, 68, 0.4);
        }
        .recent-request-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Genre Cards (Backdrop style) */
        .genre-card {
            min-width: 280px;
            max-width: 280px;
            height: 120px;
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            background-color: #1e293b;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: flex-end;
            padding: 15px;
        }
        .genre-card:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        .genre-card-name {
            font-size: 22px;
            font-weight: 700;
            color: #f8fafc;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.7);
            z-index: 2;
        }

        /* Studio/Network Cards (Logo style) */
        .logo-card {
            min-width: 180px;
            max-width: 180px;
            height: 140px;
            /* Lighter background with subtle gradient for better logo contrast */
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.95) 0%, rgba(241, 245, 249, 0.95) 100%);
            border: 1px solid rgba(226, 232, 240, 0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            padding: 20px;
            /* Subtle shadow for depth */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .logo-card:hover {
            transform: translateY(-4px);
            border-color: #6366f1;
            background: linear-gradient(135deg, rgba(255, 255, 255, 1) 0%, rgba(248, 250, 252, 1) 100%);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.25), 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .logo-card-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            /* Remove brightness dimming - keep logos at full brightness for better readability */
            filter: brightness(1.0);
            transition: filter 0.2s, transform 0.2s;
        }
        .logo-card:hover .logo-card-img {
            /* Slight brightness boost and scale on hover */
            filter: brightness(1.05);
            transform: scale(1.05);
        }

        /* Loading States */
        .request-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #64748b;
        }
        .request-loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #334155;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .request-loading-text {
            margin-top: 15px;
            font-size: 14px;
        }

        /* Empty State */
        .request-empty {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }
        .request-empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .request-empty-title {
            font-size: 18px;
            font-weight: 600;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        .request-empty-text {
            font-size: 14px;
        }

        /* Modal */
        .media-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow-y: auto;
        }
        .media-detail-modal.show {
            display: block;
        }
        .media-detail-content {
            max-width: 1200px;
            margin: 40px auto;
            position: relative;
        }
        .media-detail-backdrop {
            width: 100%;
            height: 500px;
            object-fit: cover;
            border-radius: 12px 12px 0 0;
        }
        .media-detail-backdrop-gradient {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 500px;
            background: linear-gradient(to top, #0f172a 0%, transparent 100%);
        }
        .media-detail-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: #f8fafc;
            font-size: 32px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
        }
        .media-detail-body {
            padding: 40px;
            background: #0f172a;
            border-radius: 0 0 12px 12px;
            margin-top: -100px;
            position: relative;
        }
        .media-detail-header {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }
        .media-detail-poster {
            width: 200px;
            height: 300px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        .media-detail-info {
            flex: 1;
        }
        .media-detail-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 15px;
        }
        .media-detail-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #94a3b8;
        }
        .media-detail-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .media-detail-rating {
            color: #fbbf24 !important;
        }
        .media-detail-genres {
            display: flex;
            flex-wrap: nowrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        .media-detail-genre {
            padding: 6px 12px;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid #6366f1;
            border-radius: 6px;
            font-size: 12px;
            color: #a5b4fc;
        }
        .media-detail-overview {
            font-size: 14px;
            line-height: 1.6;
            color: #cbd5e1;
        }

        /* Season Selection Modal */
        .season-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .season-modal.show {
            display: flex;
        }
        .season-modal-content {
            background: #1e293b;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .season-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #334155;
        }
        .season-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #f8fafc;
            margin: 0;
        }
        .season-modal-close {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }
        .season-modal-close:hover {
            color: #f8fafc;
        }
        .season-modal-body {
            padding: 24px;
        }
        .season-modal-subtitle {
            font-size: 15px;
            color: #94a3b8;
            margin: 0 0 20px 0;
        }
        .season-modal-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        .season-option-btn {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            background: rgba(30, 41, 59, 0.6);
            border: 2px solid #334155;
            border-radius: 8px;
            color: #f8fafc;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            width: 100%;
        }
        .season-option-btn:hover {
            background: rgba(30, 41, 59, 0.9);
            border-color: #6366f1;
        }
        .season-option-btn i {
            font-size: 24px;
            color: #6366f1;
        }
        .season-option-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .season-option-desc {
            font-size: 13px;
            color: #94a3b8;
        }
        .season-checkboxes {
            padding-top: 20px;
            border-top: 1px solid #334155;
        }
        .season-checkboxes-title {
            font-size: 16px;
            font-weight: 600;
            color: #f8fafc;
            margin: 0 0 16px 0;
        }
        .season-checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        .season-checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #334155;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .season-checkbox-item:hover {
            background: rgba(15, 23, 42, 0.9);
            border-color: #6366f1;
        }
        .season-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .season-checkbox-item label {
            flex: 1;
            cursor: pointer;
            font-size: 14px;
            color: #f8fafc;
        }
        .season-modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        /* Season Accordion Styles */
        .seasons-accordion {
            margin: 30px 0;
        }
        .season-item {
            margin-bottom: 8px;
        }
        .season-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid #334155;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .season-header:hover {
            background: rgba(30, 41, 59, 0.9);
            border-color: #6366f1;
        }
        .season-header.open {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: none;
        }
        .season-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        .season-title {
            font-size: 16px;
            font-weight: 600;
            color: #f8fafc;
        }
        .season-episode-count {
            padding: 4px 10px;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid #6366f1;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: #a5b4fc;
        }
        .season-availability {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .season-availability.available {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22c55e;
            color: #22c55e;
        }
        .season-availability.partial {
            background: rgba(234, 179, 8, 0.2);
            border: 1px solid #eab308;
            color: #eab308;
        }
        .season-availability i {
            font-size: 10px;
        }
        .season-chevron {
            color: #94a3b8;
            transition: transform 0.2s;
            font-size: 18px;
        }
        .season-chevron.open {
            transform: rotate(180deg);
        }
        .season-content {
            display: none;
            border: 1px solid #334155;
            border-top: none;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            padding: 16px;
            background: rgba(15, 23, 42, 0.6);
        }
        .season-content.show {
            display: block;
        }
        .season-loading {
            text-align: center;
            padding: 30px;
            color: #94a3b8;
        }
        .episode-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .episode-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: rgba(30, 41, 59, 0.3);
            border: 1px solid rgba(51, 65, 85, 0.5);
            border-radius: 8px;
            transition: all 0.2s;
        }
        .episode-item:hover {
            background: rgba(30, 41, 59, 0.5);
            border-color: #6366f1;
        }
        .episode-still {
            flex-shrink: 0;
            width: 200px;
            height: 113px;
            border-radius: 6px;
            overflow: hidden;
            background: rgba(15, 23, 42, 0.8);
        }
        .episode-still img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .episode-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .episode-header-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: nowrap;
        }
        /* Episode Availability Indicators */
        .episode-availability {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        .episode-availability.available {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        .episode-availability.not-available {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .episode-availability.unaired {
            background: rgba(148, 163, 184, 0.2);
            color: #94a3b8;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }
        .episode-availability i {
            font-size: 10px;
        }
        .episode-title {
            font-size: 15px;
            font-weight: 600;
            color: #f8fafc;
        }
        .episode-air-date {
            padding: 2px 8px;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid #6366f1;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #a5b4fc;
        }
        .episode-overview {
            font-size: 13px;
            line-height: 1.6;
            color: #cbd5e1;
        }
        @media (max-width: 768px) {
            .episode-item {
                flex-direction: column;
            }
            .episode-still {
                width: 100%;
                height: auto;
                aspect-ratio: 16/9;
            }
        }
        .media-detail-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        .request-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .request-btn-primary {
            background: #6366f1;
            color: #fff;
            border: 1px solid #6366f1;
        }
        .request-btn-primary:hover:not(:disabled) {
            background: #5558e3;
            border-color: #5558e3;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .request-btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .request-btn-secondary {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(148, 163, 184, 0.3);
            color: #f8fafc;
        }
        .request-btn-secondary:hover {
            background: rgba(30, 41, 59, 0.7);
            border-color: rgba(148, 163, 184, 0.5);
        }
        .request-btn-4k {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #fff;
            border: 1px solid #f59e0b;
        }
        .request-btn-4k:hover:not(:disabled) {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            border-color: #d97706;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        .request-btn-4k:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Sidebar Request Button */
        .sidebar-request-container {
            width: 100%;
        }
        .sidebar-request-btn {
            width: 100%;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: #6366f1;
            color: #fff;
        }
        .sidebar-request-btn:hover:not(:disabled) {
            background: #5558e3;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .sidebar-request-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .sidebar-request-btn.btn-4k {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .sidebar-request-btn.btn-4k:hover:not(:disabled) {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        .sidebar-request-btn.btn-success {
            background: #22c55e;
        }
        .sidebar-request-btn.btn-processing {
            background: #3b82f6;
        }
        .sidebar-request-btn.btn-declined {
            background: #ef4444;
        }
        .sidebar-request-btn.btn-requested {
            background: #475569;
            cursor: not-allowed;
            opacity: 0.8;
        }
        .sidebar-request-btn.btn-requested-4k {
            background: linear-gradient(135deg, #92400e 0%, #78350f 100%);
            cursor: not-allowed;
            opacity: 0.8;
        }

        /* Full Cast/Crew Page */
        .full-crew-page {
            display: none;
            position: relative;
            padding: 40px 0;
        }
        .full-crew-page.show {
            display: block;
        }
        .full-crew-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 32px;
        }
        .full-crew-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 32px;
        }
        .full-crew-back-btn {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            color: #f8fafc;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .full-crew-back-btn:hover {
            background: rgba(30, 41, 59, 1);
            border-color: #475569;
        }
        .full-crew-title {
            font-size: 28px;
            font-weight: 700;
            color: #f8fafc;
            margin: 0;
        }
        .full-crew-section {
            margin-bottom: 48px;
        }
        .full-crew-section-title {
            font-size: 22px;
            font-weight: 700;
            color: #f8fafc;
            margin: 0 0 24px 0;
            padding-bottom: 12px;
            border-bottom: 2px solid #6366f1;
        }
        .person-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
        }
        .person-card {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(51, 65, 85, 0.6);
            transition: all 0.2s;
            cursor: pointer;
        }
        .person-card:hover {
            transform: scale(1.05);
            border-color: #6366f1;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .person-card-photo {
            position: relative;
            width: 100%;
            padding-bottom: 150%; /* 2:3 aspect ratio */
            background: rgba(15, 23, 42, 0.8);
            overflow: hidden;
        }
        .person-card-photo img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .person-card-photo-fallback {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #475569;
            font-size: 64px;
        }
        .person-card-info {
            padding: 12px;
            background: linear-gradient(to top, rgba(15, 23, 42, 0.95) 0%, rgba(15, 23, 42, 0.8) 100%);
        }
        .person-card-name {
            font-size: 14px;
            font-weight: 600;
            color: #f8fafc;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        .person-card-role {
            font-size: 13px;
            color: #94a3b8;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* No Poster Placeholder */
        .no-poster {
            width: 100%;
            height: 240px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1e293b;
            color: #64748b;
            font-size: 48px;
            border-radius: 8px;
        }

        /* Browse Section */
        .browse-back-btn {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            color: #f8fafc;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        .browse-back-btn:hover {
            background: rgba(30, 41, 59, 1);
            border-color: #475569;
            transform: translateX(-2px);
        }
        .browse-back-btn i {
            font-size: 12px;
        }
        .browse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 24px;
            margin-top: 30px;
        }
        @media (max-width: 1400px) {
            .browse-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }
        @media (max-width: 768px) {
            .browse-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
        }
        @media (max-width: 480px) {
            .browse-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
        }
        .browse-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
            padding: 0;
            gap: 12px;
            flex-wrap: nowrap;
        }
        @media (max-width: 768px) {
            .browse-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
        .browse-sort {
            display: flex;
            align-items: stretch;
            flex: 1;
        }
        .browse-sort-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            border-right: none;
            border-radius: 8px 0 0 8px;
            padding: 0 12px;
            color: #f8fafc;
        }
        .browse-sort-select {
            flex: 1;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            color: #f8fafc;
            padding: 10px 12px;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
            cursor: pointer;
            min-width: 200px;
        }
        .browse-sort-select:focus {
            outline: none;
            border-color: #6366f1;
        }
        .browse-filter-btn {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            color: #f8fafc;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .browse-filter-btn:hover {
            background: rgba(30, 41, 59, 1);
            border-color: #6366f1;
        }
        @media (max-width: 768px) {
            .browse-sort {
                width: 100%;
            }
            .browse-filter-btn {
                width: 100%;
                justify-content: center;
            }
        }
/* Movie Details Page (Seerr Compact Layout) */
        .movie-details-page { display: none; position: relative; margin-top: -60px; }
        .movie-details-page.show { display: block; }
        .movie-details-backdrop { position: absolute; top: 0; left: 0; right: 0; height: 450px; overflow: hidden; z-index: 0; }
        .movie-details-backdrop-img { width: 100%; height: 100%; object-fit: cover; }
        .movie-details-backdrop-gradient { position: absolute; inset: 0; background: linear-gradient(180deg, rgba(15, 23, 42, 0.3) 0%, rgba(15, 23, 42, 0.6) 50%, rgba(15, 23, 42, 1) 100%); }
        .movie-details-header { position: relative; max-width: 1600px; margin: 0 auto; padding: 100px 40px 0; display: flex; gap: 30px; align-items: flex-end; z-index: 5; }
        .movie-details-poster-wrapper { flex-shrink: 0; width: 220px; height: 330px; border-radius: 8px; overflow: hidden; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5); }
        .movie-details-poster-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .movie-details-title-section { flex: 1; padding-bottom: 10px; }
        .movie-details-title { font-size: 28px; font-weight: 700; color: #f8fafc; margin-bottom: 8px; }
        .movie-details-year { color: #94a3b8; font-weight: 400; }
        .movie-details-attributes { display: flex; align-items: center; gap: 12px; color: #cbd5e1; font-size: 13px; margin-bottom: 15px; flex-wrap: nowrap; }
        .movie-details-actions { display: flex; gap: 12px; margin-top: 15px; flex-wrap: wrap; }
        .movie-details-actions .request-btn { min-width: 140px; max-width: 200px; justify-content: center; flex-shrink: 0; }
        /* Main content area with sidebar */
        .movie-details-content { max-width: 1600px; margin: 30px auto; padding: 0 40px; display: grid; grid-template-columns: 1fr 350px; gap: 30px; }
        .movie-details-main { min-width: 0; }
        .movie-details-sidebar { display: flex; flex-direction: column; gap: 20px; }

        /* Full-width sections below sidebar */
        .movie-details-full-width { max-width: 1600px; margin: 0 auto; padding: 0 40px; }
        .movie-details-section-title { font-size: 18px; font-weight: 700; color: #f8fafc; margin-bottom: 12px; }
        .movie-details-overview-text { font-size: 17px; line-height: 1.8; color: #cbd5e1; margin-bottom: 35px; }
        .movie-details-seasons { background: rgba(30, 41, 59, 0.4); border: 1px solid #334155; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .movie-details-seasons-title { font-size: 16px; font-weight: 700; color: #f8fafc; margin-bottom: 12px; }
        @media (max-width: 1200px) {
            .movie-details-content { grid-template-columns: 1fr; }
            .movie-details-sidebar { grid-row: 1; }
        }
        @media (max-width: 1024px) {
            .movie-details-backdrop { height: 400px; }
            .movie-details-header { padding: 90px 20px 0; }
            .movie-details-poster-wrapper { width: 180px; height: 270px; }
            .movie-details-title { font-size: 24px; }
            .movie-details-content { padding: 0 20px; }
        }
        @media (max-width: 768px) {
            .movie-details-backdrop { height: 350px; }
            .movie-details-header { flex-direction: column; align-items: center; padding: 100px 20px 0; text-align: center; }
            .movie-details-poster-wrapper { width: 160px; height: 240px; }
            .movie-details-title { font-size: 20px; }
            .movie-details-actions { flex-direction: row; justify-content: center; flex-wrap: wrap; }
        }

        /* Movie Details Tagline */
        .movie-details-tagline {
            font-size: 16px;
            font-style: italic;
            color: #94a3b8;
            margin-bottom: 20px;
            display: none;
        }

        /* Cast Section */
        .movie-details-cast {
            margin: 40px 0;
        }
        .cast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .cast-card {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid #334155;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s;
            cursor: pointer;
        }
        .cast-card:hover {
            transform: translateY(-4px);
            border-color: #6366f1;
        }
        .cast-card-image {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
            background: #1e293b;
        }
        .cast-card-info {
            padding: 12px;
        }
        .cast-card-name {
            font-size: 15px;
            font-weight: 600;
            color: #f8fafc;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .cast-card-character {
            font-size: 14px;
            color: #94a3b8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Crew Section */
        .movie-details-crew {
            margin: 40px 0;
        }
        .crew-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .crew-item {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
        }
        .crew-item-name {
            font-size: 15px;
            font-weight: 600;
            color: #f8fafc;
            margin-bottom: 4px;
        }
        .crew-item-job {
            font-size: 14px;
            color: #94a3b8;
        }

        /* Inline Crew Section (Grid display like Seerr) */
        .movie-details-crew-inline {
            margin: 24px 0;
            position: relative;
        }
        .crew-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 12px;
        }
        @media (min-width: 640px) {
            .crew-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        .crew-grid-item {
            display: flex;
            flex-direction: column;
            font-size: 15px;
            line-height: 1.5;
        }
        .crew-grid-label {
            font-weight: 700;
            color: #d1d5db;
            display: block;
            margin-bottom: 2px;
        }
        .crew-grid-value {
            font-weight: 400;
            color: #9ca3af;
            display: block;
            transition: color 0.3s;
        }
        .crew-grid-value:hover {
            color: #f3f4f6;
            text-decoration: underline;
        }
        .view-full-crew-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #818cf8;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            margin-top: 8px;
            float: right;
        }
        .view-full-crew-link:hover {
            color: #a5b4fc;
        }
        .crew-inline-value a {
            color: #3b82f6;
            text-decoration: none;
            transition: color 0.2s;
        }
        .crew-inline-value a:hover {
            color: #60a5fa;
        }

        /* Sidebar Metadata Card */
        .sidebar-card {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
        }
        .sidebar-card-title {
            font-size: 16px;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 15px;
        }
        .metadata-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
        }
        .metadata-row:last-child {
            border-bottom: none;
        }
        .metadata-label {
            font-size: 15px;
            color: #94a3b8;
            font-weight: 500;
        }
        .metadata-value {
            font-size: 15px;
            color: #f8fafc;
            font-weight: 600;
            text-align: right;
            max-width: 200px;
        }
        .metadata-value-green {
            color: #22c55e;
        }
        .metadata-value-yellow {
            color: #fbbf24;
        }
        /* Collection Card (Sidebar) */
        .movie-details-collection {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid #334155;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }
        .movie-details-collection:hover {
            border-color: #6366f1;
            transform: translateY(-2px);
        }
        .collection-backdrop {
            position: relative;
            height: 140px;
            overflow: hidden;
        }
        .collection-backdrop-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .collection-backdrop-gradient {
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.3) 0%, rgba(15, 23, 42, 0.9) 100%);
        }
        .collection-info {
            position: absolute;
            left: 0;
            bottom: 0;
            width: 100%;
            padding: 15px;
            z-index: 2;
        }
        .collection-title {
            font-size: 16px;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 4px;
        }
        .collection-subtitle {
            font-size: 12px;
            color: #cbd5e1;
        }

        /* Collection Button (Above Sidebar) - Matches Seerr exactly */
        .collection-button-wrapper {
            margin-bottom: 20px;
        }
        .collection-card {
            position: relative;
            z-index: 0;
            width: 100%;
            height: 80px;
            background: #1f2937;
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #374151;
            cursor: pointer;
            transform: scale(1);
            transition: all 0.3s;
        }
        .collection-card:hover {
            transform: scale(1.05);
            border-color: #4b5563;
        }
        .collection-card-backdrop {
            position: absolute;
            inset: 0;
            z-index: 0;
        }
        .collection-card-backdrop img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .collection-card-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(31, 41, 55, 0.47) 0%, rgba(31, 41, 55, 0.80) 100%);
        }
        .collection-card-content {
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 100%;
            padding: 16px;
            color: #d1d5db;
            transition: color 0.3s;
        }
        .collection-card:hover .collection-card-content {
            color: #ffffff;
        }
        .collection-card-name {
            font-size: 14px;
            font-weight: 600;
            line-height: 1.3;
        }
        .collection-card-view-btn {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 6px;
            color: #a5b4fc;
            font-size: 13px;
            font-weight: 600;
            padding: 6px 14px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .collection-card-view-btn:hover {
            background: rgba(99, 102, 241, 0.2);
            border-color: #6366f1;
            color: #c7d2fe;
        }

        /* Ratings Card */
        .ratings-card {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .ratings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        /* Compact Rating Badges (horizontal above status) */
        .ratings-badges-row {
            display: flex;
            flex-wrap: nowrap;
            gap: 8px;
            margin-bottom: 12px;
            justify-content: center;
        }
        .rating-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 6px;
            border: 1px solid rgba(51, 65, 85, 0.6);
        }
        .rating-badge-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            display: block;
        }
        .rating-badge-icon svg {
            width: 100%;
            height: 100%;
            display: block;
        }
        .rating-badge-value {
            font-size: 14px;
            font-weight: 700;
            line-height: 1;
            color: #f8fafc;
        }
        .rating-badge-percent {
            font-size: 14px;
            font-weight: 700;
        }

        /* External Links Icon Buttons (below Studios) */
        .external-links-card {
            padding: 16px 20px;
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(51, 65, 85, 0.6);
            border-radius: 8px;
        }
        .external-links-row {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: space-evenly;
        }
        .external-link {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;
            padding: 4px;
            background: transparent;
            border: none;
            text-decoration: none;
            transition: all 0.2s;
        }
        .external-link:hover {
            transform: scale(1.1);
        }
        .external-link img,
        .external-link svg {
            width: 38px;
            height: 38px;
            object-fit: contain;
            transition: all 0.2s;
        }
        .external-link:hover img,
        .external-link:hover svg {
            filter: brightness(1.2);
        }

        /* Keywords Section */
        .movie-details-keywords {
            margin: 35px 0 30px;
        }
        .keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .keyword-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 9999px;
            font-size: 14px;
            font-weight: 400;
            color: #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }
        .keyword-tag:hover {
            background: #374151;
        }
        .keyword-tag i {
            font-size: 12px;
        }

        /* Horizontal Sliders for Cast, Similar, Recommendations */
        .cast-slider-wrapper,
        .similar-slider-wrapper,
        .recommendations-slider-wrapper {
            position: relative;
            margin-top: 20px;
        }
        .cast-slider,
        .similar-slider,
        .recommendations-slider {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            scroll-behavior: smooth;
            scrollbar-width: none; /* Hide scrollbar for Firefox */
            padding-bottom: 10px;
        }
        /* Hide scrollbar for Chrome, Safari, and Opera */
        .cast-slider::-webkit-scrollbar,
        .similar-slider::-webkit-scrollbar,
        .recommendations-slider::-webkit-scrollbar {
            display: none;
        }

        /* Cast Card in Horizontal Slider */
        .cast-slider .cast-card {
            flex: 0 0 140px;
            width: 140px;
        }

        /* Media Card in Horizontal Sliders */
        .similar-slider .media-card,
        .recommendations-slider .media-card {
            flex: 0 0 160px;
            width: 160px;
        }

        /* Similar Titles Section */
        .movie-details-similar,
        .movie-details-recommendations {
            margin: 40px 0;
        }
        .similar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .cast-grid, .similar-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 16px;
            }
            .crew-grid {
                grid-template-columns: 1fr;
            }
            .collection-backdrop {
                height: 150px;
            }
            .collection-title {
                font-size: 18px;
            }
            /* Header navigation responsive */
            .request-nav {
                flex-wrap: nowrap;
                padding: 12px 15px;
                gap: 12px;
            }
            .request-nav-brand {
                font-size: 18px;
                flex: 0 0 100%;
            }
            .request-nav-links {
                flex: 1;
                gap: 15px;
                font-size: 13px;
            }
            .request-nav-search {
                flex: 0 0 100%;
                margin: 0;
                order: 3;
            }
            .request-nav-user {
                order: 2;
            }
        }
        @media (max-width: 1024px) {
            .request-nav-search {
                flex: 0 0 300px;
            }
        }

        /* ===== Filter Slide-over Panel ===== */
        .filter-slideover {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .filter-slideover.active {
            pointer-events: all;
            opacity: 1;
        }

        .filter-slideover-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            cursor: pointer;
        }

        .filter-slideover-panel {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            max-width: 450px;
            background: #1a1d29;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .filter-slideover.active .filter-slideover-panel {
            transform: translateX(0);
        }

        .filter-slideover-header {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .filter-slideover-header h2 {
            margin: 0 0 4px 0;
            font-size: 24px;
            font-weight: 700;
            color: #fff;
        }

        .filter-slideover-subtitle {
            margin: 0;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        .filter-close-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .filter-close-btn:hover {
            color: #fff;
        }

        .filter-slideover-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .filter-section {
            margin-bottom: 20px;
        }

        .filter-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin: 0 0 16px 0;
        }

        .filter-date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .filter-date-group {
            display: flex;
            flex-direction: column;
        }

        .filter-date-group label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }

        .date-picker-custom {
            position: relative;
        }

        .date-picker-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            z-index: 100;
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            min-width: 280px;
        }

        .date-picker-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .date-nav-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            padding: 4px 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-nav-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        .date-picker-selects {
            display: flex;
            gap: 8px;
            flex: 1;
        }

        .date-month-select,
        .date-year-select {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 6px;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
        }

        .date-picker-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .date-picker-day {
            padding: 8px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s;
        }

        .date-picker-day.header {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
            cursor: default;
            font-size: 11px;
            padding: 4px;
        }

        .date-picker-day.empty {
            cursor: default;
        }

        .date-picker-day:not(.header):not(.empty):hover {
            background: rgba(59, 130, 246, 0.2);
        }

        .date-picker-day.selected {
            background: #3b82f6;
            color: #fff;
        }

        .filter-input,
        .filter-select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 10px 12px;
            color: #fff;
            font-size: 14px;
            transition: all 0.2s;
        }

        .filter-input:focus,
        .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .filter-select option {
            background: #1a1a1a;
            color: rgba(255, 255, 255, 0.9);
        }

        .filter-checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .filter-checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            transition: color 0.2s;
        }

        .filter-checkbox-label:hover {
            color: #fff;
        }

        .filter-checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: #3b82f6;
        }

        .filter-slider-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin: 0 0 16px 0;
        }

        .filter-slider-label span {
            color: #3b82f6;
            font-weight: 600;
        }

        .filter-slider-container {
            position: relative;
            height: 40px;
        }

        .filter-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .filter-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            pointer-events: all;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }

        .filter-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            pointer-events: all;
            border: none;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }

        .filter-clear-btn {
            width: 100%;
            padding: 12px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            color: #ef4444;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .filter-clear-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .filter-clear-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .filter-search-results {
            margin-top: 12px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }

        .filter-search-result-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }

        .filter-search-result-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .filter-search-result-item:last-child {
            border-bottom: none;
        }

        /* Custom Dropdown Styles */
        .custom-select-wrapper {
            position: relative;
            width: 100%;
        }

        .custom-select {
            position: relative;
            width: 100%;
            user-select: none;
        }

        .custom-select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 42px;
        }

        .custom-select-trigger:hover {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        .custom-select.open .custom-select-trigger {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .custom-select-placeholder {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            flex: 1;
        }

        .custom-select-trigger i {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            transition: transform 0.2s;
        }

        .custom-select-trigger-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: #fff;
            font-size: 14px;
            padding: 0;
        }

        .custom-select-trigger-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .custom-select.open .custom-select-trigger i {
            transform: rotate(180deg);
        }

        .custom-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.98);
            border: 1px solid #3b82f6;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .custom-select.open .custom-select-dropdown {
            max-height: 300px;
            opacity: 1;
            visibility: visible;
        }

        .custom-select-options {
            max-height: 300px;
            overflow-y: auto;
            padding: 4px;
        }

        .custom-select-options::-webkit-scrollbar {
            width: 8px;
        }

        .custom-select-options::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .custom-select-options::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .custom-select-options::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .custom-select-option {
            padding: 10px 12px;
            cursor: pointer;
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .custom-select-option:hover {
            background: rgba(59, 130, 246, 0.15);
            color: #fff;
        }

        .custom-select-option.selected {
            background: rgba(59, 130, 246, 0.25);
            color: #fff;
            font-weight: 500;
        }

        .custom-select-option.selected::before {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: #3b82f6;
            font-size: 12px;
        }

        /* Selected Tags Display */
        .selected-tags {
            display: flex;
            flex-wrap: nowrap;
            gap: 8px;
            margin-top: 12px;
            min-height: 24px;
        }

        .selected-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
            border-radius: 6px;
            color: #93c5fd;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .selected-tag:hover {
            background: rgba(59, 130, 246, 0.3);
            border-color: rgba(59, 130, 246, 0.6);
        }

        .selected-tag i {
            font-size: 11px;
            opacity: 0.7;
        }

        .selected-tag:hover i {
            opacity: 1;
        }

        /* Search input within dropdown */
        .custom-select-search {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .custom-select-search input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .custom-select-search input:focus {
            border-color: #3b82f6;
            background: rgba(0, 0, 0, 0.4);
        }

        .custom-select-search input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        /* Streaming Providers Grid */
        .streaming-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .streaming-region-select {
            flex: 0 0 160px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 10px 12px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .streaming-region-select:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .streaming-region-select option {
            background: #1a1a1a;
            color: rgba(255, 255, 255, 0.9);
        }

        .streaming-search-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 12px;
            color: #fff;
            font-size: 14px;
            transition: all 0.2s;
        }

        .streaming-search-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .streaming-search-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .streaming-show-all-btn {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .streaming-show-all-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #fff;
        }

        .streaming-show-all-btn i {
            transition: transform 0.2s;
        }

        .streaming-show-all-btn.expanded i {
            transform: rotate(180deg);
        }

        .streaming-providers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .streaming-provider {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            background: rgba(255, 255, 255, 0.05);
        }

        .streaming-provider:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .streaming-provider.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        .streaming-provider img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .streaming-provider-checkmark {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .streaming-provider.selected .streaming-provider-checkmark {
            opacity: 1;
        }

        .streaming-provider-checkmark i {
            color: #fff;
            font-size: 11px;
        }

        @media (max-width: 640px) {
            .filter-slideover-panel {
                max-width: 100%;
            }
        }

        /* Admin Requests Tabs */
        .admin-requests-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid #334155;
            padding-bottom: 0;
        }
        .admin-requests-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s;
        }
        .admin-requests-tab:hover {
            color: #f8fafc;
        }
        .admin-requests-tab.active {
            color: #f8fafc;
            border-bottom-color: #6366f1;
        }
        .tab-badge {
            display: inline-block;
            margin-left: 6px;
            padding: 2px 8px;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Admin Request Card Badge */
        .admin-request-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .status-badge-pending {
            background: rgba(251, 191, 36, 0.9);
            color: #1a1a1a;
        }
        .status-badge-approved {
            background: rgba(34, 197, 94, 0.9);
            color: #1a1a1a;
        }
        .status-badge-available {
            background: rgba(59, 130, 246, 0.9);
            color: #fff;
        }
        .status-badge-declined {
            background: rgba(239, 68, 68, 0.9);
            color: #fff;
        }

        /* Request user info */
        .request-user {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
        }
        .request-user i {
            margin-right: 4px;
            color: #6366f1;
        }

        /* ============ Seerr-Style Admin Requests List ============ */
        .admin-requests-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .admin-requests-filters {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .admin-filter-select {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            color: #f8fafc;
            padding: 8px 32px 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%2394a3b8' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
        }
        .admin-filter-select:focus {
            outline: none;
            border-color: #6366f1;
        }

        /* Admin Request List */
        .admin-requests-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .admin-request-item {
            display: flex;
            align-items: center;
            background: linear-gradient(90deg, rgba(30, 41, 59, 0.95) 0%, rgba(30, 41, 59, 0.7) 100%);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #334155;
            transition: all 0.2s;
            position: relative;
        }
        .admin-request-item:hover {
            border-color: #6366f1;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        .admin-request-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.3;
            z-index: 0;
        }
        .admin-request-poster {
            width: 60px;
            height: 90px;
            object-fit: cover;
            flex-shrink: 0;
            z-index: 1;
            border-radius: 8px;
            margin: 12px;
        }
        .admin-request-poster-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e293b, #334155);
            color: #475569;
            font-size: 24px;
        }
        .admin-request-info {
            flex: 1;
            padding: 12px;
            z-index: 1;
            min-width: 0;
        }
        .admin-request-year {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 2px;
        }
        .admin-request-title {
            font-size: 16px;
            font-weight: 600;
            color: #f8fafc;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .admin-request-seasons {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }
        .admin-request-seasons-label {
            font-size: 12px;
            color: #94a3b8;
            margin-right: 4px;
        }
        .admin-request-season-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            background: #6366f1;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            color: #fff;
        }

        .admin-request-status {
            z-index: 1;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 180px;
        }
        .admin-request-status-label {
            font-size: 11px;
            color: #94a3b8;
        }
        .admin-request-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            width: fit-content;
        }
        .admin-request-status-badge.pending {
            background: #eab308;
            color: #1a1a1a;
        }
        .admin-request-status-badge.approved {
            background: #22c55e;
            color: #1a1a1a;
        }
        .admin-request-status-badge.available {
            background: #3b82f6;
            color: #fff;
        }
        .admin-request-status-badge.partially-available {
            background: #8b5cf6;
            color: #fff;
        }
        .admin-request-status-badge.declined {
            background: #ef4444;
            color: #fff;
        }
        .admin-request-4k-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #fff;
            margin-left: 8px;
        }
        .admin-request-requested {
            font-size: 12px;
            color: #94a3b8;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .admin-request-user-avatar {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #6366f1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            color: #fff;
        }

        .admin-request-actions {
            z-index: 1;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 140px;
        }
        .admin-request-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .admin-request-btn.approve {
            background: #22c55e;
            color: #fff;
        }
        .admin-request-btn.approve:hover {
            background: #16a34a;
        }
        .admin-request-btn.decline {
            background: #ef4444;
            color: #fff;
        }
        .admin-request-btn.decline:hover {
            background: #dc2626;
        }
        .admin-request-btn.edit {
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        .admin-request-btn.edit:hover {
            background: rgba(99, 102, 241, 0.3);
            border-color: #6366f1;
        }
        .admin-request-action-row {
            display: flex;
            gap: 8px;
        }
        .admin-request-action-row .admin-request-btn {
            flex: 1;
        }

        /* Edit Request Modal */
        .edit-request-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .edit-request-modal.show {
            display: flex;
        }
        .edit-request-content {
            background: #1e293b;
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .edit-request-header {
            padding: 20px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, transparent 100%);
            display: flex;
            gap: 16px;
            position: relative;
        }
        .edit-request-header-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.2;
        }
        .edit-request-header-poster {
            width: 60px;
            height: 90px;
            object-fit: cover;
            border-radius: 8px;
            z-index: 1;
        }
        .edit-request-header-info {
            flex: 1;
            z-index: 1;
        }
        .edit-request-status-title {
            font-size: 18px;
            font-weight: 700;
            color: #eab308;
            margin-bottom: 4px;
        }
        .edit-request-media-title {
            font-size: 16px;
            font-weight: 600;
            color: #f8fafc;
            margin-bottom: 8px;
        }
        .edit-request-user-info {
            font-size: 13px;
            color: #94a3b8;
        }

        .edit-request-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .edit-request-seasons-table {
            width: 100%;
            border-collapse: collapse;
        }
        .edit-request-seasons-table th {
            text-align: left;
            padding: 12px;
            font-size: 12px;
            font-weight: 600;
            color: #94a3b8;
            border-bottom: 1px solid #334155;
            text-transform: uppercase;
        }
        .edit-request-seasons-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
            font-size: 14px;
            color: #f8fafc;
        }
        .edit-request-toggle {
            width: 44px;
            height: 24px;
            background: #475569;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        .edit-request-toggle.active {
            background: #6366f1;
        }
        .edit-request-toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.2s;
        }
        .edit-request-toggle.active::after {
            left: 22px;
        }
        .edit-request-season-status {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        .edit-request-season-status.pending {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }
        .edit-request-season-status.available {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .edit-request-advanced {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #334155;
        }
        .edit-request-advanced-title {
            font-size: 14px;
            font-weight: 600;
            color: #f8fafc;
            margin-bottom: 16px;
        }
        .edit-request-advanced-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        .edit-request-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .edit-request-field label {
            font-size: 12px;
            color: #94a3b8;
        }
        .edit-request-field select {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            color: #f8fafc;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 13px;
        }
        .edit-request-field select:focus {
            outline: none;
            border-color: #6366f1;
        }

        .edit-request-requester {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #334155;
        }
        .edit-request-requester-title {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        .edit-request-requester-user {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
        }
        .edit-request-requester-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #6366f1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #fff;
        }
        .edit-request-requester-info {
            flex: 1;
        }
        .edit-request-requester-name {
            font-size: 14px;
            font-weight: 500;
            color: #f8fafc;
        }
        .edit-request-requester-email {
            font-size: 12px;
            color: #94a3b8;
        }

        .edit-request-footer {
            padding: 16px 20px;
            background: rgba(15, 23, 42, 0.5);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        .edit-request-footer-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .edit-request-footer-btn.close {
            background: rgba(71, 85, 105, 0.5);
            color: #94a3b8;
        }
        .edit-request-footer-btn.close:hover {
            background: rgba(71, 85, 105, 0.8);
            color: #f8fafc;
        }
        .edit-request-footer-btn.approve {
            background: #22c55e;
            color: #fff;
        }
        .edit-request-footer-btn.approve:hover {
            background: #16a34a;
        }

        @media (max-width: 768px) {
            /* Compact horizontal admin request cards on mobile */
            .admin-request-item {
                flex-direction: row;
                flex-wrap: wrap;
                align-items: flex-start;
                padding: 8px;
            }
            .admin-request-backdrop {
                display: none; /* Hide backdrop on mobile for cleaner look */
            }
            .admin-request-poster {
                width: 50px;
                height: 75px;
                margin: 0;
                border-radius: 6px;
                flex-shrink: 0;
            }
            .admin-request-info {
                flex: 1;
                padding: 0 8px;
                min-width: 0;
            }
            .admin-request-year {
                font-size: 10px;
            }
            .admin-request-title {
                font-size: 13px;
                margin-bottom: 4px;
            }
            .admin-request-seasons {
                margin-bottom: 4px;
            }
            .admin-request-season-badge {
                width: 18px;
                height: 18px;
                font-size: 9px;
            }
            .admin-request-4k-badge {
                font-size: 8px;
                padding: 1px 5px;
            }
            .admin-request-status {
                min-width: unset;
                padding: 0 8px 0 0;
                display: flex;
                flex-direction: column;
                gap: 2px;
                align-items: flex-end;
            }
            .admin-request-status-label {
                display: none; /* Hide "Status" label on mobile */
            }
            .admin-request-status-badge {
                font-size: 10px;
                padding: 3px 8px;
            }
            .admin-request-requested {
                font-size: 10px;
            }
            .admin-request-user-avatar {
                width: 14px;
                height: 14px;
                font-size: 7px;
            }
            .admin-request-actions {
                width: 100%;
                min-width: unset;
                padding: 8px 0 0 0;
                flex-direction: row;
                gap: 6px;
            }
            .admin-request-action-row {
                flex-direction: row;
                gap: 6px;
                width: 100%;
            }
            .admin-request-action-row .admin-request-btn {
                flex: 1;
            }
            .admin-request-btn {
                padding: 6px 10px;
                font-size: 11px;
            }
            .admin-request-btn.edit {
                flex: 1;
            }
            .admin-request-no-permission {
                font-size: 10px !important;
            }
            .edit-request-advanced-grid {
                grid-template-columns: 1fr;
            }
            /* Hide number input spin buttons on mobile */
            input[type="number"] {
                -moz-appearance: textfield;
            }
            input[type="number"]::-webkit-inner-spin-button,
            input[type="number"]::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            /* Compact admin filters on mobile */
            .admin-requests-header {
                flex-direction: column;
                gap: 8px;
            }
            .admin-requests-filters {
                flex-wrap: wrap;
                gap: 6px;
                width: 100%;
            }
            .admin-filter-select {
                flex: 1 1 auto;
                min-width: 100px;
                padding: 6px 24px 6px 8px;
                font-size: 12px;
                background-size: 12px;
                background-position: right 6px center;
            }
        }

        /* Empty state for requests */
        .request-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }
        .request-empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #475569;
        }
        .request-empty-state h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: #94a3b8;
        }

        /* Settings Section Styles */
        .settings-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid #334155;
            padding-bottom: 0;
        }
        .settings-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .settings-tab:hover {
            color: #f8fafc;
        }
        .settings-tab.active {
            color: #f8fafc;
            border-bottom-color: #6366f1;
        }
        .settings-card {
            background: #1e293b;
            border-radius: 12px;
            border: 1px solid #334155;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .settings-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #334155;
            background: rgba(30, 41, 59, 0.5);
        }
        .settings-card-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #f8fafc;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }
        .settings-card-header h3 i {
            color: #6366f1;
        }
        .settings-form {
            padding: 20px;
        }
        .settings-row {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
        }
        .settings-row:last-child {
            margin-bottom: 0;
        }
        .settings-field {
            flex: 1;
        }
        .settings-field label {
            display: block;
            font-size: 14px;
            color: #f8fafc;
            margin-bottom: 8px;
        }
        .settings-field small {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
            display: block;
        }
        .settings-input {
            width: 100%;
            padding: 10px 14px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #334155;
            border-radius: 8px;
            color: #f8fafc;
            font-size: 14px;
        }
        .settings-input:focus {
            outline: none;
            border-color: #6366f1;
        }
        .settings-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 14px;
            color: #f8fafc;
        }
        .settings-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #6366f1;
        }
        .settings-actions {
            margin-top: 24px;
        }
        .settings-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .settings-btn-primary {
            background: #6366f1;
            color: #fff;
        }
        .settings-btn-primary:hover {
            background: #5558e3;
        }
        .settings-btn-secondary {
            background: rgba(51, 65, 85, 0.6);
            color: #f8fafc;
        }
        .settings-btn-secondary:hover {
            background: rgba(51, 65, 85, 0.9);
        }
        .settings-btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        .settings-btn-danger:hover {
            background: rgba(239, 68, 68, 0.4);
        }
        .settings-btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        .settings-header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .settings-count {
            font-size: 12px;
            color: #64748b;
        }
        .settings-filter-select {
            padding: 6px 12px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #334155;
            border-radius: 6px;
            color: #f8fafc;
            font-size: 12px;
            cursor: pointer;
        }
        .settings-filter-select:focus {
            outline: none;
            border-color: #6366f1;
        }
        .settings-empty {
            color: #64748b;
            text-align: center;
            padding: 32px;
        }
        /* Media Managers Card Styles */
        .settings-section {
            padding: 20px;
        }
        .settings-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .settings-section-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #f8fafc;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .settings-section-header h3 i {
            color: #6366f1;
        }
        .settings-description {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .settings-card-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .settings-card-list .settings-card {
            display: flex;
            align-items: center;
            padding: 16px;
            gap: 16px;
            margin-bottom: 0;
        }
        .settings-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .settings-card-icon i {
            font-size: 20px;
            color: white;
        }
        .settings-card-info {
            flex: 1;
            min-width: 0;
        }
        .settings-card-title {
            font-size: 15px;
            font-weight: 600;
            color: #f8fafc;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .settings-card-subtitle {
            font-size: 13px;
            color: #64748b;
            margin-top: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .settings-badge {
            font-size: 11px;
            padding: 2px 8px;
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 500;
        }
        .settings-badge-disabled {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        .settings-card-status {
            font-size: 12px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 80px;
        }
        .settings-card-status i {
            font-size: 8px;
        }
        .settings-status-online {
            color: #22c55e;
        }
        .settings-status-online i {
            color: #22c55e;
        }
        .settings-status-offline {
            color: #ef4444;
        }
        .settings-status-offline i {
            color: #ef4444;
        }
        .settings-card-actions {
            display: flex;
            gap: 8px;
        }
        .settings-btn-sm {
            padding: 8px 12px;
            font-size: 13px;
        }
        .settings-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }
        .settings-empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        .settings-empty-state h3 {
            font-size: 18px;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        .settings-empty-state p {
            font-size: 14px;
        }
        .settings-error {
            text-align: center;
            padding: 40px;
            color: #ef4444;
        }
        .settings-error i {
            margin-right: 8px;
        }
        .users-permissions-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .user-permission-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 8px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .user-permission-row:hover {
            background: rgba(15, 23, 42, 0.6);
        }
        .user-permission-row.has-override {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            color: white;
        }
        .user-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .user-name {
            font-size: 14px;
            font-weight: 500;
            color: #f8fafc;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-email {
            font-size: 12px;
            color: #64748b;
        }
        .override-badge {
            font-size: 10px;
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }
        .override-badge i {
            font-size: 8px;
            margin-right: 3px;
        }
        .user-permissions-summary {
            display: flex;
            gap: 6px;
            margin-right: 16px;
        }
        .perm-badge {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .perm-badge.enabled {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        .perm-badge.disabled {
            background: rgba(100, 116, 139, 0.2);
            color: #64748b;
        }
        .user-actions {
            display: flex;
            gap: 8px;
        }
        .admin-badge {
            font-size: 10px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        /* Permission Limit Grid */
        .perm-limit-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .perm-limit-item {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 12px 16px;
        }
        .perm-limit-item:first-child {
            border-left: 3px solid #6366f1;
        }
        .perm-limit-item:nth-child(2) {
            border-left: 3px solid #8b5cf6;
        }
        .perm-limit-item:nth-child(3) {
            border-left: 3px solid #a855f7;
        }
        .perm-limit-icon {
            display: none;
        }
        .perm-limit-fields {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: nowrap;
        }
        .perm-limit-fields input {
            width: 60px;
            padding: 8px 10px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #475569;
            border-radius: 6px;
            color: #f1f5f9;
            font-size: 14px;
            text-align: center;
        }
        .perm-limit-fields input:focus {
            outline: none;
            border-color: #6366f1;
        }
        .perm-limit-fields span {
            color: #9ca3af;
            font-size: 13px;
            white-space: nowrap;
        }
        .perm-limit-hint {
            margin-top: 6px;
            font-size: 11px;
            color: #6b7280;
            font-style: italic;
        }
        /* User Permissions Modal */
        .request-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .request-modal-content {
            background: #1e293b;
            border-radius: 12px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            /* Dark themed scrollbar */
            scrollbar-width: thin;
            scrollbar-color: #4b5563 #1e293b;
        }
        .request-modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .request-modal-content::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 4px;
        }
        .request-modal-content::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        .request-modal-content::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .request-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #374151;
        }
        .request-modal-header h3 {
            margin: 0;
            color: #f1f5f9;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .request-modal-header h3 i {
            color: #6366f1;
        }
        .request-modal-close {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .request-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #f1f5f9;
        }
        .request-modal-body {
            padding: 20px;
        }
        .request-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid #374151;
        }
        .request-modal-header h2 {
            margin: 0;
            color: #f1f5f9;
            font-size: 18px;
        }
        /* Form styling for modals */
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #e2e8f0;
            margin-bottom: 6px;
        }
        .form-control {
            width: 100%;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 10px 12px;
            color: #f8fafc;
            font-size: 14px;
            transition: all 0.2s;
        }
        .form-control:focus {
            outline: none;
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }
        .form-control::placeholder {
            color: #64748b;
        }
        .form-select {
            width: 100%;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 10px 12px;
            color: #f8fafc;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        .form-select:focus {
            outline: none;
            border-color: #6366f1;
            background-color: rgba(99, 102, 241, 0.1);
        }
        .form-select option {
            background: #1e293b;
            color: #f8fafc;
        }
        /* Modal show/hide state */
        .request-modal:not(.show) {
            display: none;
        }
        /* Checkbox styling in forms */
        .form-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #6366f1;
            cursor: pointer;
        }
        .settings-description {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 16px;
            line-height: 1.5;
        }
        .settings-hint {
            font-size: 12px;
            color: #64748b;
            margin-top: 12px;
            display: block;
        }
        .settings-limit-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .settings-limit-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 8px;
        }
        .settings-limit-label {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 160px;
            font-size: 14px;
            color: #f8fafc;
        }
        .settings-limit-label i {
            color: #6366f1;
            width: 18px;
            text-align: center;
        }
        .settings-limit-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        .settings-limit-inputs span {
            font-size: 13px;
            color: #94a3b8;
        }
        .settings-input-small {
            width: 70px;
            padding: 8px 12px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #334155;
            border-radius: 6px;
            color: #f8fafc;
            font-size: 14px;
            text-align: center;
        }
        .settings-input-small:focus {
            outline: none;
            border-color: #6366f1;
        }
        .settings-select {
            padding: 10px 14px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #334155;
            border-radius: 8px;
            color: #f8fafc;
            font-size: 14px;
            min-width: 180px;
        }
        .settings-select:focus {
            outline: none;
            border-color: #6366f1;
        }

        /* Server Modal */
        .server-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .server-modal.show {
            display: flex;
        }
        .server-modal-content {
            background: #1e293b;
            border-radius: 12px;
            max-width: 700px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .server-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #334155;
            background: rgba(30, 41, 59, 0.5);
        }
        .server-modal-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #f8fafc;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .server-modal-close {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }
        .server-modal-close:hover {
            color: #f8fafc;
        }
        .server-modal-body {
            padding: 24px;
        }
        .server-form-row {
            margin-bottom: 16px;
        }
        .server-form-row label {
            display: block;
            font-size: 14px;
            color: #f8fafc;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .server-form-row small {
            font-size: 12px;
            color: #64748b;
            margin-top: 6px;
            display: block;
        }
        .server-form-row.server-form-checkbox {
            margin-bottom: 12px;
        }
        .server-form-row.server-checkboxes {
            display: flex;
            gap: 24px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #334155;
        }
        .server-form-row.server-checkboxes .settings-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .server-form-row.server-checkboxes .settings-checkbox input {
            width: 18px;
            height: 18px;
            accent-color: #6366f1;
        }
        .server-form-row.server-checkboxes .settings-checkbox span {
            font-size: 14px;
            color: #e2e8f0;
        }
        .server-form-divider {
            height: 1px;
            background: #334155;
            margin: 24px 0;
        }
        .server-form-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #94a3b8;
            margin: 0 0 16px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .server-modal-footer {
            display: flex;
            gap: 12px;
            padding: 16px 24px;
            background: rgba(15, 23, 42, 0.5);
            border-top: 1px solid #334155;
        }

        /* Server List - Seerr Style Grid */
        .servers-list {
            padding: 20px;
        }
        .servers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 20px;
        }
        .server-empty {
            text-align: center;
            padding: 30px;
            color: #64748b;
            grid-column: 1 / -1;
        }
        .server-empty svg {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            opacity: 0.5;
        }

        /* Seerr-style Server Card */
        .server-card {
            background: #1f2937;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            border: 1px solid #374151;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .server-card-content {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            gap: 16px;
        }
        .server-card-info {
            flex: 1;
            min-width: 0;
        }
        .server-card-name {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .server-card-name h4 {
            font-size: 15px;
            font-weight: 600;
            color: #f9fafb;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .server-card-name h4 a {
            color: #f9fafb;
            text-decoration: none;
            transition: color 0.2s;
        }
        .server-card-name h4 a:hover {
            color: #fff;
            text-decoration: underline;
        }
        .server-badge {
            padding: 3px 10px;
            background: #6366f1;
            color: #fff;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 600;
            text-transform: capitalize;
            white-space: nowrap;
        }
        .server-badge-4k {
            background: #f59e0b;
            color: #1a1a1a;
        }
        .server-badge-ssl {
            background: #10b981;
            color: #fff;
        }

        .server-card-details {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .server-card-detail {
            font-size: 13px;
            color: #d1d5db;
            display: flex;
            align-items: baseline;
            gap: 6px;
        }
        .server-card-detail strong {
            color: #9ca3af;
            font-weight: 600;
            min-width: 95px;
        }
        .server-card-detail a {
            color: #d1d5db;
            text-decoration: none;
            transition: color 0.2s;
        }
        .server-card-detail a:hover {
            color: #fff;
            text-decoration: underline;
        }

        .server-card-logo {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .server-card-logo:hover {
            opacity: 1;
        }
        .server-card-logo svg {
            width: 44px;
            height: 44px;
        }

        /* Server Card Actions */
        .server-card-actions {
            display: flex;
            border-top: 1px solid #374151;
        }
        .server-card-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px;
            background: transparent;
            border: none;
            color: #d1d5db;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .server-card-btn:first-child {
            border-right: 1px solid #374151;
        }
        .server-card-btn:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }
        .server-card-btn i {
            font-size: 14px;
        }

        /* Add Server Card */
        .server-add-card {
            min-height: 160px;
            border: 2px dashed #4b5563;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .server-add-card:hover {
            border-color: #6b7280;
            background: rgba(255, 255, 255, 0.02);
        }
        .server-add-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #9ca3af;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
        }
        .server-add-btn:hover {
            color: #f9fafb;
        }
        .server-add-btn i {
            font-size: 16px;
        }

        /* Services Section (Seerr-style headers) */
        .services-section {
            margin-bottom: 32px;
        }
        .services-section-header {
            margin-bottom: 20px;
        }
        .services-section-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: #f9fafb;
            margin: 0 0 8px 0;
        }
        .services-section-header p {
            font-size: 14px;
            color: #9ca3af;
            line-height: 1.5;
            margin: 0;
        }
        .plex-scan-status {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            margin-top: 16px;
        }
        .plex-scan-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 13px;
        }
        .plex-scan-stat i {
            color: #a5b4fc;
        }
        .plex-server-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        .plex-server-checkbox {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
        }
        .plex-server-checkbox span {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .plex-server-checkbox span i {
            color: #e5a00d;
        }
        .settings-card-header h3 svg {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            vertical-align: middle;
        }
        .settings-4k-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 16px;
        }
        @media (max-width: 768px) {
            .settings-4k-grid {
                grid-template-columns: 1fr;
            }
        }
        .settings-4k-option {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            padding: 16px;
        }
        .settings-4k-option .settings-checkbox span {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .settings-4k-option .settings-checkbox span i {
            color: #c4b5fd;
        }
        .settings-4k-limits {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            font-size: 13px;
            color: #94a3b8;
        }
        .server-status {
            font-size: 12px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .server-status.online {
            color: #22c55e;
        }
        .server-status.offline {
            color: #ef4444;
        }
        .server-actions {
            display: flex;
            gap: 8px;
        }

        /* Toast Notifications */
        .request-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 14px 20px;
            border-radius: 8px;
            background: #1e293b;
            color: #f8fafc;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
        }
        .request-toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .request-toast-success {
            border-left: 4px solid #22c55e;
        }
        .request-toast-success i {
            color: #22c55e;
        }
        .request-toast-error {
            border-left: 4px solid #ef4444;
        }
        .request-toast-error i {
            color: #ef4444;
        }
        .request-toast-info {
            border-left: 4px solid #3b82f6;
        }
        .request-toast-info i {
            color: #3b82f6;
        }

        /* ========================================
           COMPREHENSIVE MOBILE STYLES
           ======================================== */

        /* Mobile Menu Toggle Button */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: #f8fafc;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            margin-left: 8px;
            flex-shrink: 0;
        }

        /* Mobile Header Search (always visible on mobile) */
        .mobile-header-search {
            display: none;
            flex: 1;
            max-width: 400px;
            position: relative;
            margin-left: auto;
        }
        .mobile-header-search input {
            width: 100%;
            padding: 10px 40px 10px 14px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            border-radius: 8px;
            color: #f8fafc;
            font-size: 14px;
        }
        .mobile-header-search input::placeholder {
            color: #64748b;
        }
        .mobile-header-search input:focus {
            outline: none;
            border-color: #6366f1;
        }
        .mobile-header-search button {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #94a3b8;
            padding: 8px;
            cursor: pointer;
        }
        .mobile-header-search button:hover {
            color: #f8fafc;
        }

        /* Mobile Navigation Overlay */
        .mobile-nav-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }
        .mobile-nav-overlay.show {
            display: block;
        }

        /* Mobile Navigation Panel */
        .mobile-nav-panel {
            position: fixed;
            top: 0;
            right: -280px;
            width: 280px;
            height: 100%;
            background: #1a1d29;
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .mobile-nav-panel.show {
            right: 0;
        }
        .mobile-nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #334155;
        }
        .mobile-nav-close {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
        }
        .mobile-nav-links {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .mobile-nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            color: #cbd5e1;
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .mobile-nav-link:hover,
        .mobile-nav-link.active {
            background: rgba(99, 102, 241, 0.1);
            color: #f8fafc;
        }
        .mobile-nav-link i {
            width: 20px;
            text-align: center;
            color: #6366f1;
        }
        .mobile-nav-search {
            padding: 0 20px 20px;
        }
        .mobile-nav-search input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid #334155;
            border-radius: 8px;
            color: #f8fafc;
            font-size: 15px;
        }
        .mobile-nav-search input::placeholder {
            color: #64748b;
        }

        /* Tablet Breakpoint (1024px) */
        @media (max-width: 1024px) {
            .request-nav {
                padding: 12px 20px;
            }
            .request-nav-search {
                flex: 0 0 250px;
            }
            .request-nav-brand {
                flex: 0 0 auto;
            }
            .request-nav-user {
                flex: 0 0 auto;
            }
            .discover-section,
            .browse-section {
                padding: 20px;
            }
            .section-slider {
                gap: 15px;
            }
        }

        /* Mobile Breakpoint (768px) */
        @media (max-width: 768px) {
            /* Navigation */
            .mobile-menu-toggle {
                display: block;
            }
            .mobile-header-search {
                display: flex;
            }
            .request-nav {
                padding: 12px 16px;
                gap: 12px;
            }
            .request-nav-brand {
                font-size: 18px;
                flex: 0 0 auto;
            }
            .request-nav-brand span {
                display: none; /* Hide "Request Site" text on mobile */
            }
            .request-nav-links {
                display: none; /* Hide desktop nav links */
            }
            .request-nav-user {
                display: none; /* Hide on mobile - will be in mobile panel */
            }
            .request-nav-search {
                flex: 1;
                max-width: none;
                order: 1;
            }
            .request-nav-search input {
                padding: 10px 14px;
                font-size: 14px;
            }
            .request-nav-search .request-search-btn {
                padding: 10px 12px;
            }
            #back-link {
                display: none;
            }

            /* Discover Section - edge to edge */
            .discover-section,
            .browse-section {
                padding: 10px 4px;
            }
            .discover-hero {
                height: 280px;
                margin: -10px -4px 12px;
            }
            .discover-hero-content {
                padding: 12px;
            }
            .discover-hero-title {
                font-size: 20px;
            }
            .discover-hero-overview {
                font-size: 12px;
                -webkit-line-clamp: 2;
            }
            .section-header h2,
            .request-section-title {
                font-size: 14px;
                padding-left: 4px;
            }
            .request-section-header {
                margin-bottom: 8px;
                margin-top: 16px;
            }

            /* Media Cards Grid - 3 columns full width */
            .media-grid {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 4px;
            }
            .media-card {
                font-size: 9px;
                min-width: unset;
                max-width: unset;
            }
            .media-card-title {
                font-size: 9px;
            }
            .media-card-year {
                font-size: 8px;
            }
            .media-card-info {
                padding: 4px 5px;
            }

            /* Section Sliders - edge to edge */
            .section-slider {
                display: flex;
                overflow-x: auto;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
                gap: 4px;
                padding-bottom: 6px;
            }
            .section-slider::-webkit-scrollbar {
                height: 3px;
            }
            .section-slider::-webkit-scrollbar-track {
                background: #1e293b;
                border-radius: 2px;
            }
            .section-slider::-webkit-scrollbar-thumb {
                background: #475569;
                border-radius: 2px;
            }
            .section-slider .media-card {
                flex: 0 0 calc(25vw - 5px);
                scroll-snap-align: start;
            }

            /* Media Slider (discover page sliders) - 4 cards visible */
            .media-slider {
                gap: 4px;
                padding: 0;
            }
            .media-slider .media-card {
                min-width: calc(25vw - 5px);
                max-width: calc(25vw - 5px);
            }

            /* Slider wrapper - minimal arrows */
            .slider-wrapper {
                padding: 0 20px;
            }
            .slider-arrow {
                width: 20px;
                height: 20px;
                font-size: 9px;
            }

            /* Recent Requests - compact horizontal cards on mobile */
            .recent-request-card {
                min-width: 200px;
                max-width: 200px;
                height: auto;
                min-height: 80px;
                border-radius: 6px;
            }
            .recent-request-poster-wrap {
                padding: 6px 0 6px 6px;
            }
            .recent-request-poster-img {
                width: 55px;
                height: 82px;
            }
            .recent-request-content,
            .recent-request-details {
                padding: 8px 8px 8px 6px;
            }
            .recent-request-info {
                padding: 6px;
            }
            .recent-request-year {
                font-size: 9px;
                margin-bottom: 2px;
            }
            .recent-request-title {
                font-size: 11px;
                -webkit-line-clamp: 2;
                margin-bottom: 2px;
            }
            .recent-request-user {
                font-size: 9px;
                margin: 2px 0;
            }
            .recent-request-user-avatar {
                width: 12px;
                height: 12px;
                font-size: 6px;
            }
            .recent-request-status {
                font-size: 8px;
                padding: 2px 5px;
            }
            .recent-request-actions {
                margin-top: 3px;
            }
            .recent-request-actions button {
                width: 20px;
                height: 20px;
                font-size: 9px;
            }
            .recent-request-number {
                width: 22px;
                height: 22px;
                font-size: 10px;
                left: -10px;
            }

            /* Movie Details Page */
            .movie-details-backdrop {
                height: 280px;
            }
            .movie-details-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
                padding: 80px 16px 0;
                gap: 20px;
            }
            .movie-details-poster-wrapper {
                width: 140px;
                height: 210px;
            }
            .movie-details-title {
                font-size: 20px;
            }
            .movie-details-attributes {
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }
            .movie-details-status-badges {
                justify-content: center;
            }
            .movie-details-content {
                padding: 0 16px;
                grid-template-columns: 1fr;
                gap: 20px;
            }
            .movie-details-sidebar {
                order: -1; /* Move sidebar above content on mobile */
            }
            .movie-details-full-width {
                padding: 0 16px;
            }
            .movie-details-overview-text {
                font-size: 15px;
                line-height: 1.7;
            }
            .movie-details-actions {
                justify-content: center;
            }

            /* Cast & Similar Sections - Horizontal scroll */
            .cast-grid,
            .similar-grid {
                display: flex;
                overflow-x: auto;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
                gap: 8px;
                padding-bottom: 10px;
            }
            .cast-card {
                flex: 0 0 90px;
                scroll-snap-align: start;
            }
            .cast-card-info {
                padding: 6px;
            }
            .cast-card-name {
                font-size: 11px;
            }
            .cast-card-character {
                font-size: 10px;
            }
            .similar-grid .media-card {
                flex: 0 0 100px;
                scroll-snap-align: start;
            }

            /* Sidebar Cards */
            .sidebar-card {
                padding: 16px;
            }
            .sidebar-request-btn {
                padding: 12px 16px;
                font-size: 14px;
            }

            /* Metadata */
            .metadata-row {
                flex-direction: column;
                gap: 4px;
            }

            /* Collection Card */
            .collection-card {
                height: 80px;
            }
            .collection-card-name {
                font-size: 14px;
            }

            /* Seasons Section */
            .movie-details-seasons {
                padding: 16px;
            }
            .season-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            /* Episodes */
            .episode-item {
                flex-direction: column;
                gap: 12px;
            }
            .episode-still {
                width: 100%;
                height: auto;
                aspect-ratio: 16/9;
            }

            /* Keywords */
            .keyword-tag {
                font-size: 11px;
                padding: 4px 10px;
            }

            /* Request Button Area */
            .sidebar-request-container {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            /* Settings/Admin Modal */
            .settings-modal-content {
                width: 95%;
                max-height: 90vh;
                margin: 20px auto;
            }
            .settings-tabs {
                flex-wrap: wrap;
                gap: 8px;
            }
            .settings-tab {
                flex: 1 1 calc(50% - 4px);
                text-align: center;
                padding: 10px 8px;
                font-size: 13px;
            }

            /* Server Cards */
            .server-card {
                flex-direction: column;
                gap: 12px;
            }
            .server-info {
                width: 100%;
            }
            .server-actions {
                width: 100%;
                justify-content: flex-end;
            }

            /* Filter Slideover */
            .filter-slideover-panel {
                width: 100%;
                max-width: 100%;
            }

            /* Browse Filters */
            .browse-filters {
                flex-wrap: wrap;
                gap: 10px;
            }
            .browse-filter-btn {
                flex: 1 1 calc(50% - 5px);
                justify-content: center;
            }

            /* Search Results */
            .search-section {
                padding: 16px;
            }
            .search-header {
                font-size: 18px;
            }

            /* Toast notifications */
            .request-toast {
                left: 16px;
                right: 16px;
                bottom: 16px;
            }

            /* Rating Badges */
            .rating-badge {
                padding: 6px 10px;
                font-size: 12px;
            }
            #details-ratings-badges {
                flex-wrap: wrap;
                gap: 8px;
            }

            /* External Links */
            .external-link {
                padding: 6px 10px;
                font-size: 12px;
            }

            /* Manage Requests Table */
            .requests-table {
                display: block;
                overflow-x: auto;
            }
            .requests-table th,
            .requests-table td {
                padding: 10px 12px;
                font-size: 13px;
            }

            /* Users Tab */
            .users-filter-bar {
                flex-direction: column;
                gap: 10px;
            }
            .users-search-input {
                width: 100%;
            }

            /* Permission Edit Modal */
            .permission-edit-modal .settings-modal-content {
                width: 95%;
            }
        }

        /* Small Mobile Breakpoint (480px) */
        @media (max-width: 480px) {
            .request-nav {
                padding: 6px 4px;
            }
            .request-nav-brand {
                font-size: 14px;
            }
            .request-nav-search input {
                padding: 6px 8px;
                font-size: 12px;
            }
            .request-nav-search .request-search-btn {
                padding: 6px 8px;
            }

            /* Edge to edge sections */
            .discover-section,
            .browse-section {
                padding: 8px 2px;
            }

            /* 3 columns grid for small screens */
            .media-grid {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 3px;
            }

            .discover-hero {
                height: 200px;
                margin: -8px -2px 10px;
            }
            .discover-hero-title {
                font-size: 16px;
            }
            .discover-hero-content {
                padding: 10px;
            }

            .section-header h2,
            .request-section-title {
                font-size: 13px;
                padding-left: 2px;
            }
            .request-section-header {
                margin-bottom: 6px;
                margin-top: 12px;
            }

            .movie-details-backdrop {
                height: 180px;
            }
            .movie-details-header {
                padding: 40px 6px 0;
            }
            .movie-details-poster-wrapper {
                width: 90px;
                height: 135px;
            }
            .movie-details-title {
                font-size: 14px;
            }
            .movie-details-content {
                padding: 0 6px;
            }

            /* Slider cards - fit 4 tightly */
            .section-slider .media-card {
                flex: 0 0 calc(25vw - 3px);
            }

            .media-slider .media-card {
                min-width: calc(25vw - 3px);
                max-width: calc(25vw - 3px);
            }
            .media-slider {
                gap: 3px;
            }

            /* Slider wrapper - smaller arrows */
            .slider-wrapper {
                padding: 0 16px;
            }
            .slider-arrow {
                width: 16px;
                height: 16px;
                font-size: 8px;
            }

            /* Recent Requests - even more compact for small screens */
            .recent-request-card {
                min-width: 180px;
                max-width: 180px;
                min-height: 70px;
                border-radius: 5px;
            }
            .recent-request-poster-wrap {
                padding: 5px 0 5px 5px;
            }
            .recent-request-poster-img {
                width: 45px;
                height: 67px;
            }
            .recent-request-content,
            .recent-request-details {
                padding: 6px;
            }
            .recent-request-info {
                padding: 5px;
            }
            .recent-request-year {
                font-size: 8px;
            }
            .recent-request-title {
                font-size: 10px;
            }
            .recent-request-user {
                font-size: 8px;
            }
            .recent-request-user-avatar {
                width: 10px;
                height: 10px;
                font-size: 5px;
            }
            .recent-request-status {
                font-size: 7px;
                padding: 1px 4px;
            }
            .recent-request-actions button {
                width: 18px;
                height: 18px;
                font-size: 8px;
            }
            .recent-request-number {
                width: 18px;
                height: 18px;
                font-size: 9px;
                left: -8px;
            }

            .settings-tab {
                flex: 1 1 100%;
            }

            /* Buttons */
            .sidebar-request-btn {
                padding: 10px 14px;
                font-size: 13px;
            }

            /* Cast cards smaller */
            .cast-card {
                flex: 0 0 80px;
            }
            .cast-card-info {
                padding: 5px;
            }
            .cast-card-name {
                font-size: 10px;
            }
            .cast-card-character {
                font-size: 9px;
            }

            /* Recent Requests cards */
            .recent-request-card {
                min-width: 160px;
            }

            .similar-grid .media-card {
                flex: 0 0 90px;
            }
        }

        /* Landscape Phone */
        @media (max-width: 768px) and (orientation: landscape) {
            .movie-details-header {
                flex-direction: row;
                text-align: left;
                padding-top: 70px;
            }
            .movie-details-poster-wrapper {
                width: 120px;
                height: 180px;
            }
            .movie-details-actions {
                justify-content: flex-start;
            }
            .discover-hero {
                height: 200px;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .media-card:hover {
                transform: none;
            }
            .cast-card:hover {
                transform: none;
            }
            .request-nav-link,
            .mobile-nav-link,
            .browse-filter-btn,
            .settings-tab {
                min-height: 44px;
                display: flex;
                align-items: center;
            }
        }
    </style>
</head>
<body class="loading">
    <!-- Navigation -->
    <nav class="request-nav">
        <div class="request-nav-brand">
            <i class="fas fa-film"></i>
            <span>Request Site</span>
        </div>
        <div class="request-nav-links">
            <a class="request-nav-link active" data-section="discover">Discover</a>
            <a class="request-nav-link" data-section="movies">Movies</a>
            <a class="request-nav-link" data-section="tv">TV Shows</a>
            <a class="request-nav-link" data-section="requests">Requests <span class="request-nav-badge" id="pending-requests-badge" style="display: none;">0</span></a>
            <a class="request-nav-link" id="settings-link" data-section="settings" style="display: none;">Settings</a>
            <!-- Tools Dropdown (Admin Only) -->
            <div class="tools-nav-dropdown" id="tools-nav-dropdown" style="display: none;">
                <button class="tools-dropdown-toggle" onclick="toggleToolsDropdown(event)">
                    <i class="fas fa-tools"></i> Tools <i class="fas fa-caret-down" style="font-size: 10px;"></i>
                </button>
                <div class="tools-dropdown-menu" id="tools-dropdown-menu">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="request-nav-search">
                <input type="text" class="request-search-input" id="search-input"
                       placeholder="Search for movies or TV shows...">
                <button class="request-search-btn" onclick="performSearch()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="request-nav-user">
            <!-- Usage Indicator -->
            <div class="usage-indicator" id="usage-indicator" style="display: none;">
                <button class="usage-indicator-btn" onclick="toggleUsageDropdown(event)">
                    <i class="fas fa-chart-pie"></i>
                    <span class="usage-indicator-label">Request Limits</span>
                </button>
                <div class="usage-dropdown" id="usage-dropdown">
                    <div class="usage-dropdown-header">Request Limit Usage</div>
                    <div class="usage-dropdown-content" id="usage-dropdown-content">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            <a href="#" class="request-nav-link" id="back-link"><i class="fas fa-arrow-left"></i> Back</a>
        </div>
        <!-- Mobile Header Search (always visible on mobile) -->
        <div class="mobile-header-search">
            <input type="text" id="mobile-header-search-input" placeholder="Search...">
            <button onclick="performMobileHeaderSearch()"><i class="fas fa-search"></i></button>
        </div>
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" onclick="toggleMobileNav()" aria-label="Toggle menu">
            <i class="fas fa-bars"></i>
        </button>
    </nav>

    <!-- Mobile Navigation Panel -->
    <div class="mobile-nav-overlay" id="mobile-nav-overlay" onclick="closeMobileNav()"></div>
    <div class="mobile-nav-panel" id="mobile-nav-panel">
        <div class="mobile-nav-header">
            <div class="request-nav-brand">
                <i class="fas fa-film"></i>
                <span style="display: inline !important;">Request Site</span>
            </div>
            <button class="mobile-nav-close" onclick="closeMobileNav()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mobile-nav-search">
            <input type="text" id="mobile-search-input" placeholder="Search movies & TV..."
                   onkeypress="if(event.key==='Enter'){performMobileSearch()}">
        </div>
        <div class="mobile-nav-links">
            <a class="mobile-nav-link active" data-section="discover" onclick="mobileNavTo('discover')">
                <i class="fas fa-compass"></i> Discover
            </a>
            <a class="mobile-nav-link" data-section="movies" onclick="mobileNavTo('movies')">
                <i class="fas fa-film"></i> Movies
            </a>
            <a class="mobile-nav-link" data-section="tv" onclick="mobileNavTo('tv')">
                <i class="fas fa-tv"></i> TV Shows
            </a>
            <a class="mobile-nav-link" data-section="requests" onclick="mobileNavTo('requests')">
                <i class="fas fa-list"></i> Requests
                <span class="request-nav-badge" id="mobile-pending-badge" style="display: none;">0</span>
            </a>
            <a class="mobile-nav-link" id="mobile-settings-link" data-section="settings" onclick="mobileNavTo('settings')" style="display: none;">
                <i class="fas fa-cog"></i> Settings
            </a>
        </div>
        <!-- Mobile Usage Indicator -->
        <div id="mobile-usage-container" style="display: none; padding: 16px 20px; border-top: 1px solid #334155;">
            <div style="font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 10px;">
                <i class="fas fa-chart-pie"></i> Request Limit Usage
            </div>
            <div id="mobile-usage-content">
                <!-- Populated by JS -->
            </div>
        </div>
        <div style="padding: 20px; margin-top: auto; border-top: 1px solid #334155;">
            <a href="#" class="mobile-nav-link" onclick="closeMobileNav(); window.location.href='/portal/';">
                <i class="fas fa-arrow-left"></i> Back to Portal
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="request-container" style="opacity: 0; transition: opacity 0.2s;">
        <!-- Discover Section -->
        <section id="discover-section" style="display: none;">
            <!-- Recent Requests (Admin Only) -->
            <div id="recent-requests-container" style="display: none;">
                <div class="request-section-header">
                    <h2 class="request-section-title">
                        <i class="fas fa-clock"></i> Recent Requests
                    </h2>
                </div>
                <div class="slider-wrapper">
                    <button class="slider-arrow left" onclick="scrollSlider('recent-requests-slider', 'left')">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="media-slider" id="recent-requests-slider">
                        <!-- Will be populated dynamically -->
                    </div>
                    <button class="slider-arrow right" onclick="scrollSlider('recent-requests-slider', 'right')">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Recently Added to Plex -->
            <div id="recently-added-container" style="display: none;">
                <div class="request-section-header">
                    <h2 class="request-section-title">
                        <i class="fas fa-plus-circle"></i> Recently Added
                    </h2>
                </div>
                <div class="slider-wrapper">
                    <button class="slider-arrow left" onclick="scrollSlider('recently-added-slider', 'left')">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="media-slider" id="recently-added-slider"></div>
                    <button class="slider-arrow right" onclick="scrollSlider('recently-added-slider', 'right')">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Trending -->
            <div class="request-section-header">
                <h2 class="request-section-title">
                    <i class="fas fa-fire"></i> Trending
                </h2>
            </div>
            <div class="slider-wrapper">
                <button class="slider-arrow left" onclick="scrollSlider('trending-slider', 'left')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="media-slider" id="trending-slider">
                    <div class="request-loading">
                        <div class="request-loading-spinner"></div>
                        <div class="request-loading-text">Loading trending media...</div>
                    </div>
                </div>
                <button class="slider-arrow right" onclick="scrollSlider('trending-slider', 'right')">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Popular Movies -->
            <div class="request-section-header">
                <h2 class="request-section-title">
                    <i class="fas fa-star"></i> Popular Movies
                </h2>
            </div>
            <div class="slider-wrapper">
                <button class="slider-arrow left" onclick="scrollSlider('popular-movies-slider', 'left')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="media-slider" id="popular-movies-slider"></div>
                <button class="slider-arrow right" onclick="scrollSlider('popular-movies-slider', 'right')">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Movie Genres -->
            <div class="request-section-header">
                <h2 class="request-section-title">
                    <i class="fas fa-masks-theater"></i> Movie Genres
                </h2>
            </div>
            <div class="slider-wrapper">
                <button class="slider-arrow left" onclick="scrollSlider('movie-genres-slider', 'left')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="media-slider" id="movie-genres-slider"></div>
                <button class="slider-arrow right" onclick="scrollSlider('movie-genres-slider', 'right')">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Upcoming Movies -->
            <div class="request-section-header">
                <h2 class="request-section-title">
                    <i class="fas fa-calendar"></i> Upcoming Movies
                </h2>
            </div>
            <div class="slider-wrapper">
                <button class="slider-arrow left" onclick="scrollSlider('upcoming-movies-slider', 'left')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="media-slider" id="upcoming-movies-slider"></div>
                <button class="slider-arrow right" onclick="scrollSlider('upcoming-movies-slider', 'right')">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Studios -->
            <div class="request-section-header">
                <h2 class="request-section-title">
                    <i class="fas fa-building"></i> Studios
                </h2>
            </div>
            <div class="slider-wrapper">
                <button class="slider-arrow left" onclick="scrollSlider('studios-slider', 'left')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="media-slider" id="studios-slider"></div>
                <button class="slider-arrow right" onclick="scrollSlider('studios-slider', 'right')">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Popular Series -->
            <div class="request-section-header">
                <h2 class="request-section-title">
                    <i class="fas fa-tv"></i> Popular Series
                </h2>
            </div>
            <div class="slider-wrapper">
                <button class="slider-arrow left" onclick="scrollSlider('popular-series-slider', 'left')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="media-slider" id="popular-series-slider"></div>
                <button class="slider-arrow right" onclick="scrollSlider('popular-series-slider', 'right')">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Series Genres -->
            <div class="request-section-header">
                <h2 class="request-section-title">
                    <i class="fas fa-masks-theater"></i> Series Genres
                </h2>
            </div>
            <div class="slider-wrapper">
                <button class="slider-arrow left" onclick="scrollSlider('series-genres-slider', 'left')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="media-slider" id="series-genres-slider"></div>
                <button class="slider-arrow right" onclick="scrollSlider('series-genres-slider', 'right')">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Upcoming Series -->
            <div class="request-section-header">
                <h2 class="request-section-title">
                    <i class="fas fa-calendar-alt"></i> Upcoming Series
                </h2>
            </div>
            <div class="slider-wrapper">
                <button class="slider-arrow left" onclick="scrollSlider('upcoming-series-slider', 'left')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="media-slider" id="upcoming-series-slider"></div>
                <button class="slider-arrow right" onclick="scrollSlider('upcoming-series-slider', 'right')">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Networks -->
            <div class="request-section-header">
                <h2 class="request-section-title">
                    <i class="fas fa-broadcast-tower"></i> Networks
                </h2>
            </div>
            <div class="slider-wrapper">
                <button class="slider-arrow left" onclick="scrollSlider('networks-slider', 'left')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="media-slider" id="networks-slider"></div>
                <button class="slider-arrow right" onclick="scrollSlider('networks-slider', 'right')">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Other Sections (Movies, TV, Requests) will be hidden by default -->
        <section id="movies-section" style="display: none;">
            <div class="request-section-header">
                <h2 class="request-section-title">
                    <i class="fas fa-film"></i> Movies
                </h2>
            </div>
            <div id="movies-content"></div>
        </section>

        <section id="tv-section" style="display: none;">
            <div class="request-section-header">
                <h2 class="request-section-title">
                    <i class="fas fa-tv"></i> TV Shows
                </h2>
            </div>
            <div id="tv-content"></div>
        </section>

        <section id="requests-section" style="display: none;">
            <div class="request-section-header">
                <h2 class="request-section-title">
                    <i class="fas fa-inbox"></i> Requests
                </h2>
            </div>
            <div id="requests-content"></div>
        </section>

        <section id="settings-section" style="display: none;">
            <div class="request-section-header">
                <h2 class="request-section-title">
                    <i class="fas fa-cog"></i> Settings
                </h2>
            </div>
            <div id="settings-content"></div>
        </section>

        <!-- Browse Section (Genre/Studio/Network filtered view) -->
        <section id="browse-section" style="display: none;">
            <div class="request-section-header">
                <button class="browse-back-btn" onclick="goBackToDiscover()">
                    <i class="fas fa-arrow-left"></i> Back to Discover
                </button>
                <h2 class="request-section-title" id="browse-title">
                    <i class="fas fa-film" id="browse-icon"></i> Browse
                </h2>
            </div>
            <div class="browse-controls">
                <div class="browse-sort">
                    <span class="browse-sort-icon">
                        <i class="fas fa-arrow-down-short-wide"></i>
                    </span>
                    <select class="browse-sort-select" id="browse-sort" onchange="changeBrowseSort(this.value)">
                        <option value="popularity.desc">Popularity Descending</option>
                        <option value="popularity.asc">Popularity Ascending</option>
                        <option value="release_date.desc">Release Date Descending</option>
                        <option value="release_date.asc">Release Date Ascending</option>
                        <option value="vote_average.desc">TMDB Rating Descending</option>
                        <option value="vote_average.asc">TMDB Rating Ascending</option>
                        <option value="original_title.asc">Title (A-Z) Ascending</option>
                        <option value="original_title.desc">Title (Z-A) Descending</option>
                    </select>
                </div>
                <button class="browse-filter-btn" onclick="openFilterPanel()">
                    <i class="fas fa-filter"></i> <span id="filter-count">Filters</span>
                </button>
            </div>
            <div id="browse-grid" class="browse-grid">
                <!-- Content will be dynamically loaded here -->
            </div>
            <div id="browse-loading" class="request-loading" style="display: none;">
                <div class="request-loading-spinner"></div>
                <div class="request-loading-text">Loading more...</div>
            </div>
        </section>
    </div>

    <!-- Filter Slide-over Panel -->
    <div id="filter-slideover" class="filter-slideover">
        <div class="filter-slideover-overlay" onclick="closeFilterPanel()"></div>
        <div class="filter-slideover-panel">
            <div class="filter-slideover-header">
                <div>
                    <h2>Filters</h2>
                    <p class="filter-slideover-subtitle"><span id="active-filters-count">0</span> Active Filters</p>
                </div>
                <button class="filter-close-btn" onclick="closeFilterPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="filter-slideover-content">
                <!-- Release Date / First Air Date -->
                <div class="filter-section">
                    <h3 class="filter-section-title" id="date-filter-title">Release Date</h3>
                    <div class="filter-date-inputs">
                        <div class="filter-date-group">
                            <label>From</label>
                            <div class="date-picker-custom">
                                <input type="text" id="filter-date-from-display" class="filter-input" placeholder="YYYY-MM-DD" readonly>
                                <input type="hidden" id="filter-date-from">
                                <div class="date-picker-dropdown" id="filter-date-from-picker" style="display: none;">
                                    <div class="date-picker-header">
                                        <button type="button" class="date-nav-btn" data-action="prev-year">&laquo;</button>
                                        <button type="button" class="date-nav-btn" data-action="prev-month">&lsaquo;</button>
                                        <div class="date-picker-selects">
                                            <select class="date-month-select" id="filter-date-from-month"></select>
                                            <select class="date-year-select" id="filter-date-from-year"></select>
                                        </div>
                                        <button type="button" class="date-nav-btn" data-action="next-month">&rsaquo;</button>
                                        <button type="button" class="date-nav-btn" data-action="next-year">&raquo;</button>
                                    </div>
                                    <div class="date-picker-calendar" id="filter-date-from-calendar"></div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-date-group">
                            <label>To</label>
                            <div class="date-picker-custom">
                                <input type="text" id="filter-date-to-display" class="filter-input" placeholder="YYYY-MM-DD" readonly>
                                <input type="hidden" id="filter-date-to">
                                <div class="date-picker-dropdown" id="filter-date-to-picker" style="display: none;">
                                    <div class="date-picker-header">
                                        <button type="button" class="date-nav-btn" data-action="prev-year">&laquo;</button>
                                        <button type="button" class="date-nav-btn" data-action="prev-month">&lsaquo;</button>
                                        <div class="date-picker-selects">
                                            <select class="date-month-select" id="filter-date-to-month"></select>
                                            <select class="date-year-select" id="filter-date-to-year"></select>
                                        </div>
                                        <button type="button" class="date-nav-btn" data-action="next-month">&rsaquo;</button>
                                        <button type="button" class="date-nav-btn" data-action="next-year">&raquo;</button>
                                    </div>
                                    <div class="date-picker-calendar" id="filter-date-to-calendar"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Studio (Movies only) -->
                <div class="filter-section" id="filter-studio-section" style="display: none;">
                    <h3 class="filter-section-title">Studio</h3>
                    <div class="custom-select-wrapper">
                        <div class="custom-select custom-select-searchable" id="filter-studio-select">
                            <div class="custom-select-trigger">
                                <input type="text" id="filter-studio-search" class="custom-select-trigger-input" placeholder="Search studios..." autocomplete="off">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="custom-select-dropdown">
                                <div class="custom-select-options" id="filter-studio-options">
                                    <div class="custom-select-no-results" style="padding: 12px; text-align: center; color: rgba(255,255,255,0.5);">Type to search studios...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="selected-tags" id="filter-studio-selected"></div>
                </div>

                <!-- Genres -->
                <div class="filter-section">
                    <h3 class="filter-section-title">Genres</h3>
                    <div class="custom-select-wrapper">
                        <div class="custom-select custom-select-multi" id="filter-genres-select">
                            <div class="custom-select-trigger">
                                <span class="custom-select-placeholder">Select genres...</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="custom-select-dropdown">
                                <div class="custom-select-options" id="filter-genres-options">
                                    <!-- Will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="selected-tags" id="filter-genres-selected"></div>
                </div>

                <!-- Keywords -->
                <div class="filter-section">
                    <h3 class="filter-section-title">Keywords</h3>
                    <div class="custom-select-wrapper">
                        <div class="custom-select custom-select-multi custom-select-searchable" id="filter-keywords-select">
                            <div class="custom-select-trigger">
                                <input type="text" id="filter-keywords-search" class="custom-select-trigger-input" placeholder="Search keywords..." autocomplete="off">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="custom-select-dropdown">
                                <div class="custom-select-options" id="filter-keywords-options">
                                    <div class="custom-select-no-results" style="padding: 12px; text-align: center; color: rgba(255,255,255,0.5);">
                                        Start typing to search keywords...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="selected-tags" id="filter-keywords-selected"></div>
                </div>

                <!-- Studio (Movies only) -->
                <div class="filter-section" id="filter-studio-section" style="display: none;">
                    <h3 class="filter-section-title">Studio</h3>
                    <div class="custom-select-wrapper">
                        <div class="custom-select custom-select-multi custom-select-searchable" id="filter-studio-select">
                            <div class="custom-select-trigger">
                                <input type="text" id="filter-studio-search" class="custom-select-trigger-input" placeholder="Search studios..." autocomplete="off">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="custom-select-dropdown">
                                <div class="custom-select-options" id="filter-studio-options">
                                    <div class="custom-select-no-results" style="padding: 12px; text-align: center; color: rgba(255,255,255,0.5);">
                                        Start typing to search studios...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="selected-tags" id="filter-studio-selected"></div>
                </div>

                <!-- Status (TV only) -->
                <div class="filter-section" id="filter-status-section" style="display: none;">
                    <h3 class="filter-section-title">Status</h3>
                    <div class="custom-select-wrapper">
                        <div class="custom-select custom-select-multi" id="filter-status-select">
                            <div class="custom-select-trigger">
                                <span class="custom-select-placeholder">Select status...</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="custom-select-dropdown">
                                <div class="custom-select-options" id="filter-status-options">
                                    <div class="custom-select-option" data-value="Returning Series">Returning Series</div>
                                    <div class="custom-select-option" data-value="Planned">Planned</div>
                                    <div class="custom-select-option" data-value="In Production">In Production</div>
                                    <div class="custom-select-option" data-value="Ended">Ended</div>
                                    <div class="custom-select-option" data-value="Canceled">Canceled</div>
                                    <div class="custom-select-option" data-value="Pilot">Pilot</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="selected-tags" id="filter-status-selected"></div>
                </div>

                <!-- Content Rating (Certification) -->
                <div class="filter-section">
                    <h3 class="filter-section-title">Content Rating</h3>
                    <div class="custom-select-wrapper">
                        <div class="custom-select custom-select-multi" id="filter-certification-select">
                            <div class="custom-select-trigger">
                                <span class="custom-select-placeholder">Select ratings...</span>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="custom-select-dropdown">
                                <div class="custom-select-options" id="filter-certification-options">
                                    <div class="custom-select-option" data-value="G">G</div>
                                    <div class="custom-select-option" data-value="PG">PG</div>
                                    <div class="custom-select-option" data-value="PG-13">PG-13</div>
                                    <div class="custom-select-option" data-value="R">R</div>
                                    <div class="custom-select-option" data-value="NC-17">NC-17</div>
                                    <div class="custom-select-option" data-value="NR">NR (Not Rated)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="selected-tags" id="filter-certification-selected"></div>
                </div>

                <!-- Streaming Services -->
                <div class="filter-section">
                    <h3 class="filter-section-title">Streaming Services</h3>
                    <div class="streaming-controls">
                        <select id="filter-streaming-region" class="streaming-region-select">
                            <option value="US"> United States</option>
                            <option value="GB"> United Kingdom</option>
                            <option value="CA"> Canada</option>
                            <option value="AU"> Australia</option>
                            <option value="DE"> Germany</option>
                            <option value="FR"> France</option>
                            <option value="ES"> Spain</option>
                            <option value="IT"> Italy</option>
                            <option value="JP"> Japan</option>
                            <option value="BR"> Brazil</option>
                            <option value="MX"> Mexico</option>
                            <option value="IN"> India</option>
                        </select>
                        <input type="text" id="filter-streaming-search" class="streaming-search-input" placeholder="Search providers...">
                    </div>
                    <div class="streaming-providers-grid" id="filter-streaming-providers">
                        <!-- Will be populated dynamically based on region -->
                    </div>
                    <button class="streaming-show-all-btn" id="streaming-show-all-btn" style="display: none;">
                        <i class="fas fa-chevron-down"></i> Show All Providers
                    </button>
                    <div class="selected-tags" id="filter-streaming-selected"></div>
                </div>

                <!-- Runtime -->
                <div class="filter-section">
                    <h3 class="filter-section-title">Runtime</h3>
                    <p class="filter-slider-label"><span id="runtime-min-value">0</span>-<span id="runtime-max-value">400</span> minute runtime</p>
                    <div class="filter-slider-container">
                        <input type="range" id="runtime-min-slider" class="filter-slider" min="0" max="400" value="0">
                        <input type="range" id="runtime-max-slider" class="filter-slider" min="0" max="400" value="400">
                    </div>
                </div>

                <!-- TMDB User Score -->
                <div class="filter-section">
                    <h3 class="filter-section-title">TMDB User Score</h3>
                    <p class="filter-slider-label">Ratings between <span id="rating-min-value">1</span> and <span id="rating-max-value">10</span></p>
                    <div class="filter-slider-container">
                        <input type="range" id="rating-min-slider" class="filter-slider" min="1" max="10" value="1" step="0.1">
                        <input type="range" id="rating-max-slider" class="filter-slider" min="1" max="10" value="10" step="0.1">
                    </div>
                </div>

                <!-- TMDB User Vote Count -->
                <div class="filter-section">
                    <h3 class="filter-section-title">TMDB User Vote Count</h3>
                    <p class="filter-slider-label">Number of votes between <span id="vote-count-min-value">0</span> and <span id="vote-count-max-value">1000</span></p>
                    <div class="filter-slider-container">
                        <input type="range" id="vote-count-min-slider" class="filter-slider" min="0" max="1000" value="0">
                        <input type="range" id="vote-count-max-slider" class="filter-slider" min="0" max="1000" value="1000">
                    </div>
                </div>

                <!-- Original Language -->
                <div class="filter-section">
                    <h3 class="filter-section-title">Original Language</h3>
                    <select id="filter-language" class="filter-select">
                        <option value="">All Languages</option>
                        <option value="en" selected>English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="it">Italian</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                        <option value="zh">Chinese</option>
                        <option value="pt">Portuguese</option>
                        <option value="ru">Russian</option>
                        <option value="hi">Hindi</option>
                        <option value="ar">Arabic</option>
                    </select>
                </div>

                <!-- Clear Filters Button -->
                <div class="filter-section">
                    <button class="filter-clear-btn" onclick="clearAllFilters()">
                        <i class="fas fa-times-circle"></i> Clear Active Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Movie Details Page (Full Page like Seerr) -->
    <div class="movie-details-page" id="movie-details-page">
        <!-- Backdrop Section -->
        <div class="movie-details-backdrop">
            <img class="movie-details-backdrop-img" id="details-backdrop" src="" alt="">
            <div class="movie-details-backdrop-gradient"></div>
        </div>

        <!-- Header Section (Poster + Title + Actions) -->
        <div class="movie-details-header">
            <div class="movie-details-poster-wrapper">
                <img id="details-poster" src="" alt="">
            </div>
            <div class="movie-details-title-section">
                <div class="movie-details-status-badges" id="details-status-badges"></div>
                <h1 class="movie-details-title">
                    <span id="details-title"></span>
                    <span class="movie-details-year" id="details-year"></span>
                </h1>
                <div class="movie-details-attributes" id="details-attributes"></div>
                <div class="movie-details-actions">
                    <button class="request-btn request-btn-secondary" id="details-trailer-btn" onclick="watchTrailer()">
                        <i class="fas fa-film"></i> Watch Trailer
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content Grid (Two Columns: Main Content + Sidebar) -->
        <div class="movie-details-content">
            <!-- Main Content Column -->
            <div class="movie-details-main">
                <div class="movie-details-tagline" id="details-tagline"></div>
                <h2 class="movie-details-section-title">Overview</h2>
                <p class="movie-details-overview-text" id="details-overview"></p>

                <div id="details-seasons" class="movie-details-seasons" style="display: none;">
                    <h3 class="movie-details-seasons-title">Seasons</h3>
                    <div class="seasons-accordion" id="details-season-list"></div>
                </div>

                <!-- Inline Crew (Director, Writers, etc.) -->
                <div id="details-crew-inline" class="movie-details-crew-inline" style="display: none;">
                    <!-- Crew will be inserted by JavaScript -->
                </div>

                <!-- Keywords Section (moved below crew) -->
                <div id="details-keywords" class="movie-details-keywords" style="display: none;">
                    <div class="keywords-list" id="details-keywords-list"></div>
                </div>
            </div>

            <!-- Sidebar Column -->
            <div class="movie-details-sidebar">
                <!-- Request Buttons (sidebar style) -->
                <div id="details-request-container" class="sidebar-request-container" style="display: none;">
                    <button class="sidebar-request-btn" id="details-request-btn" onclick="submitRequestFromDetails(false)">
                        <i class="fas fa-download"></i> <span>Request</span>
                    </button>
                    <button class="sidebar-request-btn btn-4k" id="details-request-4k-btn" onclick="submitRequestFromDetails(true)" style="display: none; margin-top: 8px;">
                        <i class="fas fa-download"></i> <span>Request 4K</span>
                    </button>
                </div>

                <!-- Collection Button (if part of a collection) -->
                <div id="details-collection-button" class="collection-button-wrapper" style="display: none;">
                    <!-- Collection button will be inserted by JavaScript -->
                </div>

                <!-- Metadata Card (ratings badges + metadata rows inserted by JavaScript) -->
                <div class="sidebar-card" id="details-metadata">
                    <!-- Content will be inserted by JavaScript -->
                </div>

                <!-- External Links Footer -->
                <div class="sidebar-card external-links-card" id="details-external-links">
                    <!-- External links will be inserted by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Full-Width Sections Below Sidebar -->
        <div class="movie-details-full-width">
            <!-- Cast Section -->
            <div id="details-cast" class="movie-details-cast" style="display: none;">
                <h2 class="movie-details-section-title">Cast</h2>
                <div class="slider-wrapper">
                    <button class="slider-arrow left" onclick="scrollSlider('details-cast-slider', 'left')">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="cast-slider" id="details-cast-slider"></div>
                    <button class="slider-arrow right" onclick="scrollSlider('details-cast-slider', 'right')">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Similar Titles Section -->
            <div id="details-similar" class="movie-details-similar" style="display: none;">
                <h2 class="movie-details-section-title">Similar Titles</h2>
                <div class="slider-wrapper">
                    <button class="slider-arrow left" onclick="scrollSlider('details-similar-slider', 'left')">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="similar-slider" id="details-similar-slider"></div>
                    <button class="slider-arrow right" onclick="scrollSlider('details-similar-slider', 'right')">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Recommendations Section -->
            <div id="details-recommendations" class="movie-details-recommendations" style="display: none;">
                <h2 class="movie-details-section-title">Recommendations</h2>
                <div class="slider-wrapper">
                    <button class="slider-arrow left" onclick="scrollSlider('details-recommendations-slider', 'left')">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="recommendations-slider" id="details-recommendations-slider"></div>
                    <button class="slider-arrow right" onclick="scrollSlider('details-recommendations-slider', 'right')">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Detail Modal -->
    <div class="media-detail-modal" id="media-modal">
        <div class="media-detail-content">
            <img class="media-detail-backdrop" id="modal-backdrop" src="" alt="">
            <div class="media-detail-backdrop-gradient"></div>
            <button class="media-detail-close" onclick="closeMediaModal()">&times;</button>
            <div class="media-detail-body">
                <div class="media-detail-header">
                    <img class="media-detail-poster" id="modal-poster" src="" alt="">
                    <div class="media-detail-info">
                        <h1 class="media-detail-title" id="modal-title"></h1>
                        <div class="media-detail-meta" id="modal-meta"></div>
                        <div class="media-detail-genres" id="modal-genres"></div>
                        <div class="media-detail-overview" id="modal-overview"></div>
                    </div>
                </div>
                <div id="modal-seasons" class="season-selection" style="display: none;">
                    <h3 class="season-selection-title">Select Seasons to Request</h3>
                    <div class="season-list" id="season-list"></div>
                </div>
                <div class="media-detail-actions">
                    <button class="request-btn request-btn-primary" id="modal-request-btn" onclick="submitRequest()">
                        <i class="fas fa-paper-plane"></i> Request
                    </button>
                    <button class="request-btn request-btn-secondary" onclick="closeMediaModal()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Cast & Crew Page -->
    <div class="full-crew-page" id="full-crew-page">
        <div class="full-crew-container">
            <div class="full-crew-header">
                <button class="full-crew-back-btn" onclick="closeFullCrewPage()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <h1 class="full-crew-title" id="full-crew-page-title">Full Cast & Crew</h1>
            </div>

            <div class="full-crew-section">
                <h2 class="full-crew-section-title">Cast</h2>
                <div class="person-cards-grid" id="full-crew-cast-grid"></div>
            </div>

            <div class="full-crew-section">
                <h2 class="full-crew-section-title">Crew</h2>
                <div class="person-cards-grid" id="full-crew-crew-grid"></div>
            </div>
        </div>
    </div>

    <!-- Season Selection Modal for TV Shows -->
    <div class="season-modal" id="season-modal">
        <div class="season-modal-content">
            <div class="season-modal-header">
                <h2 class="season-modal-title">Request TV Series</h2>
                <button class="season-modal-close" onclick="closeSeasonModal()">&times;</button>
            </div>
            <div class="season-modal-body">
                <p class="season-modal-subtitle" id="season-modal-subtitle"></p>
                <div class="season-modal-options">
                    <button class="season-option-btn season-option-all" id="select-all-seasons-btn" onclick="selectAllSeasons()">
                        <i class="fas fa-list"></i>
                        <div>
                            <div class="season-option-title">Request All Seasons</div>
                            <div class="season-option-desc">Request all available seasons</div>
                        </div>
                    </button>
                    <button class="season-option-btn season-option-specific" onclick="showSeasonCheckboxes()">
                        <i class="fas fa-check-square"></i>
                        <div>
                            <div class="season-option-title">Select Specific Seasons</div>
                            <div class="season-option-desc">Choose which seasons to request</div>
                        </div>
                    </button>
                </div>
                <div class="season-checkboxes" id="season-checkboxes" style="display: none;">
                    <h3 class="season-checkboxes-title">Select Seasons</h3>
                    <div class="season-checkbox-list" id="season-checkbox-list"></div>
                    <div class="season-modal-actions">
                        <button class="request-btn request-btn-primary" id="confirm-seasons-btn" onclick="confirmSeasonSelection()">
                            <i class="fas fa-paper-plane"></i> Request Selected Seasons
                        </button>
                        <button class="request-btn request-btn-secondary" onclick="closeSeasonModal()">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Request Modal -->
    <div class="edit-request-modal" id="edit-request-modal">
        <div class="edit-request-content" id="edit-request-content">
            <!-- Content populated by JavaScript -->
        </div>
    </div>

    <!-- Add/Edit Server Modal -->
    <div class="server-modal" id="server-modal">
        <div class="server-modal-content">
            <div class="server-modal-header">
                <h2 id="server-modal-title">Add Server</h2>
                <button class="server-modal-close" onclick="closeServerModal()">&times;</button>
            </div>
            <div class="server-modal-body">
                <form id="server-form">
                    <input type="hidden" id="server-id" value="">
                    <input type="hidden" id="server-type" value="">

                    <div class="server-form-row">
                        <label for="server-name">Server Name</label>
                        <input type="text" id="server-name" class="settings-input" placeholder="My Radarr Server" required>
                    </div>

                    <div class="server-form-row">
                        <label for="server-url">Hostname or IP Address</label>
                        <input type="text" id="server-url" class="settings-input" placeholder="http://localhost:7878" required>
                        <small>Include the protocol (http/https) and port if needed</small>
                    </div>

                    <div class="server-form-row">
                        <label for="server-api-key">API Key</label>
                        <input type="text" id="server-api-key" class="settings-input" placeholder="Your API key" required>
                        <small>Found in Settings  General in Radarr/Sonarr</small>
                    </div>

                    <div class="server-form-row server-form-checkbox">
                        <label class="settings-checkbox">
                            <input type="checkbox" id="server-ssl">
                            <span>Use SSL</span>
                        </label>
                    </div>

                    <div class="server-form-row server-form-checkbox">
                        <label class="settings-checkbox">
                            <input type="checkbox" id="server-default">
                            <span>Set as default server for this type</span>
                        </label>
                    </div>

                    <div class="server-form-row server-form-checkbox">
                        <label class="settings-checkbox">
                            <input type="checkbox" id="server-is-4k">
                            <span>4K Server (separate library for 4K content)</span>
                        </label>
                    </div>

                    <div class="server-form-divider"></div>
                    <h4 class="server-form-section-title">Default Options</h4>

                    <div class="server-form-row">
                        <label>Quality Profile</label>
                        <select id="server-quality-profile" class="settings-select">
                            <option value="">Test connection to load profiles...</option>
                        </select>
                    </div>

                    <div class="server-form-row">
                        <label>Root Folder</label>
                        <select id="server-root-folder" class="settings-select">
                            <option value="">Test connection to load folders...</option>
                        </select>
                    </div>

                    <div class="server-form-row" id="server-availability-row">
                        <label>Minimum Availability</label>
                        <select id="server-min-availability" class="settings-select">
                            <option value="announced">Announced</option>
                            <option value="inCinemas">In Cinemas</option>
                            <option value="released" selected>Released</option>
                        </select>
                    </div>

                    <div class="server-form-row" id="server-language-row" style="display: none;">
                        <label>Language Profile</label>
                        <select id="server-language-profile" class="settings-select">
                            <option value="">Test connection to load profiles...</option>
                        </select>
                    </div>

                    <div class="server-form-row" id="server-tags-row">
                        <label>Tags (optional)</label>
                        <input type="text" id="server-tags" class="settings-input" placeholder="e.g., requests, automated">
                        <small>Comma-separated list of tags to apply to all requests</small>
                    </div>

                    <div class="server-form-row" id="server-series-type-row" style="display: none;">
                        <label>Series Type</label>
                        <select id="server-series-type" class="settings-select">
                            <option value="standard">Standard</option>
                            <option value="daily">Daily</option>
                        </select>
                    </div>

                    <!-- Sonarr Anime Options Section -->
                    <div id="server-anime-section" style="display: none;">
                        <div class="server-form-divider"></div>
                        <h4 class="server-form-section-title">Anime Options</h4>

                        <div class="server-form-row">
                            <label>Anime Series Type</label>
                            <select id="server-anime-series-type" class="settings-select">
                                <option value="standard">Standard</option>
                                <option value="anime">Anime</option>
                            </select>
                        </div>

                        <div class="server-form-row">
                            <label>Anime Quality Profile</label>
                            <select id="server-anime-quality-profile" class="settings-select">
                                <option value="">Select quality profile...</option>
                            </select>
                        </div>

                        <div class="server-form-row">
                            <label>Anime Root Folder</label>
                            <select id="server-anime-root-folder" class="settings-select">
                                <option value="">Select root folder...</option>
                            </select>
                        </div>

                        <div class="server-form-row" id="server-anime-language-row">
                            <label>Anime Language Profile</label>
                            <select id="server-anime-language-profile" class="settings-select">
                                <option value="">Select language profile...</option>
                            </select>
                        </div>

                        <div class="server-form-row">
                            <label>Anime Tags (optional)</label>
                            <input type="text" id="server-anime-tags" class="settings-input" placeholder="e.g., anime, requests">
                            <small>Comma-separated list of tags for anime content</small>
                        </div>
                    </div>

                    <!-- Additional Options Section -->
                    <div class="server-form-divider"></div>
                    <h4 class="server-form-section-title">Additional Options</h4>

                    <div class="server-form-row" id="server-season-folders-row" style="display: none;">
                        <label class="settings-checkbox">
                            <input type="checkbox" id="server-season-folders">
                            <span>Season Folders</span>
                        </label>
                        <small style="margin-left: 26px;">Create season folders for TV series</small>
                    </div>

                    <div class="server-form-row">
                        <label>URL Base (optional)</label>
                        <input type="text" id="server-base-url" class="settings-input" placeholder="e.g., /radarr">
                        <small>URL base path if using a reverse proxy</small>
                    </div>

                    <div class="server-form-row">
                        <label>External URL (optional)</label>
                        <input type="text" id="server-external-url" class="settings-input" placeholder="e.g., https://radarr.example.com">
                        <small>External URL for linking in notifications</small>
                    </div>

                    <div class="server-form-row server-checkboxes">
                        <label class="settings-checkbox">
                            <input type="checkbox" id="server-enable-scan" checked>
                            <span>Enable Scan</span>
                        </label>
                        <label class="settings-checkbox">
                            <input type="checkbox" id="server-auto-search" checked>
                            <span>Enable Automatic Search</span>
                        </label>
                        <label class="settings-checkbox">
                            <input type="checkbox" id="server-tag-requests">
                            <span>Tag Requests</span>
                        </label>
                    </div>
                    <small style="margin-top: -10px; display: block; color: #94a3b8;">Tag Requests: Automatically add a tag with the requester's info</small>
                </form>
            </div>
            <div class="server-modal-footer">
                <button type="button" class="settings-btn settings-btn-secondary" onclick="testServerConnection()">
                    <i class="fas fa-plug"></i> Test Connection
                </button>
                <div style="flex: 1;"></div>
                <button type="button" class="settings-btn settings-btn-secondary" onclick="closeServerModal()">Cancel</button>
                <button type="button" class="settings-btn settings-btn-primary" onclick="saveServer()">
                    <i class="fas fa-save"></i> Save Server
                </button>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="js/request-site-integration.js"></script>
    <script>
        // ============ State ============
        let currentUser = null;
        let currentMedia = null;
        let constants = null;
        let userPermissions = null;

        // Admin mode detection - check URL param or admin session token
        const urlParams = new URLSearchParams(window.location.search);
        const isAdminMode = urlParams.get('admin') === '1' ||
            !!(localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken'));

        // Helper function to check if current user can approve a specific request
        function canUserApproveRequest(request) {
            // Admins can approve everything
            if (currentUser && currentUser.role === 'admin') {
                return true;
            }

            // Portal users need specific approval rights
            if (currentUser && currentUser.hasApprovalRights && currentUser.approvalRights) {
                const is4k = request.is_4k === 1 || request.is_4k === true;
                const isMovie = request.media_type === 'movie';

                if (is4k && isMovie) return !!currentUser.approvalRights.movies4k;
                if (is4k && !isMovie) return !!currentUser.approvalRights.tv4k;
                if (!is4k && isMovie) return !!currentUser.approvalRights.movies;
                if (!is4k && !isMovie) return !!currentUser.approvalRights.tv;
            }

            return false;
        }

        // ============ Mobile Navigation ============
        function toggleMobileNav() {
            const panel = document.getElementById('mobile-nav-panel');
            const overlay = document.getElementById('mobile-nav-overlay');
            panel.classList.toggle('show');
            overlay.classList.toggle('show');
            document.body.style.overflow = panel.classList.contains('show') ? 'hidden' : '';
        }

        function closeMobileNav() {
            const panel = document.getElementById('mobile-nav-panel');
            const overlay = document.getElementById('mobile-nav-overlay');
            panel.classList.remove('show');
            overlay.classList.remove('show');
            document.body.style.overflow = '';
        }

        function mobileNavTo(section) {
            closeMobileNav();
            // Update active state
            document.querySelectorAll('.mobile-nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === section) {
                    link.classList.add('active');
                }
            });
            // Also update desktop nav
            document.querySelectorAll('.request-nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === section) {
                    link.classList.add('active');
                }
            });
            switchSection(section);
        }

        function performMobileSearch() {
            const input = document.getElementById('mobile-search-input');
            const query = input.value.trim();
            if (query) {
                closeMobileNav();
                performSearch(query);
            }
        }

        // Mobile header search (always visible in header on mobile)
        function performMobileHeaderSearch() {
            const input = document.getElementById('mobile-header-search-input');
            const query = input.value.trim();
            if (query) {
                performSearch(query);
            }
        }

        // Also handle Enter key for mobile header search
        document.addEventListener('DOMContentLoaded', function() {
            const mobileHeaderInput = document.getElementById('mobile-header-search-input');
            if (mobileHeaderInput) {
                mobileHeaderInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performMobileHeaderSearch();
                    }
                });
            }
        });

        // Update mobile badge when pending count changes
        function updateMobilePendingBadge(count) {
            const badge = document.getElementById('mobile-pending-badge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = '';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Show/hide settings link on mobile
        function updateMobileSettingsVisibility(show) {
            const mobileSettingsLink = document.getElementById('mobile-settings-link');
            if (mobileSettingsLink) {
                mobileSettingsLink.style.display = show ? '' : 'none';
            }
        }

        // ============ Browser History ============
        // Restore view from URL hash
        async function restoreViewFromHash() {
            const hash = window.location.hash.slice(1); // Remove #
            if (!hash || hash === 'discover') {
                // Default to discover
                history.replaceState({ view: 'discover' }, '', '#discover');
                return;
            }

            const parts = hash.split('/');

            // Handle settings page: #settings
            if (parts[0] === 'settings') {
                switchSection('settings');
                return;
            }

            // Handle requests page: #requests
            if (parts[0] === 'requests') {
                switchSection('requests');
                return;
            }

            // Handle all movies browse page: #movies
            if (parts[0] === 'movies' && !parts[1]) {
                switchSection('movies');
                return;
            }

            // Handle all TV shows browse page: #tv without ID
            if (parts[0] === 'tv' && !parts[1]) {
                switchSection('tv');
                return;
            }

            // Handle search: #search/query
            if (parts[0] === 'search' && parts[1]) {
                const query = decodeURIComponent(parts.slice(1).join('/'));
                performSearch(query);
                return;
            }

            // Handle media details: #movie/550 or #tv/123
            if ((parts[0] === 'movie' || parts[0] === 'tv') && parts[1]) {
                await openMediaModal(parts[1], parts[0], true);
            }
            // Handle browse pages: #browse/genre/28/movie
            else if (parts[0] === 'browse' && parts[1] && parts[2]) {
                const browseType = parts[1];
                const id = parts[2];

                if (browseType === 'genre' && parts[3]) {
                    const mediaType = parts[3];
                    // We need the genre name - for now use a placeholder, will be set when browse loads
                    exploreGenre(id, mediaType, '', true);
                } else if (browseType === 'studio') {
                    exploreStudio(id, '', true);
                } else if (browseType === 'network') {
                    exploreNetwork(id, '', true);
                } else if (browseType === 'collection') {
                    exploreCollection(id, '', true);
                }
            }
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', async (event) => {
            if (event.state) {
                const state = event.state;

                if (state.view === 'discover') {
                    goBackToDiscover(true);
                } else if (state.view === 'media') {
                    await openMediaModal(state.id, state.type, true);
                } else if (state.view === 'search') {
                    performSearch(state.query);
                } else if (state.view === 'browse') {
                    const { browseType, id, mediaType, name } = state;

                    // Handle all movies/tv browse
                    if (browseType === 'movies') {
                        switchSection('movies');
                    } else if (browseType === 'tv') {
                        switchSection('tv');
                    } else if (browseType === 'genre') {
                        exploreGenre(id, mediaType, name, true);
                    } else if (browseType === 'studio') {
                        exploreStudio(id, name, true);
                    } else if (browseType === 'network') {
                        exploreNetwork(id, name, true);
                    } else if (browseType === 'collection') {
                        exploreCollection(id, name, true);
                    }
                }
            }
        });

        // ============ Initialization ============
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('%c REQUEST SITE VERSION: 2025-12-24-01:00 LOADED', 'color: cyan; font-size: 16px; font-weight: bold');

            // Check authentication first - redirect to login if not authenticated
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                return; // Will redirect to login
            }

            await loadUserInfo();
            await loadConstants();
            loadUserUsage(); // Load usage stats for limits indicator

            // Check hash first to determine what to load
            const hash = window.location.hash.slice(1);
            const isDiscoverView = !hash || hash === 'discover';

            // Only load discover content if we're on discover view
            if (isDiscoverView) {
                document.getElementById('discover-section').style.display = 'block';
                await loadDiscoverContent();
            }

            setupNavigation();
            setupSearch();
            checkBackLink();
            setupDragScrolling();

            // Restore view from URL (will handle non-discover views)
            if (!isDiscoverView) {
                await restoreViewFromHash();
            }

            // Show the container after loading
            document.body.classList.remove('loading');
            setTimeout(() => {
                document.querySelector('.request-container').style.opacity = '1';
            }, 50);
        });

        // ============ Slider Controls ============
        function scrollSlider(sliderId, direction) {
            const slider = document.getElementById(sliderId);
            const scrollAmount = slider.offsetWidth * 0.8;
            const newScroll = direction === 'left'
                ? slider.scrollLeft - scrollAmount
                : slider.scrollLeft + scrollAmount;
            slider.scrollTo({ left: newScroll, behavior: 'smooth' });
        }

        function setupDragScrolling() {
            document.querySelectorAll('.media-slider').forEach(slider => {
                let isDown = false;
                let startX;
                let scrollLeft;

                slider.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.media-card, .genre-card, .logo-card, .recent-request-card')) {
                        return; // Don't drag if clicking on a card
                    }
                    isDown = true;
                    slider.classList.add('dragging');
                    startX = e.pageX - slider.offsetLeft;
                    scrollLeft = slider.scrollLeft;
                });

                slider.addEventListener('mouseleave', () => {
                    isDown = false;
                    slider.classList.remove('dragging');
                });

                slider.addEventListener('mouseup', () => {
                    isDown = false;
                    slider.classList.remove('dragging');
                });

                slider.addEventListener('mousemove', (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - slider.offsetLeft;
                    const walk = (x - startX) * 2;
                    slider.scrollLeft = scrollLeft - walk;
                });

                // Touch support for mobile
                slider.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].pageX - slider.offsetLeft;
                    scrollLeft = slider.scrollLeft;
                }, { passive: true });

                slider.addEventListener('touchmove', (e) => {
                    const x = e.touches[0].pageX - slider.offsetLeft;
                    const walk = (x - startX) * 2;
                    slider.scrollLeft = scrollLeft - walk;
                }, { passive: true });
            });
        }

        async function checkAuth() {
            // Check for admin session token first (from admin portal)
            const adminToken = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
            const portalToken = localStorage.getItem('portal_token');
            const portalUser = localStorage.getItem('portal_user');

            // If admin mode is detected via URL param or admin session exists, validate admin auth
            if (isAdminMode && adminToken) {
                try {
                    const response = await fetch('/api/v2/auth/verify', {
                        headers: {
                            'Authorization': `Bearer ${adminToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success || data.user) {
                            return true; // Admin authenticated
                        }
                    }
                } catch (error) {
                    console.error('Admin auth check failed:', error);
                }
            }

            // Fall back to portal user authentication
            if (!portalToken || !portalUser) {
                // If we're in admin mode but admin auth failed, redirect to admin login
                if (isAdminMode) {
                    window.location.href = '/login.html';
                    return false;
                }
                // Otherwise redirect to login
                window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
                return false;
            }

            try {
                const response = await fetch('/api/v2/portal/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${portalToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Session expired');
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error('Invalid session');
                }

                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                localStorage.removeItem('portal_token');
                localStorage.removeItem('portal_user');
                window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
                return false;
            }
        }

        async function loadUserInfo() {
            try {
                const token = localStorage.getItem('portal_token');

                if (isAdminMode) {
                    // Admin - show settings link and update avatar
                    const settingsLink = document.getElementById('settings-link');
                    if (settingsLink) settingsLink.style.display = 'block';
                    updateMobileSettingsVisibility(true); // Also show on mobile

                    // Load Tools dropdown for admins
                    loadToolsDropdown();

                    // Update "Requests" link text to "Manage Requests" for admins (preserve badge)
                    const requestsLink = document.querySelector('.request-nav-link[data-section="requests"]');
                    if (requestsLink) {
                        requestsLink.innerHTML = 'Manage Requests <span class="request-nav-badge" id="pending-requests-badge" style="display: none;">0</span>';
                    }
                    // Also update mobile requests link
                    const mobileRequestsLink = document.querySelector('.mobile-nav-link[data-section="requests"]');
                    if (mobileRequestsLink) {
                        mobileRequestsLink.innerHTML = '<i class="fas fa-list"></i> Manage Requests <span class="request-nav-badge" id="mobile-pending-badge" style="display: none;">0</span>';
                    }

                    // Get actual admin user info from session
                    const adminToken = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
                    let adminName = 'Admin';
                    let adminId = 'admin';

                    if (adminToken) {
                        try {
                            const adminResponse = await fetch('/api/v2/auth/verify', {
                                headers: { 'Authorization': `Bearer ${adminToken}` }
                            });
                            if (adminResponse.ok) {
                                const adminData = await adminResponse.json();
                                if (adminData.user) {
                                    adminName = adminData.user.name || adminData.user.email || 'Admin';
                                    adminId = adminData.user.id || 'admin';
                                }
                            }
                        } catch (e) {
                            console.error('Failed to get admin info:', e);
                        }
                    }

                    const avatar = document.getElementById('user-avatar');
                    if (avatar) {
                        avatar.textContent = adminName.charAt(0).toUpperCase();
                        avatar.style.background = 'linear-gradient(135deg, #f59e0b 0%, #ef4444 100%)';
                    }

                    // Set currentUser for admin so they can submit requests
                    // Admin requests will be auto-approved
                    currentUser = {
                        id: adminId,
                        name: adminName,
                        is_admin: true,
                        role: 'admin'
                    };

                    // Admins have all permissions
                    userPermissions = {
                        can_request: true,
                        can_request_movie: true,
                        can_request_tv: true,
                        can_request_4k: true,
                        can_request_4k_movie: true,
                        can_request_4k_tv: true,
                        can_manage_requests: true,
                        can_auto_approve: true
                    };

                    // Load pending requests count for badge
                    loadPendingRequestsCount();
                } else {
                    // Portal user - use Bearer token
                    const response = await fetch('/api/v2/portal/user/full', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        // API returns { success: true, user: { id, name, ... } }
                        currentUser = data.user || data;
                        const avatar = document.getElementById('user-avatar');
                        if (avatar && currentUser.name) {
                            avatar.textContent = currentUser.name.charAt(0).toUpperCase();
                        }

                        // Fetch Request Site permissions for portal user
                        try {
                            const permResponse = await fetch('/api/v2/request-site/auth/me', {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });

                            // Check if access was denied (403)
                            if (permResponse.status === 403) {
                                const errorData = await permResponse.json();
                                if (errorData.has_access === false) {
                                    // User doesn't have Request Site access - show access denied message
                                    showAccessDenied(errorData.message || 'Request Site access is not enabled for your account.');
                                    return;
                                }
                            }

                            if (permResponse.ok) {
                                const permData = await permResponse.json();
                                userPermissions = permData.permissions || {};

                                // Check if user has any approval rights
                                const hasApprovalRights = userPermissions.can_approve_movies ||
                                    userPermissions.can_approve_tv ||
                                    userPermissions.can_approve_4k_movies ||
                                    userPermissions.can_approve_4k_tv;

                                if (hasApprovalRights) {
                                    // Show Manage Requests nav link like admin
                                    const requestsLink = document.querySelector('.request-nav-link[data-section="requests"]');
                                    if (requestsLink) {
                                        requestsLink.innerHTML = 'Manage Requests <span class="request-nav-badge" id="pending-requests-badge" style="display: none;">0</span>';
                                    }
                                    const mobileRequestsLink = document.querySelector('.mobile-nav-link[data-section="requests"]');
                                    if (mobileRequestsLink) {
                                        mobileRequestsLink.innerHTML = '<i class="fas fa-list"></i> Manage Requests <span class="request-nav-badge" id="mobile-pending-badge" style="display: none;">0</span>';
                                    }
                                    // Store that user has approval rights for navigation
                                    currentUser.hasApprovalRights = true;
                                    currentUser.approvalRights = {
                                        movies: userPermissions.can_approve_movies,
                                        tv: userPermissions.can_approve_tv,
                                        movies4k: userPermissions.can_approve_4k_movies,
                                        tv4k: userPermissions.can_approve_4k_tv
                                    };
                                    // Load pending requests count
                                    loadPendingRequestsCount();
                                }
                            }
                        } catch (permErr) {
                            console.error('Failed to load permissions:', permErr);
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
            }
        }

        function checkBackLink() {
            const backLink = document.getElementById('back-link');

            if (isAdminMode) {
                backLink.href = '../admin/index.html';
                backLink.innerHTML = '<i class="fas fa-arrow-left"></i> Admin';
            } else {
                backLink.href = 'index.html';
            }
        }

        /**
         * Show access denied message and hide page content
         */
        function showAccessDenied(message) {
            // Hide all content sections
            document.querySelectorAll('.request-container, .request-nav, .request-mobile-nav').forEach(el => {
                el.style.display = 'none';
            });

            // Create and show access denied message
            const accessDeniedHtml = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; padding: 40px;">
                    <div style="font-size: 64px; margin-bottom: 20px; color: var(--text-secondary);">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h2 style="margin-bottom: 10px; color: var(--text-primary);">Access Restricted</h2>
                    <p style="color: var(--text-secondary); max-width: 400px; margin-bottom: 30px;">
                        ${message}
                    </p>
                    <a href="index.html" class="btn-primary" style="padding: 12px 24px; border-radius: 8px; text-decoration: none;">
                        <i class="fas fa-arrow-left" style="margin-right: 8px;"></i>
                        Return to Portal
                    </a>
                </div>
            `;

            // Insert after the back link
            const backLink = document.getElementById('back-link');
            if (backLink && backLink.parentElement) {
                backLink.parentElement.insertAdjacentHTML('afterend', accessDeniedHtml);
            } else {
                document.body.innerHTML = accessDeniedHtml;
            }
        }

        // ============ User Usage Indicator ============
        let userUsageData = null;

        async function loadUserUsage() {
            try {
                const token = localStorage.getItem('portal_token') || localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
                console.log('[Usage] Loading usage with token:', token ? 'present' : 'missing');

                const response = await fetch('/api/v2/request-site/my-usage', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                console.log('[Usage] Response status:', response.status);

                if (response.ok) {
                    userUsageData = await response.json();
                    console.log('[Usage] Data received:', userUsageData);
                    renderUsageIndicator();
                } else {
                    const errorText = await response.text();
                    console.error('[Usage] API error:', response.status, errorText);
                }
            } catch (error) {
                console.error('Failed to load user usage:', error);
            }
        }

        function renderUsageIndicator() {
            if (!userUsageData) return;

            const indicator = document.getElementById('usage-indicator');
            const content = document.getElementById('usage-dropdown-content');
            const mobileContainer = document.getElementById('mobile-usage-container');
            const mobileContent = document.getElementById('mobile-usage-content');

            // Check if user has any limits (not all unlimited)
            const hasLimits = !userUsageData.movies.unlimited ||
                              !userUsageData.tvShows.unlimited ||
                              !userUsageData.tvSeasons.unlimited ||
                              (userUsageData.movies4k && !userUsageData.movies4k.unlimited) ||
                              (userUsageData.tvShows4k && !userUsageData.tvShows4k.unlimited) ||
                              (userUsageData.tvSeasons4k && !userUsageData.tvSeasons4k.unlimited);

            console.log('[Usage] hasLimits:', hasLimits, '| movies.unlimited:', userUsageData.movies.unlimited,
                        '| tvShows.unlimited:', userUsageData.tvShows.unlimited,
                        '| tvSeasons.unlimited:', userUsageData.tvSeasons.unlimited,
                        '| movies4k:', userUsageData.movies4k, '| tvShows4k:', userUsageData.tvShows4k,
                        '| tvSeasons4k:', userUsageData.tvSeasons4k);

            // Show indicator if user has any limits
            if (hasLimits) {
                console.log('[Usage] Showing usage indicator');
                if (indicator) indicator.style.display = 'block';
                if (mobileContainer) mobileContainer.style.display = 'block';
            } else {
                console.log('[Usage] User has no limits, indicator stays hidden');
            }

            // Render dropdown content
            let html = '';

                // Movies
                if (!userUsageData.movies.unlimited) {
                    const pct = Math.min(100, (userUsageData.movies.used / userUsageData.movies.limit) * 100);
                    const colorClass = pct >= 100 ? 'at-limit' : pct >= 75 ? 'near-limit' : 'has-limit';
                    const barClass = pct >= 100 ? 'high' : pct >= 75 ? 'medium' : 'low';
                    html += `
                        <div class="usage-item">
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span class="usage-item-label"><i class="fas fa-film"></i> Movies</span>
                                    <span class="usage-item-value ${colorClass}">${userUsageData.movies.used}/${userUsageData.movies.limit}</span>
                                </div>
                                <div class="usage-progress">
                                    <div class="usage-progress-bar ${barClass}" style="width: ${pct}%"></div>
                                </div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">per ${userUsageData.movies.days} days</div>
                            </div>
                        </div>
                    `;
                }

                // TV Shows
                if (!userUsageData.tvShows.unlimited) {
                    const pct = Math.min(100, (userUsageData.tvShows.used / userUsageData.tvShows.limit) * 100);
                    const colorClass = pct >= 100 ? 'at-limit' : pct >= 75 ? 'near-limit' : 'has-limit';
                    const barClass = pct >= 100 ? 'high' : pct >= 75 ? 'medium' : 'low';
                    html += `
                        <div class="usage-item">
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span class="usage-item-label"><i class="fas fa-tv"></i> TV Shows</span>
                                    <span class="usage-item-value ${colorClass}">${userUsageData.tvShows.used}/${userUsageData.tvShows.limit}</span>
                                </div>
                                <div class="usage-progress">
                                    <div class="usage-progress-bar ${barClass}" style="width: ${pct}%"></div>
                                </div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">per ${userUsageData.tvShows.days} days</div>
                            </div>
                        </div>
                    `;
                }

                // TV Seasons
                if (!userUsageData.tvSeasons.unlimited) {
                    const pct = Math.min(100, (userUsageData.tvSeasons.used / userUsageData.tvSeasons.limit) * 100);
                    const colorClass = pct >= 100 ? 'at-limit' : pct >= 75 ? 'near-limit' : 'has-limit';
                    const barClass = pct >= 100 ? 'high' : pct >= 75 ? 'medium' : 'low';
                    html += `
                        <div class="usage-item">
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span class="usage-item-label"><i class="fas fa-layer-group"></i> Seasons</span>
                                    <span class="usage-item-value ${colorClass}">${userUsageData.tvSeasons.used}/${userUsageData.tvSeasons.limit}</span>
                                </div>
                                <div class="usage-progress">
                                    <div class="usage-progress-bar ${barClass}" style="width: ${pct}%"></div>
                                </div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">per ${userUsageData.tvSeasons.days} days</div>
                            </div>
                        </div>
                    `;
                }

                // 4K Movies
                if (userUsageData.movies4k && !userUsageData.movies4k.unlimited) {
                    const pct = Math.min(100, (userUsageData.movies4k.used / userUsageData.movies4k.limit) * 100);
                    const colorClass = pct >= 100 ? 'at-limit' : pct >= 75 ? 'near-limit' : 'has-limit';
                    const barClass = pct >= 100 ? 'high' : pct >= 75 ? 'medium' : 'low';
                    html += `
                        <div class="usage-item">
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span class="usage-item-label"><i class="fas fa-film"></i> 4K Movies</span>
                                    <span class="usage-item-value ${colorClass}">${userUsageData.movies4k.used}/${userUsageData.movies4k.limit}</span>
                                </div>
                                <div class="usage-progress">
                                    <div class="usage-progress-bar ${barClass}" style="width: ${pct}%"></div>
                                </div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">per ${userUsageData.movies4k.days} days</div>
                            </div>
                        </div>
                    `;
                }

                // 4K TV Shows
                if (userUsageData.tvShows4k && !userUsageData.tvShows4k.unlimited) {
                    const pct = Math.min(100, (userUsageData.tvShows4k.used / userUsageData.tvShows4k.limit) * 100);
                    const colorClass = pct >= 100 ? 'at-limit' : pct >= 75 ? 'near-limit' : 'has-limit';
                    const barClass = pct >= 100 ? 'high' : pct >= 75 ? 'medium' : 'low';
                    html += `
                        <div class="usage-item">
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span class="usage-item-label"><i class="fas fa-tv"></i> 4K TV Shows</span>
                                    <span class="usage-item-value ${colorClass}">${userUsageData.tvShows4k.used}/${userUsageData.tvShows4k.limit}</span>
                                </div>
                                <div class="usage-progress">
                                    <div class="usage-progress-bar ${barClass}" style="width: ${pct}%"></div>
                                </div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">per ${userUsageData.tvShows4k.days} days</div>
                            </div>
                        </div>
                    `;
                }

                // 4K TV Seasons
                if (userUsageData.tvSeasons4k && !userUsageData.tvSeasons4k.unlimited) {
                    const pct = Math.min(100, (userUsageData.tvSeasons4k.used / userUsageData.tvSeasons4k.limit) * 100);
                    const colorClass = pct >= 100 ? 'at-limit' : pct >= 75 ? 'near-limit' : 'has-limit';
                    const barClass = pct >= 100 ? 'high' : pct >= 75 ? 'medium' : 'low';
                    html += `
                        <div class="usage-item">
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span class="usage-item-label"><i class="fas fa-layer-group"></i> 4K Seasons</span>
                                    <span class="usage-item-value ${colorClass}">${userUsageData.tvSeasons4k.used}/${userUsageData.tvSeasons4k.limit}</span>
                                </div>
                                <div class="usage-progress">
                                    <div class="usage-progress-bar ${barClass}" style="width: ${pct}%"></div>
                                </div>
                                <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">per ${userUsageData.tvSeasons4k.days} days</div>
                            </div>
                        </div>
                    `;
                }

            // If all unlimited, show that
            if (!html) {
                html = '<div style="text-align: center; color: #22c55e; padding: 12px;"><i class="fas fa-infinity"></i> No request limits</div>';
            }

            // Set content for both desktop and mobile
            if (content) content.innerHTML = html;
            if (mobileContent) mobileContent.innerHTML = html;
        }

        function toggleUsageDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('usage-dropdown');
            dropdown.classList.toggle('show');

            // Close when clicking outside
            if (dropdown.classList.contains('show')) {
                document.addEventListener('click', closeUsageDropdownOnClickOutside);
            }
        }

        function closeUsageDropdownOnClickOutside(event) {
            const dropdown = document.getElementById('usage-dropdown');
            const indicator = document.getElementById('usage-indicator');
            if (dropdown && !indicator.contains(event.target)) {
                dropdown.classList.remove('show');
                document.removeEventListener('click', closeUsageDropdownOnClickOutside);
            }
        }

        // ============ Tools Dropdown (Admin Only) ============
        const toolIcons = {
            sonarr: 'fa-tv',
            radarr: 'fa-film',
            qbittorrent: 'fa-magnet',
            sabnzbd: 'fa-download'
        };

        async function loadToolsDropdown() {
            const container = document.getElementById('tools-nav-dropdown');
            const menu = document.getElementById('tools-dropdown-menu');
            if (!container || !menu) return;

            const adminToken = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
            if (!adminToken) return;

            try {
                const response = await fetch('/api/v2/media-managers', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const data = await response.json();
                const managers = (data.managers || []).filter(m => m.is_enabled);

                if (managers.length === 0) {
                    container.style.display = 'none';
                    return;
                }

                container.style.display = 'inline-block';

                let menuHtml = managers.map(m => `
                    <a href="#" onclick="openTool(${m.id}); return false;">
                        <span class="tool-icon ${m.type}">
                            <i class="fas ${toolIcons[m.type] || 'fa-server'}"></i>
                        </span>
                        ${escapeHtml(m.name)}
                    </a>
                `).join('');

                menuHtml += `
                    <div class="dropdown-footer">
                        <a href="#" onclick="navigateToManagersSettings(); return false;">
                            <i class="fas fa-cog"></i> Manage Tools
                        </a>
                    </div>
                `;

                menu.innerHTML = menuHtml;
            } catch (error) {
                console.error('Failed to load tools dropdown:', error);
                container.style.display = 'none';
            }
        }

        function toggleToolsDropdown(event) {
            event.stopPropagation();
            const menu = document.getElementById('tools-dropdown-menu');
            menu.classList.toggle('show');

            if (menu.classList.contains('show')) {
                document.addEventListener('click', closeToolsDropdownOnClickOutside);
            }
        }

        function closeToolsDropdownOnClickOutside(event) {
            const menu = document.getElementById('tools-dropdown-menu');
            const container = document.getElementById('tools-nav-dropdown');
            if (menu && container && !container.contains(event.target)) {
                menu.classList.remove('show');
                document.removeEventListener('click', closeToolsDropdownOnClickOutside);
            }
        }

        async function openTool(managerId) {
            document.getElementById('tools-dropdown-menu')?.classList.remove('show');

            const adminToken = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');

            try {
                const response = await fetch(`/api/v2/media-managers/${managerId}/open-url`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const data = await response.json();

                if (data.connection_mode === 'proxy') {
                    window.open(`/admin/tool-proxy.html?id=${managerId}`, '_blank');
                } else {
                    window.open(data.url, '_blank');
                }
            } catch (error) {
                console.error('Failed to open tool:', error);
            }
        }

        function navigateToManagersSettings() {
            // Close the dropdown
            document.getElementById('tools-dropdown-menu')?.classList.remove('show');
            // Switch to settings section and managers tab
            settingsCurrentTab = 'managers';
            switchSection('settings');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        async function loadConstants() {
            try {
                const response = await fetch('/api/v2/request-site/constants');
                constants = await response.json();
            } catch (error) {
                console.error('Failed to load constants:', error);
            }
        }

        function setupNavigation() {
            document.querySelectorAll('.request-nav-link[data-section]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.dataset.section;
                    switchSection(section);
                });
            });
        }

        // Helper function to hide all sections
        function hideAllSections() {
            document.getElementById('discover-section').style.display = 'none';
            document.getElementById('browse-section').style.display = 'none';
            document.getElementById('movie-details-page').classList.remove('show');
            document.getElementById('requests-section').style.display = 'none';
            document.getElementById('settings-section').style.display = 'none';
            window.removeEventListener('scroll', handleBrowseScroll);
        }

        function switchSection(section) {
            // Update nav links
            document.querySelectorAll('.request-nav-link[data-section]').forEach(link => {
                link.classList.toggle('active', link.dataset.section === section);
            });

            // Hide all sections first
            hideAllSections();

            // Handle different sections
            if (section === 'discover') {
                history.pushState({ view: 'discover' }, '', '#discover');
                document.getElementById('discover-section').style.display = 'block';
                window.removeEventListener('scroll', handleBrowseScroll);
                // Reload discover content to ensure it's fresh
                loadDiscoverContent().catch(err => console.error('Error loading discover content:', err));
            } else if (section === 'movies') {
                history.pushState({ view: 'browse', browseType: 'movies' }, '', '#movies');
                // Show all movies browse page
                document.getElementById('discover-section').style.display = 'none';
                document.getElementById('movie-details-page').classList.remove('show');
                document.getElementById('browse-section').style.display = 'block';

                // Show browse controls (may be hidden from search)
                const browseControls = document.querySelector('.browse-controls');
                if (browseControls) browseControls.style.display = 'flex';

                // Remove old scroll handler
                window.removeEventListener('scroll', handleBrowseScroll);

                // Always reset filters when switching to movies
                currentFilters = {
                    dateFrom: null,
                    dateTo: null,
                    genres: [],
                    status: [],
                    certifications: [],
                    keywords: [],
                    studios: [],
                    streamingProviders: [],
                    streamingRegion: 'US',
                    runtimeMin: 0,
                    runtimeMax: 400,
                    ratingMin: 1,
                    ratingMax: 10,
                    voteCountMin: 0,
                    voteCountMax: 1000,
                    language: 'en'
                };
                updateActiveFiltersCount();

                // Clear the grid first
                document.getElementById('browse-grid').innerHTML = '';

                // Set up browse for all movies - MUST reset isLoading to false
                browseState = {
                    type: 'all-movies',
                    id: null,
                    name: 'All Movies',
                    mediaType: 'movie',
                    page: 1,
                    isLoading: false,
                    hasMore: true,
                    sortBy: 'popularity.desc'
                };

                document.getElementById('browse-title').innerHTML = '<i class="fas fa-film" id="browse-icon"></i> Movies';

                // Load content immediately
                loadBrowseContent().then(() => {
                    ensureViewportFilled();
                }).catch(err => console.error('Error loading movies:', err));
                setupBrowseScroll();
            } else if (section === 'tv') {
                history.pushState({ view: 'browse', browseType: 'tv' }, '', '#tv');
                // Show all TV shows browse page
                document.getElementById('discover-section').style.display = 'none';
                document.getElementById('movie-details-page').classList.remove('show');
                document.getElementById('browse-section').style.display = 'block';

                // Show browse controls (may be hidden from search)
                const browseControls = document.querySelector('.browse-controls');
                if (browseControls) browseControls.style.display = 'flex';

                // Remove old scroll handler
                window.removeEventListener('scroll', handleBrowseScroll);

                // Always reset filters when switching to TV
                currentFilters = {
                    dateFrom: null,
                    dateTo: null,
                    genres: [],
                    status: [],
                    certifications: [],
                    keywords: [],
                    studios: [],
                    streamingProviders: [],
                    streamingRegion: 'US',
                    runtimeMin: 0,
                    runtimeMax: 400,
                    ratingMin: 1,
                    ratingMax: 10,
                    voteCountMin: 0,
                    voteCountMax: 1000,
                    language: 'en'
                };
                updateActiveFiltersCount();

                // Clear the grid first
                document.getElementById('browse-grid').innerHTML = '';

                // Set up browse for all TV shows - MUST reset isLoading to false
                browseState = {
                    type: 'all-tv',
                    id: null,
                    name: 'All TV Shows',
                    mediaType: 'tv',
                    page: 1,
                    isLoading: false,
                    hasMore: true,
                    sortBy: 'popularity.desc'
                };

                document.getElementById('browse-title').innerHTML = '<i class="fas fa-tv" id="browse-icon"></i> TV Shows';

                // Load content immediately
                loadBrowseContent().then(() => {
                    ensureViewportFilled();
                }).catch(err => console.error('Error loading TV shows:', err));
                setupBrowseScroll();
            } else if (section === 'requests') {
                if (isAdminMode || currentUser?.hasApprovalRights) {
                    // Admin or user with approval rights - show inline manage requests section
                    history.pushState({ view: 'requests' }, '', '#requests');
                    document.getElementById('discover-section').style.display = 'none';
                    document.getElementById('browse-section').style.display = 'none';
                    document.getElementById('movie-details-page').classList.remove('show');
                    document.getElementById('requests-section').style.display = 'block';
                    window.removeEventListener('scroll', handleBrowseScroll);
                    loadAdminRequestsSection();
                } else {
                    // Portal user - redirect to My Requests page
                    window.location.href = '/portal/my-requests.html';
                }
            } else if (section === 'settings') {
                // Admin only - show settings section
                if (isAdminMode) {
                    history.pushState({ view: 'settings' }, '', '#settings');
                    document.getElementById('discover-section').style.display = 'none';
                    document.getElementById('browse-section').style.display = 'none';
                    document.getElementById('movie-details-page').classList.remove('show');
                    document.getElementById('requests-section').style.display = 'none';
                    document.getElementById('settings-section').style.display = 'block';
                    window.removeEventListener('scroll', handleBrowseScroll);
                    loadSettingsSection();
                }
            }
        }

        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }

        // ============ Discover Content Loading ============
        async function loadDiscoverContent() {
            // Load recent requests and recently added first (admin-only features)
            loadRecentRequests();
            loadRecentlyAdded();

            // Load all sliders in parallel
            await Promise.all([
                loadTrending(),
                loadPopularMovies(),
                loadMovieGenres(),
                loadUpcomingMovies(),
                loadStudios(),
                loadPopularSeries(),
                loadSeriesGenres(),
                loadUpcomingSeries(),
                loadNetworks()
            ]);
        }

        // ============ Recent Requests Section (Admin or users with approval rights) ============
        async function loadRecentRequests() {
            // Only show for admins or users with approval rights
            if (!currentUser || (currentUser.role !== 'admin' && !currentUser.hasApprovalRights)) {
                document.getElementById('recent-requests-container').style.display = 'none';
                return;
            }

            try {
                // Use admin token if available, otherwise portal token for users with approval rights
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken') || localStorage.getItem('portal_token');
                const response = await fetch('/api/v2/request-site-api/requests/all', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    console.error('Failed to load recent requests');
                    return;
                }

                const data = await response.json();
                const allRequests = data.requests || [];

                // Count pending for badge (only requests user can approve)
                const pendingCount = allRequests.filter(r =>
                    (r.status === 'pending' || r.status === 1) && canUserApproveRequest(r)
                ).length;
                updatePendingBadge(pendingCount);

                // Show recent 20 requests (all statuses, sorted by date descending)
                const recentRequests = allRequests.slice(0, 20);

                if (recentRequests.length === 0) {
                    document.getElementById('recent-requests-container').style.display = 'none';
                    return;
                }

                const container = document.getElementById('recent-requests-container');
                const slider = document.getElementById('recent-requests-slider');

                container.style.display = 'block';
                slider.innerHTML = recentRequests.map((request, index) => {
                    const hasPoster = request.poster_path;
                    const posterUrl = hasPoster ? `https://image.tmdb.org/t/p/w342${request.poster_path}` : '';
                    const backdropUrl = hasPoster ? `https://image.tmdb.org/t/p/w780${request.poster_path}` : '';
                    // Use user_name from join, fall back to requested_by
                    const userName = request.user_name || request.requested_by || 'Unknown';
                    const userInitial = userName.charAt(0).toUpperCase();
                    const year = request.release_date ? new Date(request.release_date).getFullYear() : '';

                    // Determine status for display
                    const isPending = request.status === 'pending' || request.status === 1;
                    const isProcessing = request.status === 'processing' || request.status === 2;
                    const isAvailable = request.status === 'available' || request.status === 4 || request.status === 3;
                    const isDeclined = request.status === 'declined' || request.status === 5;

                    let statusClass = isPending ? 'requested' : 'pending';
                    let statusText = 'Requested';
                    if (isProcessing) { statusClass = 'processing'; statusText = 'Processing'; }
                    else if (isAvailable) { statusClass = 'available'; statusText = 'Available'; }
                    else if (isDeclined) { statusClass = 'declined'; statusText = 'Declined'; }

                    // Avatar color based on user name hash
                    const colors = ['green', 'purple', 'blue', 'orange'];
                    const colorIndex = userName.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % colors.length;
                    const avatarColor = colors[colorIndex];

                    // Seasons info for TV shows
                    const seasonsHtml = request.media_type === 'tv' && request.seasons_requested
                        ? `<div class="recent-request-seasons">Seasons <span>${request.seasons_requested}</span></div>`
                        : '';

                    // Poster element
                    const posterElement = hasPoster
                        ? `<img class="recent-request-poster-img" src="${posterUrl}" alt="${request.title}">`
                        : `<div class="recent-request-poster-img" style="display: flex; align-items: center; justify-content: center;"><i class="fas fa-film" style="color: #475569; font-size: 28px;"></i></div>`;

                    // Bottom row with status and optional approve/decline buttons (only if user can approve this type)
                    let bottomHtml = `<div class="recent-request-status ${statusClass}">${statusText}</div>`;
                    if (isPending && canUserApproveRequest(request)) {
                        bottomHtml += `
                            <div class="recent-request-actions">
                                <button class="recent-request-btn approve" onclick="approveRecentRequest(${request.id}, this, event)">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="recent-request-btn decline" onclick="declineRecentRequest(${request.id}, this, event)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>`;
                    }

                    return `
                        <div class="recent-request-card" data-request-id="${request.id}" onclick="openMediaModal(${request.tmdb_id}, '${request.media_type}')">
                            <div class="recent-request-bg" style="background-image: url('${backdropUrl}')"></div>
                            <div class="recent-request-poster-wrap">
                                ${posterElement}
                            </div>
                            <div class="recent-request-details">
                                <div class="recent-request-year">${year}</div>
                                <div class="recent-request-title">${request.title || 'Unknown Title'}</div>
                                <div class="recent-request-user">
                                    <div class="recent-request-user-avatar ${avatarColor}">${userInitial}</div>
                                    <span>${userName}</span>
                                </div>
                                ${seasonsHtml}
                                <div class="recent-request-bottom" onclick="event.stopPropagation()">
                                    ${bottomHtml}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load recent requests:', error);
            }
        }

        // Quick approve from Discover page
        async function approveRecentRequest(requestId, btn, event) {
            if (event) event.stopPropagation();
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken') || localStorage.getItem('portal_token');
                const response = await fetch(`/api/v2/request-site/requests/${requestId}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    // Update status badge and remove action buttons
                    const card = btn.closest('.recent-request-card');
                    const statusBadge = card.querySelector('.recent-request-status');
                    const actionsDiv = card.querySelector('.recent-request-actions');

                    // Update status badge
                    if (statusBadge) {
                        statusBadge.className = 'recent-request-status processing';
                        statusBadge.textContent = 'Processing';
                    }
                    // Remove action buttons
                    if (actionsDiv) {
                        actionsDiv.remove();
                    }
                    // Update badge count
                    const badge = document.getElementById('pending-requests-badge');
                    const currentCount = parseInt(badge.textContent) || 0;
                    updatePendingBadge(currentCount - 1);
                } else {
                    throw new Error('Failed to approve');
                }
            } catch (error) {
                console.error('Error approving request:', error);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i>';
                alert('Failed to approve request');
            }
        }

        // Quick decline from Discover page
        async function declineRecentRequest(requestId, btn, event) {
            if (event) event.stopPropagation();

            if (!confirm('Are you sure you want to decline this request?')) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken') || localStorage.getItem('portal_token');
                const response = await fetch(`/api/v2/request-site/requests/${requestId}/decline`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    // Update status badge and remove action buttons
                    const card = btn.closest('.recent-request-card');
                    const statusBadge = card.querySelector('.recent-request-status');
                    const actionsDiv = card.querySelector('.recent-request-actions');

                    // Update status badge
                    if (statusBadge) {
                        statusBadge.className = 'recent-request-status declined';
                        statusBadge.textContent = 'Declined';
                    }
                    // Remove action buttons
                    if (actionsDiv) {
                        actionsDiv.remove();
                    }
                    // Update badge count
                    const badge = document.getElementById('pending-requests-badge');
                    const currentCount = parseInt(badge.textContent) || 0;
                    updatePendingBadge(currentCount - 1);
                } else {
                    throw new Error('Failed to decline');
                }
            } catch (error) {
                console.error('Error declining request:', error);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-times"></i>';
                alert('Failed to decline request');
            }
        }

        // Update pending requests badge
        function updatePendingBadge(count) {
            const badge = document.getElementById('pending-requests-badge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.style.display = 'inline-flex';
                } else {
                    badge.style.display = 'none';
                }
            }
            // Also update mobile badge
            updateMobilePendingBadge(count);
        }

        // Load pending requests count (for badge on page load)
        async function loadPendingRequestsCount() {
            try {
                // Use admin token if available, otherwise portal token for users with approval rights
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken') || localStorage.getItem('portal_token');
                const response = await fetch('/api/v2/request-site-api/requests/all', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    // Only count requests user can approve
                    const pendingCount = (data.requests || [])
                        .filter(r => (r.status === 'pending' || r.status === 1) && canUserApproveRequest(r)).length;
                    updatePendingBadge(pendingCount);
                }
            } catch (error) {
                console.error('Failed to load pending count:', error);
            }
        }

        // ============ Recently Added to Plex ============
        async function loadRecentlyAdded() {
            try {
                const response = await fetch('/api/v2/request-site/plex/recently-added?limit=20');

                if (!response.ok) {
                    console.log('Recently added endpoint not available');
                    document.getElementById('recently-added-container').style.display = 'none';
                    return;
                }

                const data = await response.json();
                const items = data.items || [];

                if (items.length === 0) {
                    document.getElementById('recently-added-container').style.display = 'none';
                    return;
                }

                const container = document.getElementById('recently-added-container');
                container.style.display = 'block';

                const slider = document.getElementById('recently-added-slider');

                // Show items with loading placeholder first
                slider.innerHTML = items.map(item => createRecentlyAddedCard(item)).join('');

                // Fetch TMDB details to get poster paths (in background)
                fetchRecentlyAddedPosters(items);
            } catch (error) {
                console.log('Failed to load recently added:', error);
                document.getElementById('recently-added-container').style.display = 'none';
            }
        }

        // Fetch poster paths from TMDB for recently added items
        async function fetchRecentlyAddedPosters(items) {
            // Fetch in parallel batches of 5
            for (let i = 0; i < items.length; i += 5) {
                const batch = items.slice(i, i + 5);
                await Promise.all(batch.map(async (item) => {
                    try {
                        const endpoint = item.media_type === 'tv' ? 'tv' : 'movie';
                        const response = await fetch(`/api/v2/request-site/${endpoint}/${item.tmdb_id}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.poster_path) {
                                const card = document.querySelector(`[data-recently-added-id="${item.tmdb_id}-${item.media_type}"]`);
                                if (card) {
                                    const img = card.querySelector('.media-card-poster');
                                    const placeholder = card.querySelector('.media-card-poster-placeholder');
                                    if (img) {
                                        // Set up load handler before setting src
                                        img.onload = () => {
                                            img.style.opacity = '1';
                                            if (placeholder) placeholder.style.display = 'none';
                                        };
                                        img.src = `https://image.tmdb.org/t/p/w342${data.poster_path}`;
                                    }
                                }
                            }
                        }
                    } catch (e) {
                        // Ignore errors for individual items
                    }
                }));
            }
        }

        function createRecentlyAddedCard(item) {
            const year = item.year || '';
            const mediaType = item.media_type || 'movie';
            const title = item.title || 'Unknown';

            return `
                <div class="media-card" data-recently-added-id="${item.tmdb_id}-${mediaType}" onclick="openMediaModal(${item.tmdb_id}, '${mediaType}')">
                    <div class="media-card-poster-wrap">
                        <img class="media-card-poster" src="" alt="${title}" style="opacity: 0;">
                        <div class="media-card-poster-placeholder loading-placeholder"></div>
                    </div>
                    <span class="media-card-type ${mediaType}">${mediaType === 'tv' ? 'TV' : 'Movie'}</span>
                    <div class="media-card-status available"><i class="fas fa-check"></i></div>
                    <div class="media-card-title">${title}</div>
                    <div class="media-card-year">${year}</div>
                </div>
            `;
        }

        async function loadTrending() {
            try {
                const response = await fetch('/api/v2/request-site/discover?type=all&category=trending&with_original_language=en');
                const data = await response.json();
                renderMediaSlider('trending-slider', data.results);
            } catch (error) {
                console.error('Failed to load trending:', error);
            }
        }

        async function loadPopularMovies() {
            try {
                const response = await fetch('/api/v2/request-site/discover?type=movie&category=popular&with_original_language=en');
                const data = await response.json();
                renderMediaSlider('popular-movies-slider', data.results);
            } catch (error) {
                console.error('Failed to load popular movies:', error);
            }
        }

        async function loadMovieGenres() {
            if (!constants || !constants.movieGenres) return;
            const container = document.getElementById('movie-genres-slider');

            // Show loading placeholders first
            container.innerHTML = constants.movieGenres.map(genre => `
                <div class="genre-card" style="background: #1e293b;">
                    <div class="genre-card-name">${genre.name}</div>
                </div>
            `).join('');

            // Load backdrops for each genre with deduplication
            const usedBackdrops = new Set();
            for (let i = 0; i < constants.movieGenres.length; i++) {
                const genre = constants.movieGenres[i];
                try {
                    const response = await fetch(`/api/v2/request-site/discover/genre/${genre.id}?type=movie&limit=10&with_original_language=en`);
                    const data = await response.json();

                    if (data.results && data.results.length > 0) {
                        // Find first backdrop that hasn't been used yet
                        let backdropUrl = null;
                        for (const result of data.results) {
                            if (result.backdrop_path && !usedBackdrops.has(result.backdrop_path)) {
                                backdropUrl = `https://image.tmdb.org/t/p/w1280${result.backdrop_path}`;
                                usedBackdrops.add(result.backdrop_path);
                                break;
                            }
                        }

                        if (backdropUrl) {
                            const genreCard = container.children[i];
                            genreCard.style.background = `linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.7)), url('${backdropUrl}') center/cover`;
                            genreCard.onclick = () => exploreGenre(genre.id, 'movie', genre.name);
                        }
                    }
                } catch (error) {
                    console.error(`Failed to load backdrop for ${genre.name}:`, error);
                }
            }
        }

        async function loadUpcomingMovies() {
            try {
                const response = await fetch('/api/v2/request-site/discover?type=movie&category=upcoming&with_original_language=en');
                const data = await response.json();
                renderMediaSlider('upcoming-movies-slider', data.results);
            } catch (error) {
                console.error('Failed to load upcoming movies:', error);
            }
        }

        async function loadStudios() {
            if (!constants || !constants.studios) return;
            const container = document.getElementById('studios-slider');

            // Show loading placeholders first with darker text for light background
            container.innerHTML = constants.studios.map(studio => `
                <div class="logo-card" title="${escapeHtml(studio.name)}">
                    <div style="color: #475569; font-size: 14px; font-weight: 500; text-align: center;">${escapeHtml(studio.name)}</div>
                </div>
            `).join('');

            // Try to load logos dynamically from TMDB API
            for (let i = 0; i < constants.studios.length; i++) {
                const studio = constants.studios[i];
                try {
                    const response = await fetch(`https://api.themoviedb.org/3/company/${studio.id}?api_key=431a8708161bcd1f1fbe7536137e61ed`);
                    const data = await response.json();

                    if (data.logo_path) {
                        const logoUrl = `https://image.tmdb.org/t/p/w185${data.logo_path}`;
                        const logoCard = container.children[i];
                        logoCard.innerHTML = `
                            <img class="logo-card-img"
                                 src="${logoUrl}"
                                 alt="${escapeHtml(studio.name)}"
                                 loading="lazy"
                                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'color: #475569; font-size: 14px; font-weight: 500; text-align: center;\\'>${escapeHtml(studio.name)}</div>';">
                        `;
                        logoCard.onclick = () => exploreStudio(studio.id, escapeHtml(studio.name));
                    }
                } catch (error) {
                    console.error(`Failed to load logo for ${studio.name}:`, error);
                }
            }
        }

        async function loadPopularSeries() {
            try {
                const response = await fetch('/api/v2/request-site/discover?type=tv&category=popular&with_original_language=en');
                const data = await response.json();
                renderMediaSlider('popular-series-slider', data.results);
            } catch (error) {
                console.error('Failed to load popular series:', error);
            }
        }

        async function loadSeriesGenres() {
            if (!constants || !constants.tvGenres) return;
            const container = document.getElementById('series-genres-slider');

            // Show loading placeholders first
            container.innerHTML = constants.tvGenres.map(genre => `
                <div class="genre-card" style="background: #1e293b;">
                    <div class="genre-card-name">${genre.name}</div>
                </div>
            `).join('');

            // Load backdrops for each genre with deduplication
            const usedBackdrops = new Set();
            for (let i = 0; i < constants.tvGenres.length; i++) {
                const genre = constants.tvGenres[i];
                try {
                    const response = await fetch(`/api/v2/request-site/discover/genre/${genre.id}?type=tv&limit=10&with_original_language=en`);
                    const data = await response.json();

                    if (data.results && data.results.length > 0) {
                        // Find first backdrop that hasn't been used yet
                        let backdropUrl = null;
                        for (const result of data.results) {
                            if (result.backdrop_path && !usedBackdrops.has(result.backdrop_path)) {
                                backdropUrl = `https://image.tmdb.org/t/p/w1280${result.backdrop_path}`;
                                usedBackdrops.add(result.backdrop_path);
                                break;
                            }
                        }

                        if (backdropUrl) {
                            const genreCard = container.children[i];
                            genreCard.style.background = `linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.7)), url('${backdropUrl}') center/cover`;
                            genreCard.onclick = () => exploreGenre(genre.id, 'tv', genre.name);
                        }
                    }
                } catch (error) {
                    console.error(`Failed to load backdrop for ${genre.name}:`, error);
                }
            }
        }

        async function loadUpcomingSeries() {
            try {
                const response = await fetch('/api/v2/request-site/discover?type=tv&category=upcoming&with_original_language=en');
                const data = await response.json();
                renderMediaSlider('upcoming-series-slider', data.results);
            } catch (error) {
                console.error('Failed to load upcoming series:', error);
            }
        }

        async function loadNetworks() {
            if (!constants || !constants.networks) return;
            const container = document.getElementById('networks-slider');

            // Filter out duplicate networks
            const uniqueNetworks = constants.networks.filter((network, index, self) =>
                index === self.findIndex((n) => n.id === network.id)
            );

            // Show loading placeholders first with darker text for light background
            container.innerHTML = uniqueNetworks.map(network => `
                <div class="logo-card" title="${escapeHtml(network.name)}">
                    <div style="color: #475569; font-size: 14px; font-weight: 500; text-align: center;">${escapeHtml(network.name)}</div>
                </div>
            `).join('');

            // Try to load logos dynamically from TMDB API
            for (let i = 0; i < uniqueNetworks.length; i++) {
                const network = uniqueNetworks[i];
                try {
                    const response = await fetch(`https://api.themoviedb.org/3/network/${network.id}?api_key=431a8708161bcd1f1fbe7536137e61ed`);
                    const data = await response.json();

                    if (data.logo_path) {
                        const logoUrl = `https://image.tmdb.org/t/p/w185${data.logo_path}`;
                        const logoCard = container.children[i];
                        logoCard.innerHTML = `
                            <img class="logo-card-img"
                                 src="${logoUrl}"
                                 alt="${escapeHtml(network.name)}"
                                 loading="lazy"
                                 onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'color: #475569; font-size: 14px; font-weight: 500; text-align: center;\\'>${escapeHtml(network.name)}</div>';">
                        `;
                        logoCard.onclick = () => exploreNetwork(network.id, escapeHtml(network.name));
                    }
                } catch (error) {
                    console.error(`Failed to load logo for ${network.name}:`, error);
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============ Render Functions ============
        function renderMediaSlider(containerId, items) {
            const container = document.getElementById(containerId);
            if (!items || items.length === 0) {
                container.innerHTML = '<div class="request-empty"><p>No content available</p></div>';
                return;
            }

            container.innerHTML = items.map(item => createMediaCard(item)).join('');

            // Check availability for all items after rendering
            checkAndUpdateAvailability(items);
        }

        // Availability cache - stores status by "type-tmdbId"
        const availabilityCache = {};

        function createMediaCard(item) {
            const type = item.media_type || (item.title ? 'movie' : 'tv');
            const title = item.title || item.name;
            const releaseDate = item.release_date || item.first_air_date;
            const year = releaseDate ? releaseDate.substring(0, 4) : '';
            const cacheKey = `${type}-${item.id}`;

            // Check availability from cache
            let statusBadge = '';
            const cached = availabilityCache[cacheKey];
            if (cached) {
                if (cached.status === 4) {
                    // Fully available - green checkmark
                    statusBadge = '<div class="media-card-status available" title="Available"><i class="fas fa-check"></i></div>';
                } else if (cached.status === 3) {
                    // Partially available - green line/minus (for TV shows with some seasons)
                    statusBadge = '<div class="media-card-status partial" title="Partially Available"><i class="fas fa-minus"></i></div>';
                } else if (cached.status === 2) {
                    // Processing
                    statusBadge = '<div class="media-card-status processing" title="Processing"><i class="fas fa-clock"></i></div>';
                } else if (cached.status === 1) {
                    // Pending request
                    statusBadge = '<div class="media-card-status pending" title="Pending Approval"><i class="fas fa-hourglass-half"></i></div>';
                }
            }

            return `
                <div class="media-card" data-tmdb-id="${item.id}" data-type="${type}" onclick="openMediaModal(${item.id}, '${type}')">
                    ${item.poster_path
                        ? `<img class="media-card-poster" src="https://image.tmdb.org/t/p/w500${item.poster_path}" alt="${title}" onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'no-poster\\'><i class=\\'fas fa-film\\'></i></div>' + this.parentElement.innerHTML.replace(this.outerHTML, '');">`
                        : '<div class="no-poster"><i class="fas fa-film"></i></div>'
                    }
                    <span class="media-card-type ${type}">${type === 'movie' ? 'MOVIE' : 'SERIES'}</span>
                    ${statusBadge}
                    <div class="media-card-title">${title}</div>
                    ${year ? `<div class="media-card-year">${year}</div>` : ''}
                </div>
            `;
        }

        // Check availability for multiple items and update their cards
        async function checkAndUpdateAvailability(items) {
            if (!items || items.length === 0) return;

            // Batch the TMDB IDs by type
            const movieIds = [];
            const tvIds = [];

            for (const item of items) {
                const type = item.media_type || (item.title ? 'movie' : 'tv');
                const cacheKey = `${type}-${item.id}`;

                // Skip if already cached
                if (availabilityCache[cacheKey] !== undefined) continue;

                if (type === 'movie') {
                    movieIds.push(item.id);
                } else {
                    tvIds.push(item.id);
                }
            }

            // Fetch availability status for uncached items
            const fetchPromises = [];

            if (movieIds.length > 0) {
                fetchPromises.push(
                    fetch(`/api/v2/request-site/media/batch-status?type=movie&ids=${movieIds.join(',')}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.statuses) {
                                for (const [id, status] of Object.entries(data.statuses)) {
                                    availabilityCache[`movie-${id}`] = { status };
                                }
                            }
                        })
                        .catch(err => console.error('Failed to fetch movie availability:', err))
                );
            }

            if (tvIds.length > 0) {
                fetchPromises.push(
                    fetch(`/api/v2/request-site/media/batch-status?type=tv&ids=${tvIds.join(',')}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.statuses) {
                                for (const [id, status] of Object.entries(data.statuses)) {
                                    availabilityCache[`tv-${id}`] = { status };
                                }
                            }
                        })
                        .catch(err => console.error('Failed to fetch TV availability:', err))
                );
            }

            if (fetchPromises.length > 0) {
                await Promise.all(fetchPromises);

                // Update the DOM for cards that now have availability data
                updateCardStatusBadges();
            }
        }

        // Update status badges on existing cards based on cache
        function updateCardStatusBadges() {
            const cards = document.querySelectorAll('.media-card[data-tmdb-id]');

            for (const card of cards) {
                const tmdbId = card.dataset.tmdbId;
                const type = card.dataset.type;
                const cacheKey = `${type}-${tmdbId}`;
                const cached = availabilityCache[cacheKey];

                if (!cached) continue;

                // Remove existing status badge if any
                const existingBadge = card.querySelector('.media-card-status');
                if (existingBadge) existingBadge.remove();

                // Add new badge based on status
                let badgeHtml = '';
                if (cached.status === 4) {
                    badgeHtml = '<div class="media-card-status available" title="Available"><i class="fas fa-check"></i></div>';
                } else if (cached.status === 3) {
                    badgeHtml = '<div class="media-card-status partial" title="Partially Available"><i class="fas fa-minus"></i></div>';
                } else if (cached.status === 2) {
                    badgeHtml = '<div class="media-card-status processing" title="Processing"><i class="fas fa-clock"></i></div>';
                } else if (cached.status === 1) {
                    badgeHtml = '<div class="media-card-status pending" title="Pending"><i class="fas fa-hourglass-half"></i></div>';
                }

                if (badgeHtml) {
                    card.insertAdjacentHTML('beforeend', badgeHtml);
                }
            }
        }

                // ============ Movie Details Page (Full Page) ============
        async function openMediaModal(id, type, skipHistory = false) {
            // Update browser history
            if (!skipHistory) {
                history.pushState({ view: 'media', id, type }, '', `#${type}/${id}`);
            }

            // Hide discover and browse sections, show movie details page
            document.getElementById('discover-section').style.display = 'none';
            document.getElementById('browse-section').style.display = 'none';
            const detailsPage = document.getElementById('movie-details-page');
            detailsPage.classList.add('show');
            window.scrollTo(0, 0);

            // IMMEDIATELY show loading state and clear previous content
            document.getElementById('details-backdrop').src = '';
            document.getElementById('details-poster').src = '';
            document.getElementById('details-title').textContent = '';
            document.getElementById('details-year').textContent = '';
            document.getElementById('details-status-badges').innerHTML = '';
            document.getElementById('details-attributes').innerHTML = '';
            document.getElementById('details-tagline').style.display = 'none';
            document.getElementById('details-overview').textContent = 'Loading...';
            document.getElementById('details-keywords').style.display = 'none';
            document.getElementById('details-metadata').innerHTML = '';
            document.getElementById('details-external-links').innerHTML = '';
            // Hide sections that have sliders
            document.getElementById('details-cast').style.display = 'none';
            document.getElementById('details-similar').style.display = 'none';
            document.getElementById('details-recommendations').style.display = 'none';
            document.getElementById('details-seasons').style.display = 'none';

            try {
                const response = await fetch(`/api/v2/request-site/${type}/${id}`);
                currentMedia = await response.json();
                currentMedia.mediaType = type;

                const title = currentMedia.title || currentMedia.name;
                const releaseDate = currentMedia.release_date || currentMedia.first_air_date;
                const year = releaseDate ? `(${releaseDate.substring(0, 4)})` : '';

                // Backdrop
                document.getElementById('details-backdrop').src = currentMedia.backdrop_path
                    ? `https://image.tmdb.org/t/p/w1280${currentMedia.backdrop_path}`
                    : '';

                // Poster
                document.getElementById('details-poster').src = currentMedia.poster_path
                    ? `https://image.tmdb.org/t/p/w500${currentMedia.poster_path}`
                    : '';

                // Title and Year
                document.getElementById('details-title').textContent = title;
                document.getElementById('details-year').textContent = year;

                // Check availability status and show badge(s) - supports both regular and 4K
                const statusBadgesEl = document.getElementById('details-status-badges');
                statusBadgesEl.innerHTML = ''; // Clear previous
                try {
                    const statusResponse = await fetch(`/api/v2/request-site/media/${type}/${id}/status`);
                    const statusData = await statusResponse.json();

                    // Also fetch monitoring data for Radarr/Sonarr status (includes both regular and 4K)
                    let monitoringData = null;
                    try {
                        const monitoringResponse = await fetch(`/api/v2/request-site/media/${type}/${id}/monitoring`);
                        monitoringData = await monitoringResponse.json();
                        // Store monitoring data on currentMedia for button logic
                        currentMedia.monitoringData = monitoringData;
                    } catch (e) {
                        console.error('Failed to fetch monitoring data:', e);
                    }

                    const badges = [];

                    // Check regular (non-4K) status from monitoring data first (Radarr/Sonarr cache)
                    if (monitoringData?.regular) {
                        if (monitoringData.regular.status === 'downloaded') {
                            badges.push('<div class="details-availability-badge available"><i class="fas fa-check-circle"></i> Available</div>');
                        } else if (monitoringData.regular.status === 'partial') {
                            badges.push('<div class="details-availability-badge partial"><i class="fas fa-minus-circle"></i> Partially Available</div>');
                        } else if (monitoringData.regular.status === 'processing') {
                            badges.push('<div class="details-availability-badge processing"><i class="fas fa-clock"></i> Processing</div>');
                        }
                    } else if (statusData.status === 4) {
                        badges.push('<div class="details-availability-badge available"><i class="fas fa-check-circle"></i> Available</div>');
                    } else if (statusData.status === 3) {
                        badges.push('<div class="details-availability-badge partial"><i class="fas fa-minus-circle"></i> Partially Available</div>');
                    } else if (statusData.status === 2) {
                        badges.push('<div class="details-availability-badge processing"><i class="fas fa-clock"></i> Processing</div>');
                    } else if (statusData.status === 1) {
                        badges.push('<div class="details-availability-badge requested"><i class="fas fa-hourglass-half"></i> Requested</div>');
                    }
                    // FALLBACK: Check request record status if no other badge was added
                    // This handles the case where request is approved but arr-library-sync hasn't run yet
                    else if (currentMedia.request) {
                        const reqStatus = currentMedia.request.status?.toLowerCase();
                        if (reqStatus === 'available') {
                            badges.push('<div class="details-availability-badge available"><i class="fas fa-check-circle"></i> Available</div>');
                        } else if (reqStatus === 'processing') {
                            badges.push('<div class="details-availability-badge processing"><i class="fas fa-clock"></i> Processing</div>');
                        } else if (reqStatus === 'approved') {
                            badges.push('<div class="details-availability-badge processing"><i class="fas fa-download"></i> Downloading</div>');
                        } else if (reqStatus === 'pending') {
                            badges.push('<div class="details-availability-badge requested"><i class="fas fa-hourglass-half"></i> Pending</div>');
                        }
                    }

                    // Check 4K status separately - show additional badge if on 4K server
                    if (monitoringData?.fourK) {
                        if (monitoringData.fourK.status === 'downloaded') {
                            badges.push('<div class="details-availability-badge available fourk"><i class="fas fa-check-circle"></i> 4K Available</div>');
                        } else if (monitoringData.fourK.status === 'partial') {
                            badges.push('<div class="details-availability-badge partial fourk"><i class="fas fa-minus-circle"></i> 4K Partial</div>');
                        } else if (monitoringData.fourK.status === 'processing') {
                            badges.push(`<div class="details-availability-badge processing fourk"><i class="fas fa-clock"></i> Processing 4K</div>`);
                        }
                    }

                    statusBadgesEl.innerHTML = badges.join('');

                    // Set cache status (use the "best" status for button logic)
                    if (monitoringData?.regular?.status === 'downloaded' || monitoringData?.fourK?.status === 'downloaded') {
                        availabilityCache[`${type}-${id}`] = { status: 4 };
                    } else if (monitoringData?.regular?.status === 'partial' || monitoringData?.fourK?.status === 'partial') {
                        availabilityCache[`${type}-${id}`] = { status: 3 };
                    } else if (monitoringData?.regular?.status === 'processing') {
                        availabilityCache[`${type}-${id}`] = { status: 2 };
                    } else {
                        availabilityCache[`${type}-${id}`] = { status: statusData.status };
                    }
                } catch (err) {
                    console.error('Failed to check availability:', err);
                }

                // Attributes (runtime, rating, genres)
                const attributes = [];
                if (currentMedia.runtime) {
                    const hours = Math.floor(currentMedia.runtime / 60);
                    const mins = currentMedia.runtime % 60;
                    attributes.push(`<span><i class="fas fa-clock"></i> ${hours}h ${mins}m</span>`);
                }
                if (currentMedia.number_of_seasons) {
                    attributes.push(`<span><i class="fas fa-tv"></i> ${currentMedia.number_of_seasons} Season${currentMedia.number_of_seasons > 1 ? 's' : ''}</span>`);
                }
                // Content Rating (Certification) - TODO: fetch from backend release_dates/content_ratings API
                // For now, using placeholder - will need TMDB API call to /movie/{id}/release_dates or /tv/{id}/content_ratings
                const certification = 'PG-13'; // Placeholder - would come from API
                if (certification) {
                    attributes.push(`<span style="background: rgba(100, 116, 139, 0.3); padding: 2px 8px; border-radius: 4px; font-weight: 600;">${certification}</span>`);
                }
                if (currentMedia.genres && currentMedia.genres.length > 0) {
                    currentMedia.genres.forEach(g => {
                        attributes.push(`<span class="media-detail-genre" onclick="exploreGenre(${g.id}, '${type}', '${g.name.replace(/'/g, "\\'")}')" style="cursor: pointer;">${g.name}</span>`);
                    });
                }
                document.getElementById('details-attributes').innerHTML = attributes.join('');

                // Tagline (if exists)
                const taglineEl = document.getElementById('details-tagline');
                if (currentMedia.tagline) {
                    taglineEl.textContent = currentMedia.tagline;
                    taglineEl.style.display = 'block';
                } else {
                    taglineEl.style.display = 'none';
                }

                // Overview
                document.getElementById('details-overview').textContent = currentMedia.overview || 'No description available.';

                // Keywords Section
                const keywordsEl = document.getElementById('details-keywords');
                const keywordsList = document.getElementById('details-keywords-list');
                if (currentMedia.keywords) {
                    const keywords = type === 'movie' ? currentMedia.keywords.keywords : currentMedia.keywords.results;
                    if (keywords && keywords.length > 0) {
                        keywordsList.innerHTML = keywords.slice(0, 20).map(keyword => `
                            <span class="keyword-tag" onclick="searchKeyword('${keyword.name.replace(/'/g, "\\'")}')">
                                <i class="fas fa-tag"></i>${keyword.name}
                            </span>
                        `).join('');
                        keywordsEl.style.display = 'block';
                    } else {
                        keywordsEl.style.display = 'none';
                    }
                } else {
                    keywordsEl.style.display = 'none';
                }

                // Metadata Sidebar
                const metadataEl = document.getElementById('details-metadata');
                const metadataRows = [];

                // Status
                if (currentMedia.status) {
                    metadataRows.push(`
                        <div class="metadata-row">
                            <span class="metadata-label">Status</span>
                            <span class="metadata-value">${currentMedia.status}</span>
                        </div>
                    `);
                }

                // Release Date
                if (releaseDate) {
                    const formattedDate = new Date(releaseDate).toLocaleDateString('en-US', {
                        month: 'long',
                        day: 'numeric',
                        year: 'numeric'
                    });
                    metadataRows.push(`
                        <div class="metadata-row">
                            <span class="metadata-label">${type === 'movie' ? 'Release Date' : 'First Air Date'}</span>
                            <span class="metadata-value">${formattedDate}</span>
                        </div>
                    `);
                }

                // Revenue (movies only)
                if (type === 'movie' && currentMedia.revenue && currentMedia.revenue > 0) {
                    const revenue = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 0
                    }).format(currentMedia.revenue);
                    metadataRows.push(`
                        <div class="metadata-row">
                            <span class="metadata-label">Revenue</span>
                            <span class="metadata-value metadata-value-green">${revenue}</span>
                        </div>
                    `);
                }

                // Budget (movies only)
                if (type === 'movie' && currentMedia.budget && currentMedia.budget > 0) {
                    const budget = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 0
                    }).format(currentMedia.budget);
                    metadataRows.push(`
                        <div class="metadata-row">
                            <span class="metadata-label">Budget</span>
                            <span class="metadata-value">${budget}</span>
                        </div>
                    `);
                }

                // Original Language
                if (currentMedia.original_language) {
                    const langMap = { 'en': 'English', 'es': 'Spanish', 'fr': 'French', 'de': 'German', 'it': 'Italian', 'ja': 'Japanese', 'ko': 'Korean', 'zh': 'Chinese', 'pt': 'Portuguese', 'ru': 'Russian' };
                    const language = langMap[currentMedia.original_language] || currentMedia.original_language.toUpperCase();
                    metadataRows.push(`
                        <div class="metadata-row">
                            <span class="metadata-label">Original Language</span>
                            <span class="metadata-value">${language}</span>
                        </div>
                    `);
                }

                // Production Country
                if (currentMedia.production_countries && currentMedia.production_countries.length > 0) {
                    const country = currentMedia.production_countries[0].name;
                    metadataRows.push(`
                        <div class="metadata-row">
                            <span class="metadata-label">Country</span>
                            <span class="metadata-value">${country}</span>
                        </div>
                    `);
                }

                // Studios/Networks
                if (currentMedia.production_companies && currentMedia.production_companies.length > 0) {
                    const companies = currentMedia.production_companies.slice(0, 3).map(c => c.name).join(', ');
                    metadataRows.push(`
                        <div class="metadata-row">
                            <span class="metadata-label">${type === 'movie' ? 'Studio' : 'Network'}</span>
                            <span class="metadata-value">${companies}</span>
                        </div>
                    `);
                }

                // Build Ratings Badges HTML (above status in metadata card)
                // Fetch REAL ratings from backend API (matches Seerr implementation)
                let ratingsBadgesHTML = '<div class="ratings-badges-row" id="details-ratings-badges"><div style="color: #64748b; font-size: 12px;">Loading ratings...</div></div>';

                // Combine ratings badges placeholder with metadata rows
                metadataEl.innerHTML = ratingsBadgesHTML + metadataRows.join('');

                // Fetch ratings asynchronously for both movies and TV shows
                fetchAndDisplayRatings(currentMedia.id, type);

                // External Links (icon buttons)
                const externalLinksEl = document.getElementById('details-external-links');
                const links = [];

                // Plex Link (placeholder for library search) - Using exact Seerr Plex SVG
                links.push(`
                    <a href="#" onclick="alert('Plex integration coming soon'); return false;" class="external-link plex" title="View on Plex">
                        <svg width="28" height="28" viewBox="0 0 361 157" xmlns="http://www.w3.org/2000/svg">
                            <defs><style>.cls-1{fill:#fff;}.cls-2{fill:#eaaf20;}</style></defs>
                            <g><g id="Layer_1"><path id="path4" class="cls-1" d="M60.6,28.8c-14.3,0-23.5,3.9-31.3,13v-10H1.6v123.7s.5.2,1.9.5c1.9.5,12.1,2.5,19.6-3.4,6.5-5.3,8-11.4,8-18.3v-17.8c8,8,17,11.4,29.6,11.4,27.2,0,48-20.8,48-48.4s-20.1-50.7-48.3-50.7h0ZM55.2,104.3c-15.3,0-27.4-11.9-27.4-26.3s14.3-25.6,27.4-25.6,27.4,11.2,27.4,25.8-12.1,26-27.4,26Z"/><path id="path6" class="cls-1" d="M148.1,76.5c0,10.7,1.2,23.7,12.4,37.9.2.2.7.9.7.9-4.6,7.3-10.2,12.3-17.7,12.3s-11.6-3-16.5-8c-5.1-5.5-7.5-12.6-7.5-20.1V.9h28.4l.2,75.6Z"/><polygon id="polygon8" class="cls-2" points="287.6 78.3 254.1 31.7 288.6 31.7 321.8 78.3 288.6 124.6 254.1 124.6 287.6 78.3"/><polygon id="polygon10" class="cls-1" points="330.8 73 360.6 31.7 326.2 31.7 313.8 48.9 330.8 73"/><path id="path12" class="cls-1" d="M313.8,107.7l5.8,7.5c5.6,8.2,12.9,12.3,21.3,12.3,9-.2,15.3-7.5,17.7-10.3,0,0-4.4-3.7-9.9-9.8-7.5-8.2-17.5-23.3-17.7-24l-17.2,24.2Z"/><path id="path16" class="cls-1" d="M228.7,97.9c-5.8,5-9.7,7.8-17.7,7.8-14.3,0-22.6-9.6-23.8-20.1h75.9c.5-1.4.7-3.2.7-6.2,0-29-22.6-50.7-52.2-50.7s-51.2,22.1-51.2,49.8,23,49.1,51.9,49.1,37.6-10.7,47.1-29.7h-30.8ZM211.9,50.7c12.6,0,22.1,7.8,24.3,18h-48c2.4-10.7,11.4-18,23.8-18h0Z"/></g></g>
                        </svg>
                    </a>
                `);

                // TMDB Link
                links.push(`
                    <a href="https://www.themoviedb.org/${type}/${currentMedia.id}" target="_blank" class="external-link tmdb" title="View on TMDB">
                        <img src="https://www.themoviedb.org/assets/2/v4/logos/v2/blue_square_2-d537fb228cf3ded904ef09b136fe3fec72548ebc1fea3fbbd1ad9e36364db38b.svg" alt="TMDB">
                    </a>
                `);

                // IMDB Link (if available)
                if (currentMedia.external_ids?.imdb_id) {
                    links.push(`
                        <a href="https://www.imdb.com/title/${currentMedia.external_ids.imdb_id}" target="_blank" class="external-link imdb" title="View on IMDb">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/6/69/IMDB_Logo_2016.svg" alt="IMDb">
                        </a>
                    `);
                }

                // Rotten Tomatoes Link - Using exact Seerr RT SVG
                const rtUrl = `https://www.rottentomatoes.com/search?search=${encodeURIComponent(currentMedia.title || currentMedia.name)}`;
                links.push(`
                    <a href="${rtUrl}" target="_blank" rel="noopener noreferrer" class="external-link rt" title="View on Rotten Tomatoes">
                        <svg width="28" height="28" viewBox="0 0 691 197" xmlns="http://www.w3.org/2000/svg"><g fill="#F93208"><path d="M104.8 101.98l-8.017-.104V.638h24.186c26.088 0 28.29.125 34.659 1.973 10.334 2.998 18.223 9.496 22.57 18.591 2.114 4.422 2.942 7.959 3.16 13.486.49 12.49-4.809 23.35-14.189 29.082-2.81 1.717-2.94 1.853-2.482 2.58 1.234 1.961 20.736 35.548 20.736 35.713 0 .102-7.443.186-16.54.186h-16.538l-9.6-16.167c-5.28-8.892-9.803-16.445-10.051-16.784-.336-.46-1.193-.668-3.358-.817l-2.906-.199.182 16.983.181 16.983-6.988-.083c-3.843-.045-10.596-.13-15.005-.187v.002zm35.703-56.479c6.767-1.424 10.228-4.667 10.607-9.938.265-3.687-.611-6.202-2.954-8.482-3.104-3.023-7.437-4.07-16.926-4.092l-5.008-.01.234 3.298c.129 1.814.234 7.108.234 11.766v8.467l5.675-.245c3.122-.135 6.784-.479 8.138-.764z"/><path d="M217.68 103.68c-8.925-1.007-16.797-4.98-23.157-11.686-7.223-7.617-11.109-16.992-11.521-27.797-.221-5.788.216-9.62 1.598-14 5.206-16.508 19.973-26.343 40.714-27.116 3.541-.132 6.66-.043 8.828.25 17.8 2.417 30.89 14.82 34.788 32.96.824 3.837.816 12.629-.014 16.27-3.436 15.074-14.036 25.494-29.983 29.476-6.315 1.577-15.528 2.289-21.255 1.642l.002.001zm9.79-12.053c3.497-1.039 4.937-2.945 4.899-6.487-.013-1.189-.284-2.85-.603-3.693-1.675-4.433-1.661-4.376-1.255-5.267.218-.478.788-1.048 1.267-1.266 1.155-.526 1.845-.073 3.406 2.238 2.216 3.28 6.208 7.01 8.8 8.224 2.078.972 2.662 1.089 4.843.965 2.166-.122 2.733-.314 4.474-1.513 2.286-1.574 2.901-2.856 2.88-5.996-.022-3.146-1.654-5.743-4.899-7.795-1.985-1.256-6.21-2.548-9.285-2.84-3.92-.373-5.304-1.012-5.804-2.684-.487-1.625.025-2.958 1.578-4.107.791-.586 1.76-.783 4.684-.954 2.354-.137 4.09-.429 4.804-.807 5.106-2.702 5.438-11.468.563-14.856-1.364-.948-1.868-1.084-3.964-1.072-4.827.027-8.092 3.187-9.632 9.326-.125.496-.608 1.313-1.075 1.816-.986 1.064-2.84 1.226-4.458.39-1.63-.844-1.84-2.694-.901-7.985 1.167-6.583.533-9.34-2.563-11.154-1.971-1.155-5.475-1.56-7.557-.873-1.836.606-4.227 3.061-4.778 4.905-1.11 3.718-.23 6.074 3.888 10.396 1.73 1.816 3.25 3.635 3.38 4.042.59 1.861-1.654 3.997-3.723 3.543-1.18-.26-2.303-1.403-4.129-4.207-2.934-4.507-7.032-5.946-11.069-3.886-3.473 1.772-4.372 5.775-2.066 9.197 1.338 1.986 3.74 3.31 7.44 4.1 5.358 1.145 6.867 2.308 5.405 4.166-.758.964-.83.98-3.325.708-3.765-.409-5.224-.258-7.315.757-2.18 1.058-3.13 2.228-3.723 4.584-1.19 4.725 2.14 8.911 7.07 8.89 2.596-.012 4.567-1.084 7.862-4.274 3.64-3.525 4.29-3.897 5.465-3.127 1.286.843 1.447 2.092.566 4.395-2.004 5.236-.155 10.68 4.15 12.214 1.804.643 2.5.641 4.7-.012v-.001zm82.26 10.613c-13.527-.865-20.855-4.63-24.882-12.779-2.793-5.653-3.454-10.408-3.796-27.295l-.231-11.44h-1.89c-1.04 0-2.643-.103-3.562-.23l-1.672-.228V25.504h7.567V3.884h29.546v21.62h12.251v25.584H310.81l.001 11.44c.001 10.71.046 11.514.705 12.594 1.23 2.017 2.192 2.27 8.644 2.27h5.783v25.221l-6.035-.054c-3.32-.03-7.9-.173-10.179-.318l.001-.001zm54.85-.37c-15.629-1.51-22.78-7.814-25.148-22.169-.42-2.541-.655-7.163-.82-16.06-.127-6.87-.366-12.627-.531-12.791-.165-.165-1.827-.356-3.694-.425l-3.393-.124V25.147h8.013l-.266-10.81-.266-10.81h29.632v21.98h12.251v25.222H368.07l.108 11.62c.099 10.534.17 11.71.765 12.586 1.407 2.073 2.088 2.266 8.442 2.398l5.855.12v24.8l-7.837-.048c-4.31-.027-9.18-.18-10.823-.338v.003zm59.82-15.484c-12.392-1.561-23.904-7.774-29.557-15.952-5.345-7.732-8.064-16.437-8.07-25.834-.008-13.574 5.91-24.516 17.388-32.154 7.19-4.784 12.745-6.35 23.58-6.65 5.522-.152 6.994-.074 9.91.529 5.732 1.185 10.724 3.54 14.889 7.024 3.71 3.104 7.857 9.221 9.949 14.676 2.507 6.539 3.926 17.032 3.034 22.43l-.224 1.351h-26.076c-14.342 0-26.076.137-26.076.305 0 .167.623 1.267 1.383 2.444 3.325 5.144 8.623 7.708 15.898 7.695 5.447-.01 10.592-1.443 14.27-3.973l1.48-1.019 8.257 7.755a4956.96 4956.96 0 0 1 8.742 8.222c.752.723.057 1.652-3.155 4.222-4.948 3.96-11.022 6.685-18.337 8.23-4.039.853-13.138 1.22-17.284.698l-.001.001zm15.261-50.147c-.597-3.732-2.794-6.524-6.497-8.257-4.053-1.897-9.342-1.732-13.564.422-2.864 1.46-5.53 4.875-6.237 7.985l-.222.976 2.976.122c1.637.067 7.659.154 13.381.195l10.405.073-.242-1.516zm32.579 27.459V24.783h29.186v5.405c0 2.973.122 5.404.27 5.402.149 0 1.081-.988 2.072-2.192 3.332-4.05 8.5-7.667 13.356-9.348 15.184-5.257 31.395 6.568 33.65 24.545.23 1.846.377 12.826.377 28.336v25.322h-29.546v-45.98l-.956-1.92c-1.574-3.157-4.716-4.998-8.593-5.033-4.357-.039-7.609 2.62-9.305 7.61-.746 2.196-.773 2.913-.885 23.974l-.115 21.71h-29.51V63.699l-.001-.001zm10.48 130.792c-8.788-1.23-17.227-5.075-22.84-10.407-6.942-6.595-11.058-16.86-11.058-27.579 0-11.183 5.073-21.063 14.659-28.549 1.667-1.302 2.971-2.426 2.898-2.498-.072-.073-2.839.052-6.147.278-3.308.226-6.11.316-6.225.2-.355-.355 1.922-3.364 3.48-4.598 3.19-2.526 7.199-3.42 11.017-2.46 2.864.722 2.76.012-.53-3.59l-2.936-3.218 1.948-1.665c1.072-.915 2.027-1.664 2.122-1.664.095 0 1.345 1.867 2.778 4.149s2.738 4.23 2.9 4.33c.16.1.881-.706 1.602-1.791 3.104-4.677 7.504-6.781 11.726-5.609 2.828.786 2.828.95.009 4.474-1.401 1.752-2.548 3.213-2.548 3.248 0 .035 2.897-.005 6.438-.089 12.435-.293 20.725 1.609 27.681 6.351 2.383 1.624 5.892 5.185 7.65 7.763 1.36 1.992 5.074 9.644 5.943 12.24 1.872 5.603 2.154 15.51.606 21.324-1.093 4.105-3.901 9.586-6.676 13.032-6.267 7.783-16.447 13.536-27.95 15.794-3.569.7-13.148 1.01-16.548.534h.001zm94.74 1.06c-7.835-.993-14.881-3.57-21.428-7.837-7.49-4.881-13.128-13.98-15.556-25.105-.785-3.595-1.041-10.974-.508-14.619 1.861-12.729 9.63-22.96 22.28-29.339 2.397-1.209 4.443-1.904 7.706-2.617 4.038-.883 5.132-.972 12.01-.973 6.762 0 7.893.087 10.63.826 12.802 3.455 21.615 13.546 24.914 28.527.692 3.142.834 4.852.841 10.089l.008 6.305-26.206.18-26.206.18 1.103 1.931c3.137 5.493 8.726 8.339 16.375 8.339 5.387 0 11.187-1.673 14.461-4.17l1.178-.898 8.854 8.356 8.854 8.356-1.369 1.41c-7.941 8.184-23.91 12.838-37.942 11.06l.001-.001zm15.344-49.787c-.772-4.894-4.58-8.372-10.226-9.34-7.301-1.252-14.551 3.02-16.122 9.502-.235.97-.23.973 2.05 1.102 1.258.07 7.294.16 13.414.198l11.126.07-.242-1.532zm55.816 50.167c-4.146-.47-9.524-1.676-13.109-2.941-5.022-1.772-12.654-5.866-12.654-6.787 0-.3 10.534-18.822 11.044-19.42.071-.084 2.358.992 5.082 2.39 7.474 3.837 10.895 4.86 16.123 4.82 4.207-.033 6.906-.753 8.198-2.187 1.801-2 .976-4.904-1.627-5.729-.641-.203-3.68-.355-6.75-.337-3.905.022-6.358-.14-8.15-.543-10.216-2.29-18.196-8.883-21.45-17.724-.648-1.757-.8-2.961-.822-6.482l-.026-4.324 1.55-3.242c4.486-9.385 13.202-16.08 23.78-18.263 2.902-.6 4.445-.694 9.08-.559 6.014.176 9.605.82 15.15 2.717 5.699 1.95 13.459 5.599 13.42 6.312-.008.163-2.262 4.098-5.008 8.744-3.833 6.486-5.12 8.391-5.54 8.204-2.02-.9-11.14-3.8-13.518-4.3-1.586-.333-4.511-.626-6.501-.65-3.841-.047-4.94.31-6.373 2.073-.98 1.206-.833 3.52.29 4.576.892.838 1.163.878 6.577.973 13.405.235 21.78 3.14 27.71 9.613 3.54 3.862 5.384 8.272 5.743 13.73.511 7.753-2.25 14.496-8.28 20.224-4.138 3.93-5.794 4.937-11.207 6.813-5.89 2.041-15.988 3.062-22.733 2.298l.001.001zm-222.06-2.5c-3.115-.15-8.503-.882-10.832-1.473-10.841-2.75-16.058-8.96-18.094-21.535-.278-1.718-.477-6.2-.685-15.446l-.293-13.025-1.673-.158a47.682 47.682 0 0 0-3.647-.16l-1.975-.002v-25.224h7.878l-.122-9.108c-.068-5.01-.17-9.883-.23-10.828l-.107-1.72h29.78v21.912h12.23v25.478h-12.23l.002 10.892c0 6.814.101 11.252.269 11.855.332 1.197 1.622 2.697 2.711 3.152.61.254 2.32.344 6.565.344h5.74v25.224l-6.815-.049c-3.749-.027-7.56-.085-8.472-.129zm-100.01 2.48c-6.068-.899-12.181-4.26-18.039-9.92-3.615-3.492-5.672-6.254-7.7-10.338-3.03-6.103-4.177-10.835-4.387-18.104-.2-6.972.594-12.343 2.752-18.6 2.233-6.477 4.445-10.212 8.365-14.125 8.465-8.451 18.63-11.802 28.321-9.337 5.607 1.426 10.185 4.096 15.083 8.798l2.23 2.14v-9.5h27.772v76.946h-27.772v-4.84c0-2.663-.075-4.842-.167-4.842-.091 0-1.22 1.06-2.509 2.357-7.064 7.107-15.892 10.559-23.95 9.366l.001-.001zm17.685-28.317c5.786-2.845 9.1-11.159 6.994-17.547-1.157-3.512-4.26-6.42-8.273-7.753-3.876-1.286-6.61-1.145-10.106.524-4.513 2.154-7.192 6.602-7.192 11.943 0 3.888 1.271 7.003 3.95 9.682 4.024 4.024 10.164 5.347 14.627 3.152v-.001zM259.84 188.73c-.092-2.965-.179-11.364-.192-18.663-.013-7.3-.1-15.45-.192-18.113-.19-5.502-.425-6.309-2.411-8.306-2.323-2.336-6.327-3.183-9.46-2.001-2.747 1.036-4.837 3.8-5.47 7.233-.187 1.017-.278 8.578-.278 23.122v21.61h-14.778c-8.128 0-14.801-.03-14.829-.064-.028-.035-.114-10.383-.191-22.995l-.14-22.931-.866-1.597c-.997-1.838-2.242-3.055-4.157-4.062-1.198-.63-1.614-.708-3.767-.709-2.035 0-2.595.093-3.514.583-2.416 1.288-4.24 4.048-5.087 7.696-.406 1.753-.435 3.667-.35 23.122l.092 21.21h-29.53l-.17-22.972c-.092-12.635-.169-30.12-.169-38.855v-15.882h29.286l.071 3.627c.06 3.107.13 3.64.484 3.707.243.047 1.341-.84 2.675-2.162 2.7-2.676 5.053-4.087 9.126-5.475 11.078-3.774 22.042-1.153 30.246 7.23l2.203 2.251.692-1.181c3.247-5.54 12.361-9.526 21.781-9.526 7.805 0 14.775 2.657 19.708 7.512 5.118 5.037 8.184 12.777 8.68 21.916.077 1.401.205 13.239.286 26.307l.146 23.759h-29.758l-.168-5.392.001.001zm-153.06 6.29c-6.093-.998-10.52-2.705-15.396-5.935-11.61-7.69-18.797-22.407-18.135-37.134.81-18.046 12.392-31.634 30.62-35.927 7.981-1.88 17.076-2.158 24.066-.737 12.231 2.488 22.77 10.864 28.179 22.395 5.266 11.228 5.435 24.038.458 34.76-5.597 12.056-17.13 19.866-32.956 22.316-3.758.582-13.917.74-16.834.262h-.002zm13.14-27.525c4.448-.934 8.12-3.694 10.055-7.56 1-1.998 1.029-2.126 1.025-4.637-.004-3.002-.47-5.242-1.543-7.42-3.681-7.48-12.83-10.42-20.566-6.612-3.791 1.866-7.05 6.222-7.762 10.373-1.12 6.54 3.808 14.306 10.256 16.163 1.4.403 5.928.24 8.536-.307h-.001z"/><path d="M27.559 157.18v-36.689H.807V91.889l40.448.188c22.246.104 40.534.24 40.639.303.105.063.191 6.356.191 13.985v13.87H56.097v73.635H27.561v-36.69h-.002z"/></g></svg>
                    </a>
                `);

                // Trakt Link - Using exact Seerr Trakt SVG
                const traktId = currentMedia.external_ids?.imdb_id || currentMedia.id;
                links.push(`
                    <a href="https://trakt.tv/${type === 'movie' ? 'movies' : 'shows'}/${traktId}" target="_blank" class="external-link trakt" title="View on Trakt">
                        <svg width="28" height="28" viewBox="0 0 144.8 144.8" xmlns="http://www.w3.org/2000/svg"><circle cx="72.4" cy="72.4" r="72.4" fill="#fff"/><path d="M29.5,111.8c10.6,11.6,25.9,18.8,42.9,18.8c8.7,0,16.9-1.9,24.3-5.3L56.3,85L29.5,111.8z" fill="#ED2224"/><path d="m56.1 60.6l-30.6 30.5-4.1-4.1 32.2-32.2 37.6-37.6c-5.9-2-12.2-3.1-18.8-3.1-32.2 0-58.3 26.1-58.3 58.3 0 13.1 4.3 25.2 11.7 35l30.5-30.5 2.1 2 43.7 43.7c0.9-0.5 1.7-1 2.5-1.6l-48.3-48.3-29.3 29.3-4.1-4.1 33.4-33.4 2.1 2 51 50.9c0.8-0.6 1.5-1.3 2.2-1.9l-55-55-0.5 0.1z" fill="#ED2224"/><path d="m115.7 111.4c9.3-10.3 15-24 15-39 0-23.4-13.8-43.5-33.6-52.8l-36.7 36.6 55.3 55.2zm-41.2-44.6l-4.1-4.1 28.9-28.9 4.1 4.1-28.9 28.9zm27.4-39.7l-33.3 33.3-4.1-4.1 33.3-33.3 4.1 4.1z" fill="#ED1C24"/><path d="m72.4 144.8c-39.9 0-72.4-32.5-72.4-72.4s32.5-72.4 72.4-72.4 72.4 32.5 72.4 72.4-32.5 72.4-72.4 72.4zm0-137.5c-35.9 0-65.1 29.2-65.1 65.1s29.2 65.1 65.1 65.1 65.1-29.2 65.1-65.1-29.2-65.1-65.1-65.1z" fill="#ED2224"/></svg>
                    </a>
                `);

                externalLinksEl.innerHTML = `<div class="external-links-row">${links.join('')}</div>`;

                // Seasons for TV shows
                if (type === 'tv' && currentMedia.seasons) {
                    const seasonList = document.getElementById('details-season-list');

                    // Fetch season availability
                    let seasonAvailability = {};
                    try {
                        const seasonResponse = await fetch(`/api/v2/request-site/tv/${id}/seasons/availability`);
                        const seasonData = await seasonResponse.json();
                        seasonAvailability = seasonData.seasons || {};
                    } catch (err) {
                        console.error('Failed to fetch season availability:', err);
                    }

                    seasonList.innerHTML = currentMedia.seasons
                        .filter(s => s.season_number > 0 && s.episode_count > 0)
                        .map((season, index) => {
                            const seasonStatus = seasonAvailability[season.season_number] || 0;
                            let availabilityBadge = '';
                            if (seasonStatus === 4) {
                                availabilityBadge = '<span class="season-availability available"><i class="fas fa-check"></i> On Plex</span>';
                            } else if (seasonStatus === 3) {
                                availabilityBadge = '<span class="season-availability partial"><i class="fas fa-adjust"></i> Partial</span>';
                            }
                            return `
                            <div class="season-item" data-season="${season.season_number}">
                                <div class="season-header" onclick="toggleSeason(${season.season_number}, ${currentMedia.id})">
                                    <div class="season-header-left">
                                        <span class="season-title">Season ${season.season_number}</span>
                                        <span class="season-episode-count">${season.episode_count} Episode${season.episode_count > 1 ? 's' : ''}</span>
                                        ${availabilityBadge}
                                    </div>
                                    <i class="fas fa-chevron-down season-chevron"></i>
                                </div>
                                <div class="season-content" id="season-content-${season.season_number}">
                                    <div class="season-loading">
                                        <i class="fas fa-spinner fa-spin"></i> Loading episodes...
                                    </div>
                                </div>
                            </div>
                        `}).join('');
                    document.getElementById('details-seasons').style.display = 'block';
                }

                // Collection Button (for movies that belong to a collection) - Matches Seerr exactly
                const collectionBtnEl = document.getElementById('details-collection-button');
                if (currentMedia.belongs_to_collection) {
                    const collection = currentMedia.belongs_to_collection;
                    // Use backdrop_path first, fallback to poster_path, then movie's backdrop
                    const collectionImage = collection.backdrop_path || collection.poster_path || currentMedia.backdrop_path;
                    collectionBtnEl.innerHTML = `
                        <div class="collection-card" onclick="exploreCollection(${collection.id}, '${collection.name.replace(/'/g, "\\'")}')">
                            ${collectionImage ? `
                                <div class="collection-card-backdrop">
                                    <img src="https://image.tmdb.org/t/p/w1280${collectionImage}" alt="${collection.name}">
                                </div>
                                <div class="collection-card-overlay"></div>
                            ` : ''}
                            <div class="collection-card-content">
                                <div class="collection-card-name">${collection.name}</div>
                                <button class="collection-card-view-btn" onclick="event.stopPropagation();">
                                    View
                                </button>
                            </div>
                        </div>
                    `;
                    collectionBtnEl.style.display = 'block';
                } else {
                    collectionBtnEl.style.display = 'none';
                }

                // Cast Section
                const castEl = document.getElementById('details-cast');
                const castSlider = document.getElementById('details-cast-slider');
                if (currentMedia.credits && currentMedia.credits.cast && currentMedia.credits.cast.length > 0) {
                    const cast = currentMedia.credits.cast.slice(0, 20); // Show top 20 cast members
                    castSlider.innerHTML = cast.map(person => `
                        <div class="cast-card">
                            ${person.profile_path
                                ? `<img class="cast-card-image" src="https://image.tmdb.org/t/p/w185${person.profile_path}" alt="${person.name}">`
                                : '<div class="cast-card-image" style="display: flex; align-items: center; justify-content: center; background: #1e293b; color: #64748b;"><i class="fas fa-user" style="font-size: 48px;"></i></div>'
                            }
                            <div class="cast-card-info">
                                <div class="cast-card-name">${person.name}</div>
                                <div class="cast-card-character">${person.character || 'Unknown Role'}</div>
                            </div>
                        </div>
                    `).join('');
                    castEl.style.display = 'block';
                } else {
                    castEl.style.display = 'none';
                }

                // Inline Crew Section (Grid display like Seerr)
                const crewInlineEl = document.getElementById('details-crew-inline');
                if (currentMedia.credits && currentMedia.credits.crew && currentMedia.credits.crew.length > 0) {
                    const crew = currentMedia.credits.crew;

                    // Collect all crew members with their jobs
                    const crewItems = [];

                    // Add directors
                    crew.filter(p => p.job === 'Director').forEach(p => {
                        crewItems.push({ job: 'Director', name: p.name });
                    });

                    // Add screenplay/writers
                    crew.filter(p => p.job === 'Screenplay' || p.job === 'Writer').forEach(p => {
                        crewItems.push({ job: 'Screenplay', name: p.name });
                    });

                    // Add editors
                    crew.filter(p => p.job === 'Editor').forEach(p => {
                        crewItems.push({ job: 'Editor', name: p.name });
                    });

                    // Add producers (limit to 3)
                    crew.filter(p => p.job === 'Producer').slice(0, 3).forEach(p => {
                        crewItems.push({ job: 'Producer', name: p.name });
                    });

                    // Add executive producers (limit to 2)
                    crew.filter(p => p.job === 'Executive Producer').slice(0, 2).forEach(p => {
                        crewItems.push({ job: 'Executive Producer', name: p.name });
                    });

                    // Add DP
                    crew.filter(p => p.job === 'Director of Photography').forEach(p => {
                        crewItems.push({ job: 'Director of Photography', name: p.name });
                    });

                    // Add composer
                    crew.filter(p => p.job === 'Original Music Composer').forEach(p => {
                        crewItems.push({ job: 'Composer', name: p.name });
                    });

                    if (crewItems.length > 0) {
                        const gridItems = crewItems.slice(0, 6).map(item => `
                            <div class="crew-grid-item">
                                <span class="crew-grid-label">${item.job}</span>
                                <span class="crew-grid-value">${item.name}</span>
                            </div>
                        `).join('');

                        crewInlineEl.innerHTML = `
                            <div class="crew-grid">${gridItems}</div>
                            <a href="#" class="view-full-crew-link" onclick="event.preventDefault(); showFullCrewModal();">
                                View Full Crew <i class="fas fa-arrow-circle-right"></i>
                            </a>
                        `;
                        crewInlineEl.style.display = 'block';
                    } else {
                        crewInlineEl.style.display = 'none';
                    }
                } else {
                    crewInlineEl.style.display = 'none';
                }

                // Similar Titles Section
                const similarEl = document.getElementById('details-similar');
                const similarSlider = document.getElementById('details-similar-slider');
                const similarTitles = currentMedia.similar?.results || [];

                if (similarTitles.length > 0) {
                    similarSlider.innerHTML = similarTitles.slice(0, 20).map(item => createMediaCard(item)).join('');
                    similarEl.style.display = 'block';
                } else {
                    similarEl.style.display = 'none';
                }

                // Recommendations Section
                const recommendationsEl = document.getElementById('details-recommendations');
                const recommendationsSlider = document.getElementById('details-recommendations-slider');
                const recommendations = currentMedia.recommendations?.results || [];

                if (recommendations.length > 0) {
                    recommendationsSlider.innerHTML = recommendations.slice(0, 20).map(item => createMediaCard(item)).join('');
                    recommendationsEl.style.display = 'block';
                } else {
                    recommendationsEl.style.display = 'none';
                }

                // Update request button
                updateDetailsRequestButton();
            } catch (error) {
                console.error('Failed to load media details:', error);
                closeMovieDetails();
                alert('Failed to load movie details. Please try again.');
            }
        }

        function closeMovieDetails() {
            document.getElementById('movie-details-page').classList.remove('show');
            document.getElementById('discover-section').style.display = 'block';
            currentMedia = null;
            // Reload discover content when returning from details page
            loadDiscoverContent().catch(err => console.error('Error loading discover content:', err));
        }

        // Search by keyword function
        function searchKeyword(keyword) {
            closeMovieDetails();
            // Use the search functionality to search for the keyword
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = keyword;
            }
            performSearch(keyword);
        }

        function updateDetailsRequestButton() {
            const container = document.getElementById('details-request-container');
            const btn = document.getElementById('details-request-btn');
            const btn4k = document.getElementById('details-request-4k-btn');
            const cacheKey = `${currentMedia.mediaType}-${currentMedia.id}`;
            const cachedStatus = availabilityCache[cacheKey]?.status;

            // Check if user can request 4K based on media type
            const can4k = userPermissions && (
                (currentMedia.mediaType === 'movie' && (userPermissions.can_request_4k_movie || userPermissions.can_request_4k)) ||
                (currentMedia.mediaType === 'tv' && (userPermissions.can_request_4k_tv || userPermissions.can_request_4k))
            );

            // Reset button classes
            btn.className = 'sidebar-request-btn';
            btn4k.className = 'sidebar-request-btn btn-4k';

            // Check request status (non-4K request)
            const request = currentMedia.request;
            const requestStatus = request?.status?.toLowerCase();

            // Check for 4K request status
            const request4k = currentMedia.request4k;
            const request4kStatus = request4k?.status?.toLowerCase();

            // Non-4K status checks
            const non4kRequested = requestStatus === 'pending' || requestStatus === 'approved';
            const non4kProcessing = requestStatus === 'processing' || cachedStatus === 2;
            const non4kAvailable = requestStatus === 'available' || cachedStatus === 4 ||
                                   currentMedia.radarrStatus?.hasFile || currentMedia.sonarrStatus?.exists;
            const non4kDeclined = requestStatus === 'declined';

            // 4K status checks - also check actual Radarr/Sonarr monitoring status
            const fourKMonitoring = currentMedia.monitoringData?.fourK;
            const fourKActuallyInArr = fourKMonitoring && (fourKMonitoring.status === 'processing' || fourKMonitoring.status === 'downloaded' || fourKMonitoring.status === 'partial');

            const fourKRequested = request4kStatus === 'pending' || request4kStatus === 'approved';
            // Only consider "processing" if movie is actually in 4K Radarr/Sonarr
            const fourKProcessing = (request4kStatus === 'processing') && fourKActuallyInArr;
            const fourKAvailable = request4kStatus === 'available' || (fourKMonitoring?.status === 'downloaded');
            const fourKDeclined = request4kStatus === 'declined';

            // Track if we show any button
            let showContainer = false;

            // ===== NON-4K BUTTON LOGIC =====
            // Hide if already available on Plex
            if (non4kAvailable) {
                btn.style.display = 'none';
            }
            // Show "Processing" (greyed) if downloading in Radarr/Sonarr
            else if (non4kProcessing) {
                btn.style.display = '';
                btn.disabled = true;
                btn.classList.add('btn-requested');
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Processing</span>';
                btn.onclick = null;
                showContainer = true;
            }
            // Show "Requested" (greyed) if pending/approved
            else if (non4kRequested) {
                btn.style.display = '';
                btn.disabled = true;
                btn.classList.add('btn-requested');
                btn.innerHTML = '<i class="fas fa-check"></i> <span>Requested</span>';
                btn.onclick = null;
                showContainer = true;
            }
            // Show "Request" if declined (allow re-requesting)
            else if (non4kDeclined) {
                btn.style.display = '';
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-download"></i> <span>Request</span>';
                btn.onclick = () => submitRequestFromDetails(false);
                showContainer = true;
            }
            // Show "Request" or "Request Missing" if nothing requested yet
            else {
                btn.style.display = '';
                btn.disabled = false;
                if (cachedStatus === 3) {
                    btn.innerHTML = '<i class="fas fa-download"></i> <span>Request Missing</span>';
                } else {
                    btn.innerHTML = '<i class="fas fa-download"></i> <span>Request</span>';
                }
                btn.onclick = () => submitRequestFromDetails(false);
                showContainer = true;
            }

            // ===== 4K BUTTON LOGIC =====
            // Only show if user has 4K rights AND non-4K is requested/processing/available
            if (can4k && (non4kRequested || non4kProcessing || non4kAvailable)) {
                // Hide if 4K is already available
                if (fourKAvailable) {
                    btn4k.style.display = 'none';
                }
                // Show "Processing 4K" (greyed) if downloading in 4K Radarr/Sonarr
                else if (fourKProcessing) {
                    btn4k.style.display = '';
                    btn4k.disabled = true;
                    btn4k.classList.add('btn-requested-4k');
                    btn4k.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Processing 4K</span>';
                    btn4k.onclick = null;
                    showContainer = true;
                }
                // Show "4K Requested" (greyed 4K style) if pending/approved
                else if (fourKRequested) {
                    btn4k.style.display = '';
                    btn4k.disabled = true;
                    btn4k.classList.add('btn-requested-4k');
                    btn4k.innerHTML = '<i class="fas fa-check"></i> <span>4K Requested</span>';
                    btn4k.onclick = null;
                    showContainer = true;
                }
                // Show "Request 4K" if declined or not requested
                else {
                    btn4k.style.display = '';
                    btn4k.disabled = false;
                    btn4k.innerHTML = '<i class="fas fa-download"></i> <span>Request 4K</span>';
                    btn4k.onclick = () => submitRequestFromDetails(true);
                    showContainer = true;
                }
            } else {
                btn4k.style.display = 'none';
            }

            // Show or hide container based on whether any button is visible
            container.style.display = showContainer ? '' : 'none';
        }

        // Track expanded seasons and their episode data
        const expandedSeasons = {};
        const seasonEpisodeData = {};

        // ============ Ratings Functions (Matching Seerr Implementation) ============

        /**
         * Fetch and display real ratings from RT, IMDb, and TMDB
         * Works for both movies and TV shows
         */
        async function fetchAndDisplayRatings(mediaId, type) {
            try {
                // Call correct endpoint based on media type
                const endpoint = type === 'movie'
                    ? `/api/v2/request-site/movie/${mediaId}/ratingscombined`
                    : `/api/v2/request-site/tv/${mediaId}/ratingscombined`;
                const response = await fetch(endpoint);
                const ratings = await response.json();

                const badgesHTML = [];

                // RT Tomatometer (Critics Score)
                if (ratings.rt?.criticsScore !== null && ratings.rt?.criticsScore !== undefined) {
                    const isFresh = ratings.rt.criticsRating !== 'Rotten';
                    const tomatoSVG = isFresh
                        ? `<svg viewBox="0 0 560 560" xmlns="http://www.w3.org/2000/svg"><path d="m478.29 296.98c-3.99-63.966-36.52-111.82-85.468-138.58 0.278 1.56-1.109 3.508-2.688 2.818-32.016-14.006-86.328 31.32-124.28 7.584 0.285 8.519-1.378 50.072-59.914 52.483-1.382 0.056-2.142-1.355-1.268-2.354 7.828-8.929 15.732-31.535 4.367-43.586-24.338 21.81-38.472 30.017-85.138 19.186-29.878 31.241-46.809 74-43.485 127.26 6.78 108.74 108.63 170.89 211.19 164.49 102.56-6.395 193.47-80.572 186.68-189.31" fill="#FA320A"/><path d="M291.375 132.293c21.075-5.023 81.693-.49 101.114 25.274 1.166 1.545-.475 4.468-2.355 3.648-32.016-14.006-86.328 31.32-124.282 7.584.285 8.519-1.378 50.072-59.914 52.483-1.382.056-2.142-1.355-1.268-2.354 7.828-8.929 15.73-31.535 4.367-43.586-26.512 23.758-40.884 31.392-98.426 15.838-1.883-.508-1.241-3.535.762-4.298 10.876-4.157 35.515-22.361 58.824-30.385 4.438-1.526 8.862-2.71 13.18-3.4-25.665-2.293-37.235-5.862-53.559-3.4-1.789.27-3.004-1.813-1.895-3.241 21.995-28.332 62.513-36.888 87.512-21.837-15.41-19.094-27.48-34.321-27.48-34.321l28.601-16.246s11.817 26.4 20.414 45.614c21.275-31.435 60.86-34.336 77.585-12.033.992 1.326-.045 3.21-1.702 3.171-13.612-.331-21.107 12.05-21.675 21.466l.197.023" fill="#00912D"/></svg>`
                        : `<svg viewBox="0 0 560 560" xmlns="http://www.w3.org/2000/svg"><path d="M445.185 444.684c-79.369 4.167-95.587-86.652-126.726-86.006-13.268.279-23.726 14.151-19.133 30.32 2.525 8.888 9.53 21.923 13.944 30.011 15.57 28.544-7.447 60.845-34.383 63.577-44.76 4.54-63.433-21.426-62.278-48.007 1.3-29.84 26.6-60.331.65-73.305-27.194-13.597-49.301 39.572-75.325 51.439-23.553 10.741-56.248 2.413-67.872-23.741-8.164-18.379-6.68-53.768 29.67-67.27 22.706-8.433 73.305 11.029 75.9-13.623 2.992-28.416-53.155-30.812-70.06-37.626-29.912-12.055-47.567-37.85-33.734-65.522 10.378-20.757 40.915-29.203 64.223-20.11 27.922 10.892 32.404 39.853 46.71 51.897 12.324 10.38 29.19 11.68 40.22 4.543 8.135-5.265 10.843-16.828 7.774-27.39-4.07-14.023-14.875-22.773-25.415-31.346-18.758-15.249-45.24-28.36-29.222-69.983 13.13-34.11 51.642-35.34 51.642-35.34 15.3-1.72 29.002 2.9 40.167 12.875 14.927 13.335 17.834 31.16 15.336 50.176-2.283 17.358-8.426 32.56-11.63 49.759-3.717 19.966 6.954 40.086 27.249 40.869 26.694 1.031 34.698-19.486 37.964-32.492 4.782-19.028 11.058-36.694 28.718-47.82 25.346-15.97 60.552-12.47 76.886 18.222 12.92 24.284 8.772 57.715-11.047 75.97-8.892 8.188-19.584 11.075-31.148 11.156-16.585.117-33.162-.29-48.556 7.471-10.48 5.281-15.047 13.888-15.045 25.423 0 11.242 5.853 18.585 15.336 23.363 17.86 9.003 37.577 10.843 56.871 14.222 27.98 4.9 52.581 14.755 68.375 40.72.142.228.28.458.415.69 18.139 30.741-.831 75.005-36.476 76.878" fill="#0AC855"/></svg>`;
                    badgesHTML.push(`
                        <a href="${ratings.rt.url}" target="_blank" rel="noopener noreferrer" class="rating-badge ${isFresh ? 'rt-fresh' : 'rt-rotten'}" title="Rotten Tomatoes Tomatometer">
                            <div class="rating-badge-icon">${tomatoSVG}</div>
                            <span class="rating-badge-value">${ratings.rt.criticsScore}<span class="rating-badge-percent">%</span></span>
                        </a>
                    `);
                }

                // RT Audience Score
                if (ratings.rt?.audienceScore !== null && ratings.rt?.audienceScore !== undefined) {
                    const isFresh = ratings.rt.audienceRating !== 'Spilled';
                    const popcornSVG = isFresh
                        ? `<svg viewBox="0 0 560 560" xmlns="http://www.w3.org/2000/svg"><path fill="#fff" d="M370.57 474.214l23.466-237.956c14.93-4.796 29.498-11.15 40.23-20.262L404.16 446.278c-6.748 10.248-19.863 20.86-33.59 27.936zm-78.197 21.631l2.947-244.528c20.894-.599 47.933-3.43 70.97-8.346l-19.07 241.17c-22.724 7.518-35.934 9.848-54.847 11.704zm-99.694-252.874c23.038 4.916 50.077 7.747 70.971 8.346l2.948 244.528c-18.914-1.856-32.123-4.186-54.847-11.705l-19.072-241.17zm-67.974-26.975c10.732 9.112 25.3 15.466 40.23 20.262l23.464 237.956c-13.726-7.075-26.84-17.688-33.59-27.936l-30.104-230.282z"/><path fill="gold" d="M118.905 157.445c1.357 28.827 72.771 51.677 160.578 51.176 76.687-.438 140.659-18.546 156.329-42.336a22.976 22.976 0 00-14.058-7.426c.06-.7.098-1.406.095-2.122-.065-11.4-8.429-20.788-19.327-22.54.287-1.474.438-2.999.43-4.559-.072-12.696-10.426-22.928-23.124-22.856-.287.001-.568.036-.853.049a22.911 22.911 0 001.254-7.56c-.074-12.697-10.425-22.93-23.123-22.858a22.914 22.914 0 00-8.247 1.6c-3.632-6.835-10.606-11.6-18.737-12.149-1.416-11.4-11.157-20.195-22.93-20.129-7.41.042-13.963 3.6-18.136 9.065-4.233-4.605-10.3-7.494-17.047-7.456-12.698.072-22.932 10.424-22.86 23.118a22.983 22.983 0 001.115 6.946 22.918 22.918 0 00-13.07 7.459c-2.644-9.847-11.637-17.084-22.314-17.024-9.975.057-18.406 6.47-21.537 15.366-8.474 3.426-14.439 11.738-14.383 21.433.012 2.154.342 4.227.907 6.202a22.876 22.876 0 00-9.328-1.932c-10.012.058-18.47 6.516-21.574 15.465a22.83 22.83 0 00-9.788-2.149c-12.698.072-22.934 10.422-22.86 23.118a22.833 22.833 0 003.159 11.463c-.202.203-.379.426-.571.636"/><path fill="#FA320A" d="M404.161 446.278c-6.749 10.248-19.864 20.86-33.59 27.936l23.465-237.956c14.93-4.796 29.498-11.15 40.23-20.262L404.16 446.278zM347.22 484.14c-22.723 7.519-35.934 9.85-54.847 11.705l2.947-244.528c20.894-.599 47.933-3.43 70.973-8.346L347.22 484.14zm-135.47 0l-19.07-241.17c23.037 4.917 50.076 7.748 70.97 8.347l2.948 244.528c-18.914-1.856-32.123-4.186-54.847-11.705zm-56.94-37.862l-30.105-230.282c10.732 9.112 25.3 15.466 40.23 20.262l23.464 237.956c-13.726-7.075-26.84-17.688-33.588-27.936zm247.668-321.143c.298 1.453.465 2.955.473 4.498a23.018 23.018 0 01-.43 4.56c10.9 1.749 19.263 11.137 19.328 22.54a23.59 23.59 0 01-.095 2.12 22.976 22.976 0 0114.058 7.425c-15.669 23.792-79.642 41.9-156.327 42.34-87.807.502-159.221-22.346-160.58-51.175.192-.208.37-.433.57-.634-1.355-2.311-2.29-4.887-2.773-7.62-8.408 7.979-13.495 14.412-12.6 23.78.085 1.251 37.196 266.911 37.196 266.911 4.282 42.075 65.391 75.703 138.187 76.12 72.796-.417 133.907-34.045 138.187-76.12 0 0 37.11-265.66 37.197-266.912 1.777-18.736-20.15-35.745-52.39-47.833z"/></svg>`
                        : `<svg viewBox="0 0 560 560" xmlns="http://www.w3.org/2000/svg"><path fill="#6a9967" d="M370.57 474.214l23.466-237.956c14.93-4.796 29.498-11.15 40.23-20.262L404.16 446.278c-6.748 10.248-19.863 20.86-33.59 27.936zm-78.197 21.631l2.947-244.528c20.894-.599 47.933-3.43 70.97-8.346l-19.07 241.17c-22.724 7.518-35.934 9.848-54.847 11.704zm-99.694-252.874c23.038 4.916 50.077 7.747 70.971 8.346l2.948 244.528c-18.914-1.856-32.123-4.186-54.847-11.705l-19.072-241.17zm-67.974-26.975c10.732 9.112 25.3 15.466 40.23 20.262l23.464 237.956c-13.726-7.075-26.84-17.688-33.59-27.936l-30.104-230.282z"/></svg>`;
                    badgesHTML.push(`
                        <a href="${ratings.rt.url}" target="_blank" rel="noopener noreferrer" class="rating-badge ${isFresh ? 'rt-audience' : 'rt-audience-spilled'}" title="Rotten Tomatoes Audience Score">
                            <div class="rating-badge-icon">${popcornSVG}</div>
                            <span class="rating-badge-value">${ratings.rt.audienceScore}<span class="rating-badge-percent">%</span></span>
                        </a>
                    `);
                }

                // IMDb Rating
                if (ratings.imdb?.criticsScore !== null && ratings.imdb?.criticsScore !== undefined) {
                    badgesHTML.push(`
                        <a href="${ratings.imdb.url}" target="_blank" rel="noopener noreferrer" class="rating-badge imdb" title="IMDb Rating">
                            <div class="rating-badge-icon"><svg viewBox="0 0 575 289.83" xmlns="http://www.w3.org/2000/svg"><path fill="#f6c700" d="m575 24.91c-1.56-12.76-11.03-22.93-23.09-24.91h-528.59c-13.21 2.17-23.32 14.16-23.32 28.61v232.25c0 16 12.37 28.97 27.64 28.97h519.95c14.06 0 25.67-11.01 27.41-25.26v-239.66z"/><path stroke="#000" d="m69.35 58.24h45.63v175.65h-45.63v-175.65z"/><path stroke="#000" d="m201.2 139.15c-3.92-26.77-6.1-41.65-6.53-44.62-1.91-14.33-3.73-26.8-5.47-37.44h-59.16v175.65h39.97l0.14-115.98 16.82 115.98h28.47l15.95-118.56 0.15 118.56h39.84v-175.65h-59.61l-10.57 82.06z"/><path stroke="#000" d="m346.71 93.63c0.5 2.24 0.76 7.32 0.76 15.26v68.1c0 11.69-0.76 18.85-2.27 21.49-1.52 2.64-5.56 3.95-12.11 3.95v-115.3c4.97 0 8.36 0.53 10.16 1.57 1.8 1.05 2.96 2.69 3.46 4.93zm20.61 137.32c5.43-1.19 9.99-3.29 13.69-6.28 3.69-3 6.28-7.15 7.76-12.46 1.49-5.3 2.37-15.83 2.37-31.58v-61.68c0-16.62-0.65-27.76-1.66-33.42-1.02-5.67-3.55-10.82-7.6-15.44-4.06-4.62-9.98-7.94-17.76-9.96-7.79-2.02-20.49-3.04-42.58-3.04h-34.04v175.65h55.28c12.74-0.4 20.92-0.99 24.54-1.79z"/><path stroke="#000" d="m464.76 204.7c-0.84 2.23-4.52 3.36-7.3 3.36-2.72 0-4.53-1.08-5.45-3.25-0.92-2.16-1.37-7.09-1.37-14.81v-46.42c0-8 0.4-12.99 1.21-14.98 0.8-1.97 2.56-2.97 5.28-2.97 2.78 0 6.51 1.13 7.47 3.4 0.95 2.27 1.43 7.12 1.43 14.55v45.01c-0.29 9.25-0.71 14.62-1.27 16.11zm-58.08 26.51h41.08c1.71-6.71 2.65-10.44 2.84-11.19 3.72 4.5 7.81 7.88 12.3 10.12 4.47 2.25 11.16 3.37 16.34 3.37 7.21 0 13.43-1.89 18.68-5.68 5.24-3.78 8.58-8.26 10-13.41 1.42-5.16 2.13-13 2.13-23.54v-49.28c0-10.6-0.24-17.52-0.71-20.77s-1.87-6.56-4.2-9.95-5.72-6.02-10.16-7.9-9.68-2.82-15.72-2.82c-5.25 0-11.97 1.05-16.45 3.12-4.47 2.07-8.53 5.21-12.17 9.42v-57.14h-43.96v175.65z"/></svg></div>
                            <span class="rating-badge-value">${ratings.imdb.criticsScore}</span>
                        </a>
                    `);
                }

                // TMDB User Score
                if (ratings.tmdb?.voteAverage) {
                    const tmdbScore = Math.round(ratings.tmdb.voteAverage * 10);
                    const tmdbUrl = `https://www.themoviedb.org/${type}/${mediaId}`;
                    badgesHTML.push(`
                        <a href="${tmdbUrl}" target="_blank" rel="noopener noreferrer" class="rating-badge tmdb" title="TMDB User Score">
                            <img src="https://www.themoviedb.org/assets/2/v4/logos/v2/blue_square_2-d537fb228cf3ded904ef09b136fe3fec72548ebc1fea3fbbd1ad9e36364db38b.svg" class="rating-badge-icon" alt="TMDB">
                            <span class="rating-badge-value">${tmdbScore}<span class="rating-badge-percent">%</span></span>
                        </a>
                    `);
                }

                // Update the ratings badges container
                const ratingsContainer = document.getElementById('details-ratings-badges');
                if (ratingsContainer) {
                    ratingsContainer.innerHTML = badgesHTML.length > 0 ? badgesHTML.join('') : '<div style="color: #64748b; font-size: 12px;">No ratings available</div>';
                }

            } catch (error) {
                console.error('[Request Site] Failed to fetch ratings:', error);
                const ratingsContainer = document.getElementById('details-ratings-badges');
                if (ratingsContainer) {
                    ratingsContainer.innerHTML = '<div style="color: #ef4444; font-size: 12px;">Failed to load ratings</div>';
                }
            }
        }

        /**
         * Display TMDB rating only (for TV shows)
         */
        function displayTMDBRatingOnly(media) {
            if (!media.vote_average) return;

            const tmdbScore = Math.round(media.vote_average * 10);
            const tmdbUrl = `https://www.themoviedb.org/tv/${media.id}`;
            const badgeHTML = `
                <a href="${tmdbUrl}" target="_blank" rel="noopener noreferrer" class="rating-badge tmdb" title="TMDB User Score">
                    <img src="https://www.themoviedb.org/assets/2/v4/logos/v2/blue_square_2-d537fb228cf3ded904ef09b136fe3fec72548ebc1fea3fbbd1ad9e36364db38b.svg" class="rating-badge-icon" alt="TMDB">
                    <span class="rating-badge-value">${tmdbScore}<span class="rating-badge-percent">%</span></span>
                </a>
            `;

            const ratingsContainer = document.getElementById('details-ratings-badges');
            if (ratingsContainer) {
                ratingsContainer.innerHTML = badgeHTML;
            }
        }

        async function toggleSeason(seasonNumber, tvId) {
            const header = document.querySelector(`.season-item[data-season="${seasonNumber}"] .season-header`);
            const content = document.getElementById(`season-content-${seasonNumber}`);
            const chevron = header.querySelector('.season-chevron');

            // Toggle open state
            const isOpen = header.classList.contains('open');

            if (isOpen) {
                // Close season
                header.classList.remove('open');
                content.classList.remove('show');
                chevron.classList.remove('open');
            } else {
                // Open season
                header.classList.add('open');
                content.classList.add('show');
                chevron.classList.add('open');

                // Load episodes if not already loaded
                if (!seasonEpisodeData[seasonNumber]) {
                    try {
                        // Fetch episodes and availability in parallel
                        const [episodesResponse, availabilityResponse] = await Promise.all([
                            fetch(`/api/v2/request-site/tv/${tvId}/season/${seasonNumber}`),
                            fetch(`/api/v2/request-site/tv/${tvId}/season/${seasonNumber}/episodes/availability`)
                        ]);

                        if (!episodesResponse.ok) throw new Error('Failed to load episodes');

                        const seasonData = await episodesResponse.json();
                        const availabilityData = await availabilityResponse.json();
                        const availableEpisodes = availabilityData.available || [];

                        seasonEpisodeData[seasonNumber] = seasonData;

                        // Render episodes with availability indicators
                        const episodes = seasonData.episodes || [];
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        content.innerHTML = `
                            <div class="episode-list">
                                ${episodes.length === 0 ? '<p class="season-loading">No episodes available</p>' :
                                episodes.map(ep => {
                                    const isAvailable = availableEpisodes.includes(ep.episode_number);
                                    const airDate = ep.air_date ? new Date(ep.air_date) : null;
                                    const hasAired = airDate && airDate <= today;
                                    const isUnaired = airDate && airDate > today;

                                    // Determine availability badge
                                    let availabilityBadge = '';
                                    if (isUnaired) {
                                        availabilityBadge = '<span class="episode-availability unaired"><i class="fas fa-clock"></i> Not Aired</span>';
                                    } else if (isAvailable) {
                                        availabilityBadge = '<span class="episode-availability available"><i class="fas fa-check"></i> On Plex</span>';
                                    } else if (hasAired) {
                                        availabilityBadge = '<span class="episode-availability not-available"><i class="fas fa-times"></i> Not on Plex</span>';
                                    }

                                    return `
                                        <div class="episode-item ${isAvailable ? 'episode-available' : ''}">
                                            ${ep.still_path ? `
                                                <div class="episode-still">
                                                    <img src="https://image.tmdb.org/t/p/w300${ep.still_path}" alt="${ep.name || `Episode ${ep.episode_number}`}">
                                                </div>
                                            ` : ''}
                                            <div class="episode-info">
                                                <div class="episode-header-row">
                                                    <span class="episode-title">${ep.episode_number}. ${ep.name || `Episode ${ep.episode_number}`}</span>
                                                    ${availabilityBadge}
                                                    ${ep.air_date ? `<span class="episode-air-date">${new Date(ep.air_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>` : ''}
                                                </div>
                                                ${ep.overview ? `<p class="episode-overview">${ep.overview}</p>` : '<p class="episode-overview" style="color: #64748b; font-style: italic;">No overview available</p>'}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    } catch (error) {
                        console.error('Error loading season episodes:', error);
                        content.innerHTML = '<p class="season-loading" style="color: #ef4444;">Failed to load episodes. Please try again.</p>';
                    }
                }
            }
        }

        // Season Selection Modal Functions
        let seasonModalIs4k = false; // Track if current season modal is for 4K request

        function showSeasonSelectionModal(is4k = false) {
            if (!currentMedia || currentMedia.mediaType !== 'tv') return;

            seasonModalIs4k = is4k; // Store 4K flag for later use

            const modal = document.getElementById('season-modal');
            const subtitle = document.getElementById('season-modal-subtitle');
            const checkboxList = document.getElementById('season-checkbox-list');
            const title = document.getElementById('season-modal-title');

            // Update title based on 4K mode
            if (title) {
                title.textContent = is4k ? 'Request 4K Seasons' : 'Request Seasons';
            }

            // Set subtitle
            subtitle.textContent = currentMedia.name || currentMedia.title;

            // Create season checkboxes
            const seasons = currentMedia.seasons?.filter(s => s.season_number > 0 && s.episode_count > 0) || [];
            checkboxList.innerHTML = seasons.map(season => `
                <div class="season-checkbox-item" onclick="this.querySelector('input').click(); event.stopPropagation();">
                    <input type="checkbox" id="season-${season.season_number}" value="${season.season_number}" checked>
                    <label for="season-${season.season_number}">Season ${season.season_number} (${season.episode_count} episode${season.episode_count > 1 ? 's' : ''})</label>
                </div>
            `).join('');

            // Show modal
            modal.classList.add('show');
        }

        function closeSeasonModal() {
            const modal = document.getElementById('season-modal');
            const checkboxes = document.getElementById('season-checkboxes');
            const options = document.querySelector('.season-modal-options');
            modal.classList.remove('show');
            checkboxes.style.display = 'none';
            // Reset options visibility for next time modal opens
            if (options) options.style.display = '';
        }

        function showSeasonCheckboxes() {
            // Hide the option buttons
            const options = document.querySelector('.season-modal-options');
            if (options) options.style.display = 'none';

            // Show the season checkboxes
            const checkboxes = document.getElementById('season-checkboxes');
            checkboxes.style.display = 'block';
        }

        function showFullCrewModal() {
            if (!currentMedia || !currentMedia.credits) return;

            const page = document.getElementById('full-crew-page');
            const castGrid = document.getElementById('full-crew-cast-grid');
            const crewGrid = document.getElementById('full-crew-crew-grid');
            const pageTitle = document.getElementById('full-crew-page-title');

            // Update page title with media name
            const mediaName = currentMedia.title || currentMedia.name || '';
            pageTitle.textContent = `${mediaName} - Full Cast & Crew`;

            // Populate cast with photos
            const cast = currentMedia.credits.cast || [];
            castGrid.innerHTML = cast.map(member => {
                const photoUrl = member.profile_path
                    ? `https://image.tmdb.org/t/p/w600_and_h900_bestv2${member.profile_path}`
                    : null;

                return `
                    <div class="person-card">
                        <div class="person-card-photo">
                            ${photoUrl
                                ? `<img src="${photoUrl}" alt="${member.name || 'Unknown'}" loading="lazy">`
                                : `<div class="person-card-photo-fallback"><i class="fas fa-user-circle"></i></div>`
                            }
                        </div>
                        <div class="person-card-info">
                            <div class="person-card-name">${member.name || 'Unknown'}</div>
                            <div class="person-card-role">${member.character || 'Unknown Role'}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Populate crew with photos
            const crew = currentMedia.credits.crew || [];
            crewGrid.innerHTML = crew.map(member => {
                const photoUrl = member.profile_path
                    ? `https://image.tmdb.org/t/p/w600_and_h900_bestv2${member.profile_path}`
                    : null;

                return `
                    <div class="person-card">
                        <div class="person-card-photo">
                            ${photoUrl
                                ? `<img src="${photoUrl}" alt="${member.name || 'Unknown'}" loading="lazy">`
                                : `<div class="person-card-photo-fallback"><i class="fas fa-user-circle"></i></div>`
                            }
                        </div>
                        <div class="person-card-info">
                            <div class="person-card-name">${member.name || 'Unknown'}</div>
                            <div class="person-card-role">${member.job || 'Unknown Job'}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Hide other pages and show crew page
            document.getElementById('movie-details-page').classList.remove('show');
            page.classList.add('show');

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function closeFullCrewPage() {
            const page = document.getElementById('full-crew-page');
            page.classList.remove('show');

            // Show movie details page again
            document.getElementById('movie-details-page').classList.add('show');

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function selectAllSeasons() {
            if (!currentMedia || !currentUser) return;

            const seasons = currentMedia.seasons?.filter(s => s.season_number > 0 && s.episode_count > 0).map(s => s.season_number) || [];
            if (seasons.length === 0) {
                alert('No seasons available');
                return;
            }

            await submitTVRequest(seasons, seasonModalIs4k);
            closeSeasonModal();
        }

        async function confirmSeasonSelection() {
            const checkedBoxes = document.querySelectorAll('#season-checkbox-list input:checked');
            const seasons = Array.from(checkedBoxes).map(cb => parseInt(cb.value));

            if (seasons.length === 0) {
                alert('Please select at least one season');
                return;
            }

            await submitTVRequest(seasons, seasonModalIs4k);
            closeSeasonModal();
        }

        async function submitTVRequest(seasons, is4k = false) {
            if (!currentMedia || !currentUser) return;

            try {
                const response = await fetch('/api/v2/request-site/requests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        tmdbId: currentMedia.id,
                        mediaType: 'tv',
                        title: currentMedia.name || currentMedia.title,
                        posterPath: currentMedia.poster_path,
                        backdropPath: currentMedia.backdrop_path,
                        overview: currentMedia.overview,
                        releaseDate: currentMedia.first_air_date,
                        seasons,
                        is4k,
                        requestedBy: `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim() || currentUser.name || 'Unknown'
                    })
                });

                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || result.message || 'Failed to submit request');
                }

                const result = await response.json();

                // Update the appropriate request object based on 4K flag
                if (is4k) {
                    currentMedia.request4k = result;
                } else {
                    currentMedia.request = result;
                }

                // Close modal and update button states
                closeSeasonSelectionModal();
                updateDetailsRequestButton();
                // Refresh usage indicator
                loadUserUsage();
            } catch (error) {
                console.error('Error submitting request:', error);
                alert(error.message || 'Failed to submit request. Please try again.');
            }
        }

        async function watchTrailer() {
            if (!currentMedia) {
                alert('No media selected');
                return;
            }

            try {
                const mediaType = currentMedia.mediaType === 'tv' ? 'tv' : 'movie';
                const response = await fetch(`/api/v2/request-site/${mediaType}/${currentMedia.id}`);
                const data = await response.json();

                // Find YouTube trailer
                const trailer = data.videos?.results?.find(v => v.type === 'Trailer' && v.site === 'YouTube');

                if (trailer) {
                    // Open YouTube trailer in new tab
                    window.open(`https://www.youtube.com/watch?v=${trailer.key}`, '_blank');
                } else {
                    alert('No trailer available for this title');
                }
            } catch (error) {
                console.error('Failed to load trailer:', error);
                alert('Failed to load trailer. Please try again.');
            }
        }

        async function submitRequestFromDetails(is4k = false) {
            if (!currentMedia) {
                alert('No media selected');
                return;
            }

            if (!currentUser) {
                alert('Please log in to submit a request');
                return;
            }

            const container = document.getElementById('details-request-container');
            const btn = document.getElementById('details-request-btn');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Submitting...</span>';

            let seasons = null;
            if (currentMedia.mediaType === 'tv') {
                // For TV shows, show season selection modal (pass is4k to the modal)
                showSeasonSelectionModal(is4k);
                btn.disabled = false;
                updateDetailsRequestButton(); // Reset button state
                return;
            }

            try {
                const response = await fetch('/api/v2/request-site/requests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        tmdbId: currentMedia.id,
                        mediaType: currentMedia.mediaType,
                        title: currentMedia.title || currentMedia.name,
                        posterPath: currentMedia.poster_path,
                        backdropPath: currentMedia.backdrop_path,
                        overview: currentMedia.overview,
                        releaseDate: currentMedia.release_date || currentMedia.first_air_date,
                        seasons,
                        is4k,
                        requestedBy: `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim() || currentUser.name || 'Unknown'
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // Update the appropriate request object based on 4K flag
                    if (is4k) {
                        currentMedia.request4k = result;
                    } else {
                        currentMedia.request = result;
                    }
                    // Update button states to reflect the new request
                    updateDetailsRequestButton();
                    // Refresh usage indicator
                    loadUserUsage();
                } else {
                    alert(result.error || result.message || 'Failed to submit request');
                    btn.disabled = false;
                    updateDetailsRequestButton(); // Reset button state
                }
            } catch (error) {
                console.error('Request failed:', error);
                alert('Failed to submit request');
                btn.disabled = false;
                updateDetailsRequestButton(); // Reset button state
            }
        }

        // ============ Browse State ============
        let browseState = {
            type: null,  // 'genre', 'studio', 'network'
            id: null,
            name: null,
            mediaType: null,  // 'movie', 'tv'
            page: 1,
            isLoading: false,
            hasMore: true,
            sortBy: 'popularity.desc'
        };

        // ============ Explore Functions ============
        function exploreGenre(genreId, type, genreName, skipHistory = false) {
            // Update browser history
            if (!skipHistory) {
                history.pushState({ view: 'browse', browseType: 'genre', id: genreId, mediaType: type, name: genreName }, '', `#browse/genre/${genreId}/${type}`);
            }

            // Reset browse state
            browseState = {
                type: 'genre',
                id: genreId,
                name: genreName,
                mediaType: type,
                page: 1,
                isLoading: false,
                hasMore: true,
                sortBy: 'popularity.desc'
            };

            // Hide discover section, show browse section
            document.getElementById('discover-section').style.display = 'none';
            document.getElementById('browse-section').style.display = 'block';

            // Show browse controls (may be hidden from search)
            const browseControls = document.querySelector('.browse-controls');
            if (browseControls) browseControls.style.display = 'flex';

            // Update title
            const icon = type === 'movie' ? 'fa-film' : 'fa-tv';
            document.getElementById('browse-icon').className = `fas ${icon}`;
            document.getElementById('browse-title').innerHTML = `<i class="fas ${icon}" id="browse-icon"></i> ${genreName} ${type === 'movie' ? 'Movies' : 'TV Shows'}`;

            // Clear and load content
            document.getElementById('browse-grid').innerHTML = '';
            loadBrowseContent().then(() => ensureViewportFilled());
            setupBrowseScroll();
        }

        function exploreStudio(studioId, studioName, skipHistory = false) {
            // Update browser history
            if (!skipHistory) {
                history.pushState({ view: 'browse', browseType: 'studio', id: studioId, name: studioName }, '', `#browse/studio/${studioId}`);
            }

            // Reset browse state
            browseState = {
                type: 'studio',
                id: studioId,
                name: studioName,
                mediaType: 'movie',  // Studios are movie-only
                page: 1,
                isLoading: false,
                hasMore: true,
                sortBy: 'popularity.desc'
            };

            // Hide discover section, show browse section
            document.getElementById('discover-section').style.display = 'none';
            document.getElementById('browse-section').style.display = 'block';

            // Show browse controls (may be hidden from search)
            const browseControls = document.querySelector('.browse-controls');
            if (browseControls) browseControls.style.display = 'flex';

            // Update title
            document.getElementById('browse-icon').className = 'fas fa-building';
            document.getElementById('browse-title').innerHTML = `<i class="fas fa-building" id="browse-icon"></i> ${studioName}`;

            // Clear and load content
            document.getElementById('browse-grid').innerHTML = '';
            loadBrowseContent().then(() => ensureViewportFilled());
            setupBrowseScroll();
        }

        function exploreNetwork(networkId, networkName, skipHistory = false) {
            // Update browser history
            if (!skipHistory) {
                history.pushState({ view: 'browse', browseType: 'network', id: networkId, name: networkName }, '', `#browse/network/${networkId}`);
            }

            // Reset browse state
            browseState = {
                type: 'network',
                id: networkId,
                name: networkName,
                mediaType: 'tv',  // Networks are TV-only
                page: 1,
                isLoading: false,
                hasMore: true,
                sortBy: 'popularity.desc'
            };

            // Hide discover section, show browse section
            document.getElementById('discover-section').style.display = 'none';
            document.getElementById('browse-section').style.display = 'block';

            // Show browse controls (may be hidden from search)
            const browseControls = document.querySelector('.browse-controls');
            if (browseControls) browseControls.style.display = 'flex';

            // Update title
            document.getElementById('browse-icon').className = 'fas fa-broadcast-tower';
            document.getElementById('browse-title').innerHTML = `<i class="fas fa-broadcast-tower" id="browse-icon"></i> ${networkName}`;

            // Clear and load content
            document.getElementById('browse-grid').innerHTML = '';
            loadBrowseContent().then(() => ensureViewportFilled());
            setupBrowseScroll();
        }

        function exploreCollection(collectionId, collectionName, skipHistory = false) {
            // Update browser history
            if (!skipHistory) {
                history.pushState({ view: 'browse', browseType: 'collection', id: collectionId, name: collectionName }, '', `#browse/collection/${collectionId}`);
            }

            // Reset browse state
            browseState = {
                type: 'collection',
                id: collectionId,
                name: collectionName,
                mediaType: 'movie',  // Collections are movie collections
                page: 1,
                isLoading: false,
                hasMore: true,
                sortBy: 'release_date.desc'
            };

            // Hide discover and movie details, show browse section
            document.getElementById('discover-section').style.display = 'none';
            document.getElementById('movie-details-page').classList.remove('show');
            document.getElementById('browse-section').style.display = 'block';

            // Show browse controls (may be hidden from search)
            const browseControls = document.querySelector('.browse-controls');
            if (browseControls) browseControls.style.display = 'flex';

            // Update title
            document.getElementById('browse-icon').className = 'fas fa-layer-group';
            document.getElementById('browse-title').innerHTML = `<i class="fas fa-layer-group" id="browse-icon"></i> ${collectionName}`;

            // Clear and load content
            document.getElementById('browse-grid').innerHTML = '';
            loadBrowseContent().then(() => ensureViewportFilled());
            setupBrowseScroll();
        }

        function goBackToDiscover(skipHistory = false) {
            // Update browser history
            if (!skipHistory) {
                history.pushState({ view: 'discover' }, '', '#discover');
            }

            document.getElementById('browse-section').style.display = 'none';
            document.getElementById('movie-details-page').classList.remove('show');
            document.getElementById('discover-section').style.display = 'block';

            // Clean up scroll listener
            window.removeEventListener('scroll', handleBrowseScroll);
        }

        // ============ Browse Content Loading ============
        async function loadBrowseContent() {
            if (browseState.isLoading || !browseState.hasMore) return;

            browseState.isLoading = true;
            const loadingIndicator = document.getElementById('browse-loading');
            loadingIndicator.style.display = 'flex';

            try {
                let endpoint = '';
                const params = new URLSearchParams({
                    page: browseState.page,
                    sortBy: browseState.sortBy
                });

                // Add active filters to params
                if (currentFilters.dateFrom) {
                    params.append(browseState.mediaType === 'movie' ? 'primaryReleaseDateGte' : 'firstAirDateGte', currentFilters.dateFrom);
                }
                if (currentFilters.dateTo) {
                    params.append(browseState.mediaType === 'movie' ? 'primaryReleaseDateLte' : 'firstAirDateLte', currentFilters.dateTo);
                }
                if (currentFilters.genres.length > 0) {
                    params.append('withGenres', currentFilters.genres.join(','));
                }
                if (currentFilters.status.length > 0) {
                    params.append('status', currentFilters.status.join('|'));
                }
                if (currentFilters.runtimeMin > 0) {
                    params.append('withRuntimeGte', currentFilters.runtimeMin);
                }
                if (currentFilters.runtimeMax < 400) {
                    params.append('withRuntimeLte', currentFilters.runtimeMax);
                }
                if (currentFilters.ratingMin > 1) {
                    params.append('voteAverageGte', currentFilters.ratingMin);
                }
                if (currentFilters.ratingMax < 10) {
                    params.append('voteAverageLte', currentFilters.ratingMax);
                }
                if (currentFilters.voteCountMin > 0) {
                    params.append('voteCountGte', currentFilters.voteCountMin);
                }
                if (currentFilters.voteCountMax < 1000) {
                    params.append('voteCountLte', currentFilters.voteCountMax);
                }
                if (currentFilters.language) {
                    params.append('language', currentFilters.language);
                }

                if (browseState.type === 'all-movies') {
                    endpoint = `/api/v2/request-site/discover/movies?${params}`;
                } else if (browseState.type === 'all-tv') {
                    endpoint = `/api/v2/request-site/discover/tv?${params}`;
                } else if (browseState.type === 'genre') {
                    endpoint = `/api/v2/request-site/discover/genre/${browseState.id}?type=${browseState.mediaType}&${params}`;
                } else if (browseState.type === 'studio') {
                    endpoint = `/api/v2/request-site/discover/studio/${browseState.id}?${params}`;
                } else if (browseState.type === 'network') {
                    endpoint = `/api/v2/request-site/discover/network/${browseState.id}?${params}`;
                } else if (browseState.type === 'collection') {
                    endpoint = `/api/v2/request-site/collection/${browseState.id}`;
                } else if (browseState.type === 'search') {
                    endpoint = `/api/v2/request-site/search?query=${encodeURIComponent(browseState.query)}&page=${browseState.page}`;
                }

                const response = await fetch(endpoint);
                const data = await response.json();

                const container = document.getElementById('browse-grid');

                if (data.results && data.results.length > 0) {
                    // Append new results
                    data.results.forEach(item => {
                        container.insertAdjacentHTML('beforeend', createMediaCard(item));
                    });

                    // Check availability for new items and update badges
                    checkAndUpdateAvailability(data.results);

                    browseState.page++;
                    browseState.hasMore = browseState.page <= data.total_pages;
                } else {
                    browseState.hasMore = false;
                    if (browseState.page === 1) {
                        container.innerHTML = '<div class="request-empty"><p>No content found</p></div>';
                    }
                }
            } catch (error) {
                console.error('Failed to load browse content:', error);
                if (browseState.page === 1) {
                    document.getElementById('browse-grid').innerHTML = '<div class="request-empty"><p>Failed to load content</p></div>';
                }
            } finally {
                browseState.isLoading = false;
                loadingIndicator.style.display = 'none';
            }
        }

        // Ensure viewport is filled with content on initial load
        async function ensureViewportFilled() {
            // Wait a bit for images to render
            await new Promise(resolve => setTimeout(resolve, 100));

            const documentHeight = document.documentElement.scrollHeight;
            const windowHeight = window.innerHeight;

            // If content doesn't fill the screen, load more
            if (documentHeight <= windowHeight + 200 && browseState.hasMore && !browseState.isLoading) {
                await loadBrowseContent();
                // Recursively check again
                await ensureViewportFilled();
            }
        }

        // ============ Infinite Scroll ============
        function setupBrowseScroll() {
            window.removeEventListener('scroll', handleBrowseScroll);
            window.addEventListener('scroll', handleBrowseScroll);
        }

        function handleBrowseScroll() {
            // Check if browse section is visible
            const browseSection = document.getElementById('browse-section');
            if (browseSection.style.display === 'none') return;

            // Check if we're near the bottom
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;

            // Load more when within 500px of bottom
            if (scrollTop + windowHeight >= documentHeight - 500) {
                loadBrowseContent();
            }
        }

        // ============ Browse Sorting & Filtering ============
        function changeBrowseSort(sortValue) {
            browseState.sortBy = sortValue;
            browseState.page = 1;
            browseState.hasMore = true;

            // Clear grid and reload
            document.getElementById('browse-grid').innerHTML = '';
            loadBrowseContent();
        }

        // ============ Filter State ============
        let currentFilters = {
            dateFrom: null,
            dateTo: null,
            genres: [],
            status: [],
            certifications: [],
            keywords: [],
            studios: [],
            streamingProviders: [],
            streamingRegion: 'US',
            runtimeMin: 0,
            runtimeMax: 400,
            ratingMin: 1,
            ratingMax: 10,
            voteCountMin: 0,
            voteCountMax: 1000,
            language: 'en'
        };

        function openFilterPanel() {
            const panel = document.getElementById('filter-slideover');
            const mediaType = browseState.mediaType || 'movie';

            // Update date filter title based on media type
            document.getElementById('date-filter-title').textContent =
                mediaType === 'movie' ? 'Release Date' : 'First Air Date';

            // Show/hide studio and status sections based on media type
            document.getElementById('filter-studio-section').style.display =
                mediaType === 'movie' ? 'block' : 'none';
            document.getElementById('filter-status-section').style.display =
                mediaType === 'tv' ? 'block' : 'none';

            // Populate genres for current media type
            populateGenreFilters(mediaType);

            // Load streaming providers for current region
            loadStreamingProviders(currentFilters.streamingRegion);

            // Setup event listeners if not already done
            if (!panel.hasAttribute('data-initialized')) {
                setupFilterListeners();
                panel.setAttribute('data-initialized', 'true');
            }

            // Show panel
            panel.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeFilterPanel() {
            const panel = document.getElementById('filter-slideover');
            panel.classList.remove('active');
            document.body.style.overflow = '';
        }

        function populateGenreFilters(mediaType) {
            const container = document.getElementById('filter-genres-options');
            if (!container) return;
            container.innerHTML = '';

            // Get genres from constants (we'll fetch from API in production)
            const genres = mediaType === 'movie' ? [
                { id: 28, name: 'Action' },
                { id: 12, name: 'Adventure' },
                { id: 16, name: 'Animation' },
                { id: 35, name: 'Comedy' },
                { id: 80, name: 'Crime' },
                { id: 99, name: 'Documentary' },
                { id: 18, name: 'Drama' },
                { id: 10751, name: 'Family' },
                { id: 14, name: 'Fantasy' },
                { id: 36, name: 'History' },
                { id: 27, name: 'Horror' },
                { id: 10402, name: 'Music' },
                { id: 9648, name: 'Mystery' },
                { id: 10749, name: 'Romance' },
                { id: 878, name: 'Science Fiction' },
                { id: 53, name: 'Thriller' },
                { id: 10752, name: 'War' },
                { id: 37, name: 'Western' }
            ] : [
                { id: 10759, name: 'Action & Adventure' },
                { id: 16, name: 'Animation' },
                { id: 35, name: 'Comedy' },
                { id: 80, name: 'Crime' },
                { id: 99, name: 'Documentary' },
                { id: 18, name: 'Drama' },
                { id: 10751, name: 'Family' },
                { id: 10762, name: 'Kids' },
                { id: 9648, name: 'Mystery' },
                { id: 10763, name: 'News' },
                { id: 10764, name: 'Reality' },
                { id: 10765, name: 'Sci-Fi & Fantasy' },
                { id: 10766, name: 'Soap' },
                { id: 10767, name: 'Talk' },
                { id: 10768, name: 'War & Politics' },
                { id: 37, name: 'Western' }
            ];

            genres.forEach(genre => {
                const option = document.createElement('div');
                option.className = 'custom-select-option';
                option.dataset.value = genre.id;
                option.textContent = genre.name;

                if (currentFilters.genres.includes(genre.id)) {
                    option.classList.add('selected');
                }

                option.addEventListener('click', () => {
                    option.classList.toggle('selected');
                    handleGenreChange();
                });

                container.appendChild(option);
            });
        }

        // Date Picker Implementation
        function initDatePicker(inputId, displayId, pickerId, monthSelectId, yearSelectId, calendarId) {
            const displayInput = document.getElementById(displayId);
            const hiddenInput = document.getElementById(inputId);
            const picker = document.getElementById(pickerId);
            const monthSelect = document.getElementById(monthSelectId);
            const yearSelect = document.getElementById(yearSelectId);
            const calendar = document.getElementById(calendarId);

            if (!displayInput || !picker) return;

            let currentDate = new Date();
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

            // Populate month select
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month.substring(0, 3).toUpperCase();
                monthSelect.appendChild(option);
            });

            // Populate year select (1900 to current year + 10)
            const currentYear = new Date().getFullYear();
            for (let year = 1900; year <= currentYear + 10; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }

            // Update calendar
            function renderCalendar(year, month) {
                monthSelect.value = month;
                yearSelect.value = year;

                calendar.innerHTML = '';

                // Add day headers
                ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'].forEach(day => {
                    const header = document.createElement('div');
                    header.className = 'date-picker-day header';
                    header.textContent = day;
                    calendar.appendChild(header);
                });

                // Get first day of month and total days
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // Add empty cells for days before month starts
                for (let i = 0; i < firstDay; i++) {
                    const empty = document.createElement('div');
                    empty.className = 'date-picker-day empty';
                    calendar.appendChild(empty);
                }

                // Add days
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'date-picker-day';
                    dayEl.textContent = day;
                    dayEl.addEventListener('click', () => {
                        const selectedDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        hiddenInput.value = selectedDate;
                        displayInput.value = selectedDate;
                        picker.style.display = 'none';
                        handleDateChange();
                    });
                    calendar.appendChild(dayEl);
                }
            }

            // Show/hide picker
            displayInput.addEventListener('click', () => {
                picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
                if (picker.style.display === 'block') {
                    renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
                }
            });

            // Month/year change
            monthSelect.addEventListener('change', () => {
                renderCalendar(parseInt(yearSelect.value), parseInt(monthSelect.value));
            });

            yearSelect.addEventListener('change', () => {
                renderCalendar(parseInt(yearSelect.value), parseInt(monthSelect.value));
            });

            // Navigation buttons
            picker.querySelectorAll('.date-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    let year = parseInt(yearSelect.value);
                    let month = parseInt(monthSelect.value);

                    if (action === 'prev-year') year--;
                    else if (action === 'next-year') year++;
                    else if (action === 'prev-month') {
                        month--;
                        if (month < 0) { month = 11; year--; }
                    } else if (action === 'next-month') {
                        month++;
                        if (month > 11) { month = 0; year++; }
                    }

                    renderCalendar(year, month);
                });
            });

            // Close on outside click
            document.addEventListener('click', (e) => {
                if (!displayInput.contains(e.target) && !picker.contains(e.target)) {
                    picker.style.display = 'none';
                }
            });
        }

        function setupFilterListeners() {
            // Initialize date pickers
            initDatePicker('filter-date-from', 'filter-date-from-display', 'filter-date-from-picker', 'filter-date-from-month', 'filter-date-from-year', 'filter-date-from-calendar');
            initDatePicker('filter-date-to', 'filter-date-to-display', 'filter-date-to-picker', 'filter-date-to-month', 'filter-date-to-year', 'filter-date-to-calendar');

            // Custom dropdown toggles
            document.querySelectorAll('.custom-select-trigger').forEach(trigger => {
                trigger.addEventListener('click', function(e) {
                    // Don't toggle if clicking on the input field
                    if (e.target.classList.contains('custom-select-trigger-input')) {
                        return;
                    }

                    e.stopPropagation();
                    const select = this.closest('.custom-select');
                    const isOpen = select.classList.contains('open');

                    // Close all other dropdowns
                    document.querySelectorAll('.custom-select.open').forEach(s => {
                        if (s !== select) s.classList.remove('open');
                    });

                    // Toggle this dropdown (unless it has a searchable input)
                    if (!select.classList.contains('custom-select-searchable')) {
                        select.classList.toggle('open', !isOpen);
                    } else if (!isOpen) {
                        // For searchable, only open, don't close
                        select.classList.add('open');
                        // Focus the input
                        const input = select.querySelector('.custom-select-trigger-input');
                        if (input) input.focus();
                    }
                });
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.custom-select')) {
                    document.querySelectorAll('.custom-select.open').forEach(select => {
                        select.classList.remove('open');
                    });
                }
            });

            // Runtime sliders
            document.getElementById('runtime-min-slider').addEventListener('input', handleRuntimeMinChange);
            document.getElementById('runtime-max-slider').addEventListener('input', handleRuntimeMaxChange);

            // Rating sliders
            document.getElementById('rating-min-slider').addEventListener('input', handleRatingMinChange);
            document.getElementById('rating-max-slider').addEventListener('input', handleRatingMaxChange);

            // Vote count sliders
            document.getElementById('vote-count-min-slider').addEventListener('input', handleVoteCountMinChange);
            document.getElementById('vote-count-max-slider').addEventListener('input', handleVoteCountMaxChange);

            // Language select
            document.getElementById('filter-language').addEventListener('change', handleLanguageChange);

            // Status options (multi-select)
            document.querySelectorAll('#filter-status-options .custom-select-option').forEach(option => {
                option.addEventListener('click', () => {
                    option.classList.toggle('selected');
                    handleStatusChange();
                });
            });

            // Certification options (multi-select)
            document.querySelectorAll('#filter-certification-options .custom-select-option').forEach(option => {
                option.addEventListener('click', () => {
                    option.classList.toggle('selected');
                    handleCertificationChange();
                });
            });

            // Keywords search - open dropdown on focus and search on input
            const keywordsSearch = document.getElementById('filter-keywords-search');
            if (keywordsSearch) {
                let keywordsTimeout;

                keywordsSearch.addEventListener('focus', (e) => {
                    const select = e.target.closest('.custom-select');
                    if (select && !select.classList.contains('open')) {
                        // Close other dropdowns
                        document.querySelectorAll('.custom-select.open').forEach(s => s.classList.remove('open'));
                        select.classList.add('open');
                    }
                });

                keywordsSearch.addEventListener('input', (e) => {
                    const select = e.target.closest('.custom-select');
                    if (select && !select.classList.contains('open')) {
                        select.classList.add('open');
                    }
                    clearTimeout(keywordsTimeout);
                    keywordsTimeout = setTimeout(() => searchKeywords(e.target.value), 300);
                });

                // Prevent dropdown from closing when clicking on input
                keywordsSearch.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }

            // Studio search - open dropdown on focus and search on input
            const studioSearch = document.getElementById('filter-studio-search');
            if (studioSearch) {
                let studioTimeout;

                studioSearch.addEventListener('focus', (e) => {
                    const select = e.target.closest('.custom-select');
                    if (select && !select.classList.contains('open')) {
                        // Close other dropdowns
                        document.querySelectorAll('.custom-select.open').forEach(s => s.classList.remove('open'));
                        select.classList.add('open');
                    }
                });

                studioSearch.addEventListener('input', (e) => {
                    const select = e.target.closest('.custom-select');
                    if (select && !select.classList.contains('open')) {
                        select.classList.add('open');
                    }
                    clearTimeout(studioTimeout);
                    studioTimeout = setTimeout(() => searchStudios(e.target.value), 300);
                });

                // Prevent dropdown from closing when clicking on input
                studioSearch.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }

            // Streaming region change
            document.getElementById('filter-streaming-region').addEventListener('change', (e) => {
                loadStreamingProviders(e.target.value);
            });

            // Streaming search
            const streamingSearchInput = document.getElementById('filter-streaming-search');
            if (streamingSearchInput) {
                streamingSearchInput.addEventListener('input', (e) => {
                    searchStreamingProviders(e.target.value);
                });
            }

            // Show All Providers button
            const showAllBtn = document.getElementById('streaming-show-all-btn');
            if (showAllBtn) {
                showAllBtn.addEventListener('click', () => {
                    toggleShowAllProviders();
                });
            }

            // Close panel and dropdowns on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const filterPanel = document.getElementById('filter-slideover');
                    const openDropdown = document.querySelector('.custom-select.open');

                    if (openDropdown) {
                        // Close dropdown first
                        openDropdown.classList.remove('open');
                    } else if (filterPanel.classList.contains('active')) {
                        // Close panel if no dropdown is open
                        closeFilterPanel();
                    }
                }
            });
        }

        function handleDateChange() {
            currentFilters.dateFrom = document.getElementById('filter-date-from').value || null;
            currentFilters.dateTo = document.getElementById('filter-date-to').value || null;
            updateActiveFiltersCount();
            applyFilters();
        }

        function handleGenreChange() {
            const container = document.getElementById('filter-genres-options');
            if (!container) return;

            // Get all selected genre options
            const selectedOptions = container.querySelectorAll('.custom-select-option.selected');
            currentFilters.genres = Array.from(selectedOptions).map(opt => parseInt(opt.dataset.value));

            // Update selected tags display
            updateSelectedTags('genres');

            updateActiveFiltersCount();
            applyFilters();
        }

        function updateSelectedTags(filterType) {
            const container = document.getElementById(`filter-${filterType}-selected`);
            if (!container) return;

            container.innerHTML = '';

            let items = [];
            let clickHandler;

            if (filterType === 'genres') {
                items = currentFilters.genres;
                clickHandler = (id) => {
                    const option = document.querySelector(`#filter-genres-options .custom-select-option[data-value="${id}"]`);
                    if (option) {
                        option.classList.remove('selected');
                        handleGenreChange();
                    }
                };
            } else if (filterType === 'status') {
                items = currentFilters.status;
                clickHandler = (value) => {
                    const option = document.querySelector(`#filter-status-options .custom-select-option[data-value="${value}"]`);
                    if (option) {
                        option.classList.remove('selected');
                        handleStatusChange();
                    }
                };
            } else if (filterType === 'certification') {
                items = currentFilters.certifications;
                clickHandler = (value) => {
                    const option = document.querySelector(`#filter-certification-options .custom-select-option[data-value="${value}"]`);
                    if (option) {
                        option.classList.remove('selected');
                        handleCertificationChange();
                    }
                };
            } else if (filterType === 'keywords') {
                items = currentFilters.keywords;
                clickHandler = (id) => {
                    currentFilters.keywords = currentFilters.keywords.filter(k => k.id !== id);
                    updateSelectedTags('keywords');
                    updateActiveFiltersCount();
                    applyFilters();
                };
            } else if (filterType === 'studio') {
                items = currentFilters.studios;
                clickHandler = (id) => {
                    currentFilters.studios = currentFilters.studios.filter(s => s.id !== id);
                    updateSelectedTags('studio');
                    updateActiveFiltersCount();
                    applyFilters();
                };
            } else if (filterType === 'streaming') {
                items = currentFilters.streamingProviders;
                clickHandler = (id) => {
                    currentFilters.streamingProviders = currentFilters.streamingProviders.filter(p => p !== id);
                    const provider = document.querySelector(`.streaming-provider[data-provider-id="${id}"]`);
                    if (provider) provider.classList.remove('selected');
                    updateSelectedTags('streaming');
                    updateActiveFiltersCount();
                    applyFilters();
                };
            }

            items.forEach(item => {
                const itemValue = typeof item === 'object' ? item.id : item;
                const itemName = typeof item === 'object' ? item.name : item;

                // Get display name
                let displayName = itemName;
                if (filterType === 'genres' || filterType === 'status' || filterType === 'certification') {
                    const option = document.querySelector(`#filter-${filterType}-options .custom-select-option[data-value="${itemValue}"]`);
                    if (option) displayName = option.textContent;
                }

                const tag = document.createElement('span');
                tag.className = 'selected-tag';
                tag.innerHTML = `${displayName} <i class="fas fa-times"></i>`;
                tag.onclick = () => clickHandler(itemValue);
                container.appendChild(tag);
            });
        }

        function handleStatusChange() {
            const container = document.getElementById('filter-status-options');
            if (!container) return;

            const selectedOptions = container.querySelectorAll('.custom-select-option.selected');
            currentFilters.status = Array.from(selectedOptions).map(opt => opt.dataset.value);

            updateSelectedTags('status');
            updateActiveFiltersCount();
            applyFilters();
        }

        function handleCertificationChange() {
            const container = document.getElementById('filter-certification-options');
            if (!container) return;

            const selectedOptions = container.querySelectorAll('.custom-select-option.selected');
            currentFilters.certifications = Array.from(selectedOptions).map(opt => opt.dataset.value);

            updateSelectedTags('certification');
            updateActiveFiltersCount();
            applyFilters();
        }

        // Keywords search
        async function searchKeywords(query) {
            const container = document.getElementById('filter-keywords-options');
            if (!container) return;

            if (!query || query.length < 2) {
                container.innerHTML = '<div class="custom-select-no-results" style="padding: 12px; text-align: center; color: rgba(255,255,255,0.5);">Type to search keywords...</div>';
                return;
            }

            try {
                const response = await fetch(`/api/v2/request-site/search/keyword?query=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (!data.results || data.results.length === 0) {
                    container.innerHTML = '<div class="custom-select-no-results" style="padding: 12px; text-align: center; color: rgba(255,255,255,0.5);">No keywords found</div>';
                    return;
                }

                container.innerHTML = '';
                data.results.forEach(keyword => {
                    const option = document.createElement('div');
                    option.className = 'custom-select-option';
                    option.dataset.value = keyword.id;
                    option.textContent = keyword.name;

                    // Check if already selected
                    if (currentFilters.keywords.some(k => k.id === keyword.id)) {
                        option.classList.add('selected');
                    }

                    option.addEventListener('click', () => {
                        if (option.classList.contains('selected')) {
                            option.classList.remove('selected');
                            currentFilters.keywords = currentFilters.keywords.filter(k => k.id !== keyword.id);
                        } else {
                            option.classList.add('selected');
                            currentFilters.keywords.push({ id: keyword.id, name: keyword.name });
                        }
                        updateSelectedTags('keywords');
                        updateActiveFiltersCount();
                        applyFilters();
                    });

                    container.appendChild(option);
                });
            } catch (error) {
                console.error('Error searching keywords:', error);
                container.innerHTML = '<div class="custom-select-no-results" style="padding: 12px; text-align: center; color: rgba(255,255,255,0.5);">Error loading keywords</div>';
            }
        }

        // Studio search
        async function searchStudios(query) {
            const container = document.getElementById('filter-studio-options');
            if (!container) return;

            if (!query || query.length < 2) {
                container.innerHTML = '<div class="custom-select-no-results" style="padding: 12px; text-align: center; color: rgba(255,255,255,0.5);">Type to search studios...</div>';
                return;
            }

            try {
                const response = await fetch(`/api/v2/request-site/search/company?query=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (!data.results || data.results.length === 0) {
                    container.innerHTML = '<div class="custom-select-no-results" style="padding: 12px; text-align: center; color: rgba(255,255,255,0.5);">No studios found</div>';
                    return;
                }

                container.innerHTML = '';
                data.results.forEach(studio => {
                    const option = document.createElement('div');
                    option.className = 'custom-select-option';
                    option.dataset.value = studio.id;
                    option.textContent = studio.name;

                    // Check if already selected
                    if (currentFilters.studios.some(s => s.id === studio.id)) {
                        option.classList.add('selected');
                    }

                    option.addEventListener('click', () => {
                        if (option.classList.contains('selected')) {
                            option.classList.remove('selected');
                            currentFilters.studios = currentFilters.studios.filter(s => s.id !== studio.id);
                        } else {
                            option.classList.add('selected');
                            currentFilters.studios.push({ id: studio.id, name: studio.name });
                        }
                        updateSelectedTags('studio');
                        updateActiveFiltersCount();
                        applyFilters();
                    });

                    container.appendChild(option);
                });
            } catch (error) {
                console.error('Error searching studios:', error);
                container.innerHTML = '<div class="custom-select-no-results" style="padding: 12px; text-align: center; color: rgba(255,255,255,0.5);">Error loading studios</div>';
            }
        }

        // Load streaming providers
        let allStreamingProviders = [];
        let showingAllProviders = false;

        async function loadStreamingProviders(region = 'US') {
            const container = document.getElementById('filter-streaming-providers');
            const showAllBtn = document.getElementById('streaming-show-all-btn');
            if (!container) return;

            try {
                // Show loading
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">Loading providers...</div>';

                // Get media type from current browse state
                const mediaType = browseState.mediaType || 'movie';

                // Fetch all available providers for this region from TMDB
                const response = await fetch(`/api/v2/request-site/watch-providers?region=${region}&type=${mediaType}`);
                const data = await response.json();

                if (!data.results || data.results.length === 0) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">No providers available for this region</div>';
                    showAllBtn.style.display = 'none';
                    return;
                }

                // Sort providers by display priority (most popular first)
                allStreamingProviders = data.results.sort((a, b) => a.display_priority - b.display_priority);

                // Show top 24 or all based on state
                renderStreamingProviders(showingAllProviders ? allStreamingProviders : allStreamingProviders.slice(0, 24));

                // Show/hide "Show All" button
                if (allStreamingProviders.length > 24) {
                    showAllBtn.style.display = 'flex';
                    showAllBtn.textContent = showingAllProviders ? ' Show Less' : ` Show All (${allStreamingProviders.length} providers)`;
                    showAllBtn.classList.toggle('expanded', showingAllProviders);
                } else {
                    showAllBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading streaming providers:', error);
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">Error loading providers</div>';
            }
        }

        function renderStreamingProviders(providers) {
            const container = document.getElementById('filter-streaming-providers');
            container.innerHTML = '';

            providers.forEach(provider => {
                const providerEl = document.createElement('div');
                providerEl.className = 'streaming-provider';
                providerEl.dataset.providerId = provider.provider_id;
                providerEl.dataset.providerName = provider.provider_name.toLowerCase();
                providerEl.title = provider.provider_name;

                // Check if already selected
                if (currentFilters.streamingProviders.includes(provider.provider_id)) {
                    providerEl.classList.add('selected');
                }

                // Use TMDB logo path
                const logoUrl = provider.logo_path
                    ? `https://image.tmdb.org/t/p/original${provider.logo_path}`
                    : '';

                providerEl.innerHTML = `
                    <img src="${logoUrl}" alt="${provider.provider_name}" onerror="this.style.display='none'">
                    <div class="streaming-provider-checkmark">
                        <i class="fas fa-check"></i>
                    </div>
                `;

                providerEl.addEventListener('click', () => {
                    providerEl.classList.toggle('selected');

                    if (providerEl.classList.contains('selected')) {
                        if (!currentFilters.streamingProviders.includes(provider.provider_id)) {
                            currentFilters.streamingProviders.push(provider.provider_id);
                        }
                    } else {
                        currentFilters.streamingProviders = currentFilters.streamingProviders.filter(p => p !== provider.provider_id);
                    }

                    updateSelectedTags('streaming');
                    updateActiveFiltersCount();
                    applyFilters();
                });

                container.appendChild(providerEl);
            });
        }

        function toggleShowAllProviders() {
            showingAllProviders = !showingAllProviders;
            const showAllBtn = document.getElementById('streaming-show-all-btn');

            // Get current search query
            const searchInput = document.getElementById('filter-streaming-search');
            const searchQuery = searchInput?.value.toLowerCase() || '';

            // Filter providers based on search
            let providersToShow = allStreamingProviders;
            if (searchQuery) {
                providersToShow = allStreamingProviders.filter(p => p.provider_name.toLowerCase().includes(searchQuery));
            }

            // Apply limit if not showing all
            if (!showingAllProviders && !searchQuery) {
                providersToShow = providersToShow.slice(0, 24);
            }

            renderStreamingProviders(providersToShow);

            // Update button text and icon
            if (!searchQuery) {
                showAllBtn.textContent = showingAllProviders ? ' Show Less' : ` Show All (${allStreamingProviders.length} providers)`;
                showAllBtn.classList.toggle('expanded', showingAllProviders);
            }
        }

        function searchStreamingProviders(query) {
            const searchLower = query.toLowerCase();
            const showAllBtn = document.getElementById('streaming-show-all-btn');

            if (!query) {
                // Reset to showing top 24 or all based on current state
                renderStreamingProviders(showingAllProviders ? allStreamingProviders : allStreamingProviders.slice(0, 24));
                if (allStreamingProviders.length > 24) {
                    showAllBtn.style.display = 'flex';
                }
                return;
            }

            // Filter providers by name
            const filtered = allStreamingProviders.filter(p => p.provider_name.toLowerCase().includes(searchLower));
            renderStreamingProviders(filtered);

            // Hide show all button when searching
            showAllBtn.style.display = 'none';
        }

        function handleRuntimeMinChange(e) {
            const value = parseInt(e.target.value);
            currentFilters.runtimeMin = value;
            document.getElementById('runtime-min-value').textContent = value;
            updateActiveFiltersCount();
            applyFilters();
        }

        function handleRuntimeMaxChange(e) {
            const value = parseInt(e.target.value);
            currentFilters.runtimeMax = value;
            document.getElementById('runtime-max-value').textContent = value;
            updateActiveFiltersCount();
            applyFilters();
        }

        function handleRatingMinChange(e) {
            const value = parseFloat(e.target.value);
            currentFilters.ratingMin = value;
            document.getElementById('rating-min-value').textContent = value.toFixed(1);
            updateActiveFiltersCount();
            applyFilters();
        }

        function handleRatingMaxChange(e) {
            const value = parseFloat(e.target.value);
            currentFilters.ratingMax = value;
            document.getElementById('rating-max-value').textContent = value.toFixed(1);
            updateActiveFiltersCount();
            applyFilters();
        }

        function handleVoteCountMinChange(e) {
            const value = parseInt(e.target.value);
            currentFilters.voteCountMin = value;
            document.getElementById('vote-count-min-value').textContent = value;
            updateActiveFiltersCount();
            applyFilters();
        }

        function handleVoteCountMaxChange(e) {
            const value = parseInt(e.target.value);
            currentFilters.voteCountMax = value;
            document.getElementById('vote-count-max-value').textContent = value;
            updateActiveFiltersCount();
            applyFilters();
        }

        function handleLanguageChange(e) {
            currentFilters.language = e.target.value || null;
            updateActiveFiltersCount();
            applyFilters();
        }

        function countActiveFilters() {
            let count = 0;
            if (currentFilters.dateFrom || currentFilters.dateTo) count++;
            if (currentFilters.genres.length > 0) count++;
            if (currentFilters.status.length > 0) count++;
            if (currentFilters.runtimeMin > 0 || currentFilters.runtimeMax < 400) count++;
            if (currentFilters.ratingMin > 1 || currentFilters.ratingMax < 10) count++;
            if (currentFilters.voteCountMin > 0 || currentFilters.voteCountMax < 1000) count++;
            if (currentFilters.language) count++;
            if (currentFilters.studio) count++;
            return count;
        }

        function updateActiveFiltersCount() {
            const count = countActiveFilters();
            document.getElementById('active-filters-count').textContent = count;
            document.getElementById('filter-count').textContent = count > 0 ? `${count} Active Filters` : 'Filters';
        }

        function applyFilters() {
            // Reset browse state
            browseState.page = 1;
            browseState.hasMore = true;

            // Clear and reload content with filters
            document.getElementById('browse-grid').innerHTML = '';
            loadBrowseContent();
        }

        function clearAllFilters() {
            // Reset all filter values
            currentFilters = {
                dateFrom: null,
                dateTo: null,
                genres: [],
                status: [],
                certifications: [],
                keywords: [],
                studios: [],
                streamingProviders: [],
                streamingRegion: 'US',
                runtimeMin: 0,
                runtimeMax: 400,
                ratingMin: 1,
                ratingMax: 10,
                voteCountMin: 0,
                voteCountMax: 1000,
                language: 'en'
            };

            // Reset UI
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-from-display').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('filter-date-to-display').value = '';
            document.querySelectorAll('.filter-genre-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.filter-status-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('runtime-min-slider').value = 0;
            document.getElementById('runtime-max-slider').value = 400;
            document.getElementById('runtime-min-value').textContent = 0;
            document.getElementById('runtime-max-value').textContent = 400;
            document.getElementById('rating-min-slider').value = 1;
            document.getElementById('rating-max-slider').value = 10;
            document.getElementById('rating-min-value').textContent = 1;
            document.getElementById('rating-max-value').textContent = 10;
            document.getElementById('vote-count-min-slider').value = 0;
            document.getElementById('vote-count-max-slider').value = 1000;
            document.getElementById('vote-count-min-value').textContent = 0;
            document.getElementById('vote-count-max-value').textContent = 1000;
            document.getElementById('filter-language').value = 'en';

            updateActiveFiltersCount();
            applyFilters();
            closeFilterPanel();
        }

        // ============ Search ============
        function performSearch(queryOverride) {
            const query = queryOverride || document.getElementById('search-input').value.trim();
            if (!query) return;

            // Update URL
            history.pushState({ view: 'search', query: query }, '', `#search/${encodeURIComponent(query)}`);

            // Set up browse state for search
            browseState = {
                type: 'search',
                query: query,
                id: null,
                name: `Search: "${query}"`,
                mediaType: null,  // Search returns both movies and TV
                page: 1,
                isLoading: false,
                hasMore: true,
                sortBy: 'popularity.desc'
            };

            // Hide all sections except browse
            document.getElementById('discover-section').style.display = 'none';
            document.getElementById('movies-section').style.display = 'none';
            document.getElementById('tv-section').style.display = 'none';
            document.getElementById('requests-section').style.display = 'none';
            document.getElementById('settings-section').style.display = 'none';
            document.getElementById('movie-details-page').classList.remove('show');
            document.getElementById('browse-section').style.display = 'block';

            // Update title with search icon
            document.getElementById('browse-title').innerHTML = `<i class="fas fa-search" id="browse-icon"></i> Search Results for "${escapeHtml(query)}"`;

            // Hide sort/filter controls for search (not applicable)
            const browseControls = document.querySelector('.browse-controls');
            if (browseControls) {
                browseControls.style.display = 'none';
            }

            // Clear grid and load search results
            document.getElementById('browse-grid').innerHTML = '';
            loadBrowseContent().then(() => {
                ensureViewportFilled();
            });

            // Update nav links - remove active from all
            document.querySelectorAll('.request-nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Set up scroll listener
            setupBrowseScroll();
        }

        // ============ Other Sections (placeholder) ============
        function loadMoviesSection() {
            document.getElementById('movies-content').innerHTML = '<div class="request-loading"><div class="request-loading-spinner"></div><div class="request-loading-text">Loading movies...</div></div>';
        }

        function loadTvSection() {
            document.getElementById('tv-content').innerHTML = '<div class="request-loading"><div class="request-loading-spinner"></div><div class="request-loading-text">Loading TV shows...</div></div>';
        }

        function loadRequestsSection() {
            document.getElementById('requests-content').innerHTML = '<div class="request-loading"><div class="request-loading-spinner"></div><div class="request-loading-text">Loading requests...</div></div>';
        }

        // ============ Admin Requests Management ============
        let adminRequestsCurrentFilter = 'pending'; // Default to pending so admins see what needs action
        let adminRequestsData = [];
        let editRequestModal = null;
        let currentEditRequest = null;

        async function loadAdminRequestsSection() {
            const container = document.getElementById('requests-content');
            container.innerHTML = '<div class="request-loading"><div class="request-loading-spinner"></div><div class="request-loading-text">Loading requests...</div></div>';

            try {
                // Use admin token if available, otherwise portal token for users with approval rights
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken') || localStorage.getItem('portal_token');
                const response = await fetch('/api/v2/request-site-api/requests/all', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load requests');
                }

                const data = await response.json();
                adminRequestsData = data.requests || [];

                // Status counts (pending count only includes requests user can approve)
                const pendingApprovable = adminRequestsData.filter(r =>
                    (r.status === 'pending' || r.status === 1) && canUserApproveRequest(r)
                ).length;
                const counts = {
                    all: adminRequestsData.length,
                    pending: adminRequestsData.filter(r => r.status === 'pending' || r.status === 1).length,
                    approved: adminRequestsData.filter(r => r.status === 'approved' || r.status === 2).length,
                    processing: adminRequestsData.filter(r => r.status === 'processing' || r.status === 2).length,
                    declined: adminRequestsData.filter(r => r.status === 'declined' || r.status === 5).length,
                    available: adminRequestsData.filter(r => r.status === 'available' || r.status === 4).length
                };

                // Update nav badge with count of requests user can approve
                updatePendingBadge(pendingApprovable);

                // Build Seerr-style UI with list layout
                container.innerHTML = `
                    <div class="admin-requests-header">
                        <div class="admin-requests-filters">
                            <select class="admin-filter-select" id="admin-filter-status" onchange="filterAdminRequests()">
                                <option value="pending" ${adminRequestsCurrentFilter === 'pending' ? 'selected' : ''}>Pending (${counts.pending})</option>
                                <option value="all" ${adminRequestsCurrentFilter === 'all' ? 'selected' : ''}>All Requests (${counts.all})</option>
                                <option value="processing" ${adminRequestsCurrentFilter === 'processing' ? 'selected' : ''}>Processing (${counts.processing})</option>
                                <option value="available" ${adminRequestsCurrentFilter === 'available' ? 'selected' : ''}>Available (${counts.available})</option>
                                <option value="declined" ${adminRequestsCurrentFilter === 'declined' ? 'selected' : ''}>Declined (${counts.declined})</option>
                            </select>
                            <select class="admin-filter-select" id="admin-filter-type" onchange="filterAdminRequests()">
                                <option value="all">All Types</option>
                                <option value="movie">Movies</option>
                                <option value="tv">TV Shows</option>
                            </select>
                            <select class="admin-filter-select" id="admin-filter-sort" onchange="filterAdminRequests()">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="title">Title A-Z</option>
                            </select>
                        </div>
                    </div>
                    <div id="admin-requests-list" class="admin-requests-list"></div>
                `;

                displayAdminRequests(adminRequestsData);

            } catch (error) {
                console.error('Failed to load admin requests:', error);
                container.innerHTML = `
                    <div class="request-empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Failed to Load Requests</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function filterAdminRequests() {
            const statusFilter = document.getElementById('admin-filter-status')?.value || 'all';
            const typeFilter = document.getElementById('admin-filter-type')?.value || 'all';
            const sortBy = document.getElementById('admin-filter-sort')?.value || 'newest';

            adminRequestsCurrentFilter = statusFilter;
            displayAdminRequests(adminRequestsData, typeFilter, sortBy);
        }

        function displayAdminRequests(requests, typeFilter = 'all', sortBy = 'newest') {
            let filtered = [...requests];

            // Filter by status
            if (adminRequestsCurrentFilter === 'pending') {
                filtered = filtered.filter(r => r.status === 'pending' || r.status === 1);
            } else if (adminRequestsCurrentFilter === 'processing') {
                filtered = filtered.filter(r => r.status === 'approved' || r.status === 'processing' || r.status === 2);
            } else if (adminRequestsCurrentFilter === 'available') {
                filtered = filtered.filter(r => r.status === 'available' || r.status === 4);
            } else if (adminRequestsCurrentFilter === 'declined') {
                filtered = filtered.filter(r => r.status === 'declined' || r.status === 5);
            }

            // Filter by type
            if (typeFilter !== 'all') {
                filtered = filtered.filter(r => r.media_type === typeFilter);
            }

            // Sort
            if (sortBy === 'newest') {
                filtered.sort((a, b) => new Date(b.created_at || b.requested_at) - new Date(a.created_at || a.requested_at));
            } else if (sortBy === 'oldest') {
                filtered.sort((a, b) => new Date(a.created_at || a.requested_at) - new Date(b.created_at || b.requested_at));
            } else if (sortBy === 'title') {
                filtered.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            }

            const listContainer = document.getElementById('admin-requests-list');

            if (filtered.length === 0) {
                listContainer.innerHTML = `
                    <div class="request-empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No Requests Found</h3>
                        <p>No ${adminRequestsCurrentFilter === 'all' ? '' : adminRequestsCurrentFilter} requests to display.</p>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = filtered.map(request => {
                const statusMap = {
                    'pending': { class: 'pending', text: 'Pending', icon: 'fa-clock' },
                    1: { class: 'pending', text: 'Pending', icon: 'fa-clock' },
                    'approved': { class: 'approved', text: 'Processing', icon: 'fa-spinner' },
                    2: { class: 'approved', text: 'Processing', icon: 'fa-spinner' },
                    'declined': { class: 'declined', text: 'Declined', icon: 'fa-times' },
                    3: { class: 'declined', text: 'Declined', icon: 'fa-times' },
                    'available': { class: 'available', text: 'Available', icon: 'fa-check-circle' },
                    4: { class: 'available', text: 'Available', icon: 'fa-check-circle' },
                    'processing': { class: 'approved', text: 'Processing', icon: 'fa-spinner' },
                    'failed': { class: 'declined', text: 'Failed', icon: 'fa-exclamation-triangle' }
                };

                const status = statusMap[request.status] || statusMap['pending'];
                const posterUrl = request.poster_path
                    ? `https://image.tmdb.org/t/p/w185${request.poster_path}`
                    : '';
                const backdropUrl = request.backdrop_path
                    ? `https://image.tmdb.org/t/p/w780${request.backdrop_path}`
                    : '';

                const requestDate = request.created_at || request.requested_at;
                const formattedDate = requestDate ? new Date(requestDate).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                }) : 'Unknown';

                // Extract year from release date
                const releaseYear = request.release_date ? new Date(request.release_date).getFullYear() : '';

                // Parse seasons if TV show
                let seasonsHtml = '';
                if (request.media_type === 'tv' && request.seasons) {
                    try {
                        const seasons = typeof request.seasons === 'string' ? JSON.parse(request.seasons) : request.seasons;
                        if (Array.isArray(seasons) && seasons.length > 0) {
                            seasonsHtml = `
                                <div class="admin-request-seasons">
                                    <span class="admin-request-seasons-label">Seasons:</span>
                                    ${seasons.map(s => `<span class="admin-request-season-badge">${s}</span>`).join('')}
                                </div>
                            `;
                        }
                    } catch (e) {}
                }

                // User initial for avatar
                const userInitial = request.requested_by ? request.requested_by.charAt(0).toUpperCase() : 'U';
                const isPending = request.status === 'pending' || request.status === 1;

                const posterHtml = posterUrl
                    ? `<img src="${posterUrl}" alt="${request.title}" class="admin-request-poster" loading="lazy">`
                    : `<div class="admin-request-poster admin-request-poster-placeholder"><i class="fas fa-film"></i></div>`;

                // Check if it's a 4K request
                const is4kRequest = request.is_4k === 1 || request.is_4k === true;
                const fourKBadge = is4kRequest ? '<span class="admin-request-4k-badge">4K</span>' : '';

                // Check if current user can approve this specific request
                const canApproveThisRequest = canUserApproveRequest(request);

                return `
                    <div class="admin-request-item" data-request-id="${request.id}" onclick="openMediaModal(${request.tmdb_id}, '${request.media_type}')" style="cursor: pointer;">
                        ${backdropUrl ? `<div class="admin-request-backdrop" style="background-image: url('${backdropUrl}')"></div>` : ''}
                        ${posterHtml}
                        <div class="admin-request-info">
                            <div class="admin-request-year">${releaseYear}</div>
                            <div class="admin-request-title">${request.title}${fourKBadge}</div>
                            ${seasonsHtml}
                        </div>
                        <div class="admin-request-status">
                            <div class="admin-request-status-label">Status</div>
                            <div class="admin-request-status-badge ${status.class}">
                                <i class="fas ${status.icon}"></i> ${status.text}
                            </div>
                            <div class="admin-request-requested">
                                <span class="admin-request-user-avatar">${userInitial}</span>
                                <span>${request.requested_by || 'Unknown'}</span>
                            </div>
                        </div>
                        <div class="admin-request-actions" onclick="event.stopPropagation()">
                            ${isPending && canApproveThisRequest ? `
                                <div class="admin-request-action-row">
                                    <button class="admin-request-btn approve" onclick="event.stopPropagation(); approveRequest(${request.id}, event)">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="admin-request-btn decline" onclick="event.stopPropagation(); declineRequest(${request.id}, event)">
                                        <i class="fas fa-times"></i> Decline
                                    </button>
                                </div>
                            ` : ''}
                            ${isPending && !canApproveThisRequest ? `
                                <div class="admin-request-no-permission" style="color: #9ca3af; font-size: 12px; padding: 8px 0;">
                                    <i class="fas fa-lock"></i> No approval rights for this type
                                </div>
                            ` : ''}
                            ${canApproveThisRequest ? `
                                <button class="admin-request-btn edit" onclick="event.stopPropagation(); openEditRequestModal(${request.id}, event)">
                                    <i class="fas fa-edit"></i> Edit Request
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Approve request
        async function approveRequest(requestId, event) {
            if (event) event.stopPropagation();

            const btn = event?.target?.closest('.admin-request-btn');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;
            }

            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken') || localStorage.getItem('portal_token');
                const response = await fetch(`/api/v2/request-site/requests/${requestId}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to approve request');
                }

                // Refresh the list
                loadAdminRequestsSection();
            } catch (error) {
                console.error('Error approving request:', error);
                alert('Failed to approve request: ' + error.message);
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-check"></i> Approve';
                    btn.disabled = false;
                }
            }
        }

        // Decline request
        async function declineRequest(requestId, event) {
            if (event) event.stopPropagation();

            if (!confirm('Are you sure you want to decline this request?')) return;

            const btn = event?.target?.closest('.admin-request-btn');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;
            }

            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken') || localStorage.getItem('portal_token');
                const response = await fetch(`/api/v2/request-site/requests/${requestId}/decline`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to decline request');
                }

                // Refresh the list
                loadAdminRequestsSection();
            } catch (error) {
                console.error('Error declining request:', error);
                alert('Failed to decline request: ' + error.message);
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-times"></i> Decline';
                    btn.disabled = false;
                }
            }
        }

        // Open Edit Request Modal
        async function openEditRequestModal(requestId, event) {
            if (event) event.stopPropagation();

            const request = adminRequestsData.find(r => r.id === requestId);
            if (!request) return;

            currentEditRequest = request;

            const modal = document.getElementById('edit-request-modal');
            const posterUrl = request.poster_path
                ? `https://image.tmdb.org/t/p/w185${request.poster_path}`
                : 'https://via.placeholder.com/60x90?text=No+Poster';
            const backdropUrl = request.backdrop_path
                ? `https://image.tmdb.org/t/p/w780${request.backdrop_path}`
                : '';

            const statusText = {
                'pending': 'Pending Request',
                1: 'Pending Request',
                'approved': 'Processing',
                2: 'Processing',
                'available': 'Available',
                4: 'Available',
                'declined': 'Declined',
                3: 'Declined'
            };

            const userInitial = request.requested_by ? request.requested_by.charAt(0).toUpperCase() : 'U';
            const requestDate = request.created_at || request.requested_at;
            const formattedDate = requestDate ? new Date(requestDate).toLocaleDateString('en-US', {
                month: 'long', day: 'numeric', year: 'numeric'
            }) : 'Unknown';

            // Build seasons table for TV shows
            let seasonsTableHtml = '';
            if (request.media_type === 'tv') {
                // Fetch TV show details to get all seasons
                try {
                    const tvDetails = await fetchMediaDetails(request.tmdb_id, 'tv');
                    if (tvDetails && tvDetails.seasons) {
                        const requestedSeasons = request.seasons ?
                            (typeof request.seasons === 'string' ? JSON.parse(request.seasons) : request.seasons) : [];

                        seasonsTableHtml = `
                            <table class="edit-request-seasons-table">
                                <thead>
                                    <tr>
                                        <th>Season</th>
                                        <th>Episodes</th>
                                        <th>Status</th>
                                        <th>Requested</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tvDetails.seasons.filter(s => s.season_number > 0).map(season => {
                                        const isRequested = requestedSeasons.includes(season.season_number);
                                        return `
                                            <tr>
                                                <td>Season ${season.season_number}</td>
                                                <td>${season.episode_count} Episodes</td>
                                                <td><span class="edit-request-season-status pending">Not Available</span></td>
                                                <td>
                                                    <div class="edit-request-toggle ${isRequested ? 'active' : ''}"
                                                         data-season="${season.season_number}"
                                                         onclick="toggleSeasonRequest(this, ${season.season_number})"></div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        `;
                    }
                } catch (e) {
                    console.error('Error fetching TV details:', e);
                }
            }

            // Build server options - pass is_4k to pre-select the correct server
            const is4kRequest = request.is_4k === 1 || request.is_4k === true;
            let serverOptionsHtml = await buildServerOptions(request.media_type, is4kRequest);

            document.getElementById('edit-request-content').innerHTML = `
                <div class="edit-request-header">
                    ${backdropUrl ? `<div class="edit-request-header-backdrop" style="background-image: url('${backdropUrl}')"></div>` : ''}
                    <img src="${posterUrl}" alt="${request.title}" class="edit-request-header-poster">
                    <div class="edit-request-header-info">
                        <div class="edit-request-status-title">${statusText[request.status] || 'Pending Request'}</div>
                        <div class="edit-request-media-title">${request.title}</div>
                        <div class="edit-request-user-info">
                            Requested by ${request.requested_by || 'Unknown'} on ${formattedDate}
                        </div>
                    </div>
                    <button class="edit-request-close" onclick="closeEditRequestModal()" style="position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.5); border: none; width: 32px; height: 32px; border-radius: 50%; color: #fff; cursor: pointer; z-index: 2;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="edit-request-body">
                    ${seasonsTableHtml}

                    <div class="edit-request-advanced">
                        <div class="edit-request-advanced-title">
                            <i class="fas fa-cog"></i> Override Settings
                        </div>
                        <div class="edit-request-advanced-grid">
                            ${serverOptionsHtml}
                        </div>
                    </div>

                    <div class="edit-request-requester">
                        <div class="edit-request-requester-title">Requested By</div>
                        <div class="edit-request-requester-user">
                            <div class="edit-request-requester-avatar">${userInitial}</div>
                            <div class="edit-request-requester-info">
                                <div class="edit-request-requester-name">${request.requested_by || 'Unknown User'}</div>
                                <div class="edit-request-requester-email">${request.user_email || ''}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="edit-request-footer">
                    <button class="edit-request-footer-btn close" onclick="closeEditRequestModal()">Close</button>
                    ${(request.status === 'pending' || request.status === 1) ? `
                        <button class="edit-request-footer-btn approve" onclick="approveRequestFromModal(${request.id})">
                            <i class="fas fa-check"></i> Approve Request
                        </button>
                    ` : ''}
                </div>
            `;

            modal.classList.add('show');
        }

        // Build server options dropdowns
        async function buildServerOptions(mediaType, is4k = false) {
            const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
            let serversHtml = '';

            try {
                const response = await fetch('/api/v2/request-site/servers', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const servers = data.servers || [];
                    const serverType = mediaType === 'movie' ? 'radarr' : 'sonarr';
                    const filteredServers = servers.filter(s => s.type === serverType);

                    if (filteredServers.length > 0) {
                        // Find the correct server to pre-select based on is_4k
                        let defaultServerId = null;
                        if (is4k) {
                            // For 4K requests, prefer the 4K server
                            const fourKServer = filteredServers.find(s => s.is_4k === 1 || s.is_4k === true);
                            defaultServerId = fourKServer?.id || filteredServers[0].id;
                        } else {
                            // For non-4K requests, prefer the default server
                            const defaultServer = filteredServers.find(s => s.is_default === 1 || s.is_default === true);
                            defaultServerId = defaultServer?.id || filteredServers[0].id;
                        }

                        serversHtml = `
                            <div class="edit-request-field">
                                <label>Destination Server</label>
                                <select id="edit-request-server" onchange="loadServerProfiles()">
                                    ${filteredServers.map(s => `<option value="${s.id}" ${s.id === defaultServerId ? 'selected' : ''}>${s.name}${s.is_4k ? ' (4K)' : ''}</option>`).join('')}
                                </select>
                            </div>
                            <div class="edit-request-field">
                                <label>Quality Profile</label>
                                <select id="edit-request-quality">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            <div class="edit-request-field">
                                <label>Root Folder</label>
                                <select id="edit-request-rootfolder">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                        `;

                        // Load profiles after a short delay
                        setTimeout(() => loadServerProfiles(), 100);
                    } else {
                        serversHtml = `
                            <div class="edit-request-field" style="grid-column: 1 / -1;">
                                <p style="color: #94a3b8; font-size: 13px;">
                                    <i class="fas fa-info-circle"></i> No ${serverType} servers configured.
                                    <a href="#" onclick="switchSection('settings'); closeEditRequestModal();" style="color: #6366f1;">Add one in Settings</a>
                                </p>
                            </div>
                        `;
                    }
                }
            } catch (e) {
                console.error('Error loading servers:', e);
            }

            return serversHtml || `
                <div class="edit-request-field" style="grid-column: 1 / -1;">
                    <p style="color: #94a3b8; font-size: 13px;">
                        <i class="fas fa-info-circle"></i> Configure Radarr/Sonarr servers in Settings to enable request routing.
                    </p>
                </div>
            `;
        }

        // Load quality profiles and root folders for selected server
        async function loadServerProfiles() {
            const serverId = document.getElementById('edit-request-server')?.value;
            if (!serverId) return;

            const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');

            try {
                const response = await fetch(`/api/v2/request-site/servers/${serverId}/profiles`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();

                    // Update quality profiles with server's default pre-selected
                    const qualitySelect = document.getElementById('edit-request-quality');
                    if (qualitySelect && data.qualityProfiles) {
                        const defaultQualityId = data.defaultQualityProfileId;
                        qualitySelect.innerHTML = data.qualityProfiles
                            .map(p => `<option value="${p.id}" ${p.id == defaultQualityId ? 'selected' : ''}>${p.name}</option>`)
                            .join('');
                    }

                    // Update root folders with server's default pre-selected
                    const rootFolderSelect = document.getElementById('edit-request-rootfolder');
                    if (rootFolderSelect && data.rootFolders) {
                        const defaultRootPath = data.defaultRootFolderPath;
                        rootFolderSelect.innerHTML = data.rootFolders
                            .map(f => `<option value="${f.path}" ${f.path === defaultRootPath ? 'selected' : ''}>${f.path}</option>`)
                            .join('');
                    }
                }
            } catch (e) {
                console.error('Error loading server profiles:', e);
            }
        }

        // Toggle season request
        function toggleSeasonRequest(element, seasonNumber) {
            element.classList.toggle('active');
        }

        // Close Edit Request Modal
        function closeEditRequestModal() {
            const modal = document.getElementById('edit-request-modal');
            modal.classList.remove('show');
            currentEditRequest = null;
        }

        // Approve from modal
        async function approveRequestFromModal(requestId) {
            const approveBtn = document.querySelector('.edit-request-footer-btn.approve');
            if (approveBtn) {
                approveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Approving...';
                approveBtn.disabled = true;
            }

            try {
                // Get selected options
                const serverId = document.getElementById('edit-request-server')?.value;
                const qualityProfileId = document.getElementById('edit-request-quality')?.value;
                const rootFolder = document.getElementById('edit-request-rootfolder')?.value;

                // Get selected seasons for TV
                const selectedSeasons = [];
                document.querySelectorAll('.edit-request-toggle.active').forEach(toggle => {
                    selectedSeasons.push(parseInt(toggle.dataset.season));
                });

                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken') || localStorage.getItem('portal_token');
                const response = await fetch(`/api/v2/request-site/requests/${requestId}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        server_id: serverId,
                        quality_profile_id: qualityProfileId,
                        root_folder: rootFolder,
                        seasons: selectedSeasons.length > 0 ? selectedSeasons : undefined
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to approve request');
                }

                closeEditRequestModal();
                loadAdminRequestsSection();
            } catch (error) {
                console.error('Error approving request:', error);
                alert('Failed to approve request: ' + error.message);
                if (approveBtn) {
                    approveBtn.innerHTML = '<i class="fas fa-check"></i> Approve Request';
                    approveBtn.disabled = false;
                }
            }
        }

        // ============ Settings Section ============
        let settingsServers = [];
        // Check URL for settingsTab parameter (used when linking from admin portal)
        const urlSettingsTab = new URLSearchParams(window.location.search).get('settingsTab');
        let settingsCurrentTab = urlSettingsTab || 'servers';

        async function loadSettingsSection() {
            const container = document.getElementById('settings-content');
            container.innerHTML = `
                <div class="settings-tabs">
                    <button class="settings-tab ${settingsCurrentTab === 'servers' ? 'active' : ''}" data-tab="servers">
                        <i class="fas fa-server"></i> Media Servers
                    </button>
                    <button class="settings-tab ${settingsCurrentTab === 'requests' ? 'active' : ''}" data-tab="requests">
                        <i class="fas fa-sliders-h"></i> Request Settings
                    </button>
                    <button class="settings-tab ${settingsCurrentTab === 'users' ? 'active' : ''}" data-tab="users">
                        <i class="fas fa-users"></i> Users
                    </button>
                    <button class="settings-tab ${settingsCurrentTab === 'notifications' ? 'active' : ''}" data-tab="notifications">
                        <i class="fas fa-bell"></i> Notifications
                    </button>
                    <button class="settings-tab ${settingsCurrentTab === 'managers' ? 'active' : ''}" data-tab="managers">
                        <i class="fas fa-tools"></i> Tools
                    </button>
                </div>
                <div id="settings-tab-content">
                    <div class="request-loading"><div class="request-loading-spinner"></div><div class="request-loading-text">Loading...</div></div>
                </div>
            `;

            // Tab click handlers
            container.querySelectorAll('.settings-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    settingsCurrentTab = tab.dataset.tab;
                    container.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    loadSettingsTabContent();
                });
            });

            loadSettingsTabContent();
        }

        async function loadSettingsTabContent() {
            const content = document.getElementById('settings-tab-content');

            if (settingsCurrentTab === 'servers') {
                await loadServersSettings(content);
            } else if (settingsCurrentTab === 'requests') {
                await loadRequestSettings(content);
            } else if (settingsCurrentTab === 'users') {
                await loadUsersSettings(content);
            } else if (settingsCurrentTab === 'notifications') {
                await loadNotificationSettings(content);
            } else if (settingsCurrentTab === 'managers') {
                await loadManagersSettings(content);
            }
        }

        async function loadServersSettings(container) {
            container.innerHTML = '<div class="request-loading"><div class="request-loading-spinner"></div><div class="request-loading-text">Loading servers...</div></div>';

            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
                const response = await fetch('/api/v2/request-site/servers', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    settingsServers = [];
                } else {
                    const data = await response.json();
                    // Handle both array response and object with servers property
                    settingsServers = Array.isArray(data) ? data : (data.servers || []);
                }

                // Also fetch Plex scan status and available servers
                let plexStatus = { lastScan: null, availableMovies: 0, availableTVShows: 0 };
                let plexServersForScan = [];
                try {
                    const [statusResponse, serversResponse] = await Promise.all([
                        fetch('/api/v2/request-site/plex/scan-status', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }),
                        fetch('/api/v2/request-site/plex/servers', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        })
                    ]);
                    if (statusResponse.ok) {
                        plexStatus = await statusResponse.json();
                    }
                    if (serversResponse.ok) {
                        const data = await serversResponse.json();
                        plexServersForScan = data.servers || [];
                    }
                } catch (e) {
                    console.log('Could not fetch Plex scan status:', e);
                }

                const lastScanText = plexStatus.lastScan
                    ? new Date(plexStatus.lastScan).toLocaleString()
                    : 'Never';

                const plexServerCheckboxes = plexServersForScan.length > 0
                    ? plexServersForScan.map(s => `
                        <label class="settings-checkbox plex-server-checkbox">
                            <input type="checkbox" name="plex-scan-server" value="${s.id}" ${s.enable_auto_scan ? 'checked' : ''} onchange="saveAutoScanPreference(${s.id}, this.checked)">
                            <span><i class="fab fa-plex"></i> ${s.name}</span>
                        </label>
                    `).join('')
                    : '<p style="color: #94a3b8; font-size: 13px;">No Plex servers configured. Add servers in the main admin settings.</p>';

                container.innerHTML = `
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h3><i class="fab fa-plex"></i> Plex Integration</h3>
                        </div>
                        <div class="settings-form">
                            <p class="settings-description">Scan your Plex libraries to automatically mark existing content as available. This prevents users from requesting content you already have.</p>
                            <div class="plex-scan-status">
                                <div class="plex-scan-stat">
                                    <i class="fas fa-film"></i>
                                    <span>${plexStatus.availableMovies} Movies Available</span>
                                </div>
                                <div class="plex-scan-stat">
                                    <i class="fas fa-tv"></i>
                                    <span>${plexStatus.availableTVShows} TV Shows Available</span>
                                </div>
                                <div class="plex-scan-stat">
                                    <i class="fas fa-clock"></i>
                                    <span>Last Scan: ${lastScanText}</span>
                                </div>
                            </div>

                            <div class="plex-server-selection" style="margin-top: 16px;">
                                <label style="font-size: 13px; color: #94a3b8; display: block; margin-bottom: 8px;">
                                    <i class="fas fa-sync-alt" style="margin-right: 4px;"></i> Servers included in auto-scans:
                                </label>
                                <p style="font-size: 12px; color: #64748b; margin-bottom: 12px;">
                                    Selected servers are scanned every 5 minutes for new content and fully rescanned every 6 hours. Changes save automatically.
                                </p>
                                <div class="plex-server-list" id="plex-scan-servers">
                                    ${plexServerCheckboxes}
                                </div>
                                <div id="auto-scan-save-status" style="font-size: 12px; color: #22c55e; margin-top: 8px; display: none;">
                                    <i class="fas fa-check"></i> Saved
                                </div>
                            </div>

                            <div class="settings-row" style="margin-top: 16px;">
                                <button class="settings-btn settings-btn-primary" id="plex-scan-btn" onclick="scanPlexLibraries()">
                                    <i class="fas fa-sync"></i> Scan Selected Libraries
                                </button>
                            </div>
                            <div id="plex-scan-progress" style="display: none; margin-top: 16px;">
                                <div class="request-loading-spinner" style="width: 20px; height: 20px;"></div>
                                <span style="margin-left: 10px; color: #94a3b8;">Scanning libraries... This may take a few minutes.</span>
                            </div>
                        </div>
                    </div>

                    <div class="services-section">
                        <div class="services-section-header">
                            <h3>Radarr Settings</h3>
                            <p>Configure your Radarr server(s) below. You can connect multiple Radarr servers, but only two of them can be marked as defaults (one non-4K and one 4K). Administrators can override the server used to process new requests prior to approval.</p>
                        </div>
                        <div class="servers-list" id="radarr-servers">
                            ${renderServersList('radarr')}
                        </div>
                    </div>

                    <div class="services-section">
                        <div class="services-section-header">
                            <h3>Sonarr Settings</h3>
                            <p>Configure your Sonarr server(s) below. You can connect multiple Sonarr servers, but only two of them can be marked as defaults (one non-4K and one 4K). Administrators can override the server used to process new requests prior to approval.</p>
                        </div>
                        <div class="servers-list" id="sonarr-servers">
                            ${renderServersList('sonarr')}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load servers:', error);
                container.innerHTML = `
                    <div class="request-empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Failed to Load Servers</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Radarr logo SVG (official from Seerr)
        const radarrLogoSvg = `<svg version="1.1" viewBox="0 0 1000 1115.2" xmlns="http://www.w3.org/2000/svg"><path transform="matrix(1.1348 0 0 1.1348 -.0011348 -.013738)" d="m105.76 154.15-1.263 714.59c-60.261 6.782-105.02-23.858-104.28-84.025l-0.216-594.25c2.312-188.02 175.85-231.02 280.22-154.52l530.2 314.93c74.563 53.572 88.403 151.53 49.965 218.76-6.873-52.739-29.067-83.101-73.823-113.74l-597.52-345.84c-44.756-30.639-82.453-23.58-83.286 44.109zm-54.377 751.54c44.941 15.597 90.16 8.63 128.04-13.47l621.16-353.43c36.958 53.109 28.79 105.66-16.706 135.19l-522.65 294.46c-75.673 36.68-172.98-2.127-209.85-62.757z" fill="#fff"/><path transform="matrix(1.1348 0 0 1.1348 -.0011348 -.013738)" d="m240.52 702.59 365.02-216.68-364.35-197.07z" fill="#ffc230"/></svg>`;

        // Sonarr logo SVG (official from Seerr)
        const sonarrLogoSvg = `<svg viewBox="0 0 216.7 216.9" xmlns="http://www.w3.org/2000/svg"><path d="M216.7 108.45c0 29.833-10.533 55.4-31.6 76.7-.7.833-1.483 1.6-2.35 2.3-3.466 3.4-7.133 6.484-11 9.25-18.267 13.467-39.367 20.2-63.3 20.2-23.967 0-45.033-6.733-63.2-20.2-4.8-3.4-9.3-7.25-13.5-11.55-16.367-16.266-26.417-35.167-30.15-56.7-.733-4.2-1.217-8.467-1.45-12.8-.1-2.4-.15-4.8-.15-7.2 0-2.533.05-4.95.15-7.25 0-.233.066-.467.2-.7 1.567-26.6 12.033-49.583 31.4-68.95C53.05 10.517 78.617 0 108.45 0c29.933 0 55.484 10.517 76.65 31.55 21.067 21.433 31.6 47.067 31.6 76.9z" clip-rule="evenodd" fill="#EEE" fill-rule="evenodd"/><path d="M194.65 42.5l-22.4 22.4C159.152 77.998 158 89.4 158 109.5c0 17.934 2.852 34.352 16.2 47.7 9.746 9.746 19 18.95 19 18.95-2.5 3.067-5.2 6.067-8.1 9-.7.833-1.483 1.6-2.35 2.3-2.533 2.5-5.167 4.817-7.9 6.95l-17.55-17.55c-15.598-15.6-27.996-17.1-48.6-17.1-19.77 0-33.223 1.822-47.7 16.3-8.647 8.647-18.55 18.6-18.55 18.6-3.767-2.867-7.333-6.034-10.7-9.5-2.8-2.8-5.417-5.667-7.85-8.6 0 0 9.798-9.848 19.15-19.2 13.852-13.853 16.1-29.916 16.1-47.85 0-17.5-2.874-33.823-15.6-46.55-8.835-8.836-21.05-21-21.05-21 2.833-3.6 5.917-7.067 9.25-10.4 2.934-2.867 5.934-5.55 9-8.05L61.1 43.85C74.102 56.852 90.767 60.2 108.7 60.2c18.467 0 35.077-3.577 48.6-17.1 8.32-8.32 19.3-19.25 19.3-19.25 2.9 2.367 5.733 4.933 8.5 7.7 3.467 3.533 6.65 7.183 9.55 10.95z" clip-rule="evenodd" fill="#3A3F51" fill-rule="evenodd"/><g clip-rule="evenodd"><path d="M78.7 114c-.2-1.167-.332-2.35-.4-3.55-.032-.667-.05-1.333-.05-2 0-.7.018-1.367.05-2 0-.067.018-.133.05-.2.435-7.367 3.334-13.733 8.7-19.1 5.9-5.833 12.984-8.75 21.25-8.75 8.3 0 15.384 2.917 21.25 8.75 5.834 5.934 8.75 13.033 8.75 21.3 0 8.267-2.916 15.35-8.75 21.25-.2.233-.416.45-.65.65-.966.933-1.982 1.783-3.05 2.55-5.065 3.733-10.916 5.6-17.55 5.6s-12.466-1.866-17.5-5.6c-1.332-.934-2.582-2-3.75-3.2-4.532-4.5-7.316-9.734-8.35-15.7z" fill="#0CF" fill-rule="evenodd"/><path d="M157.8 59.75l-15 14.65M30.785 32.526L71.65 73.25m84.6 84.25l27.808 28.78m1.855-153.894L157.8 59.75m-125.45 126l27.35-27.4" fill="none" stroke="#0CF" stroke-miterlimit="1" stroke-width="2"/><path d="M157.8 59.75l-16.95 17.2M58.97 60.604l17.2 17.15M59.623 158.43l16.75-17.4m61.928-1.396l18.028 17.945" fill="none" stroke="#0CF" stroke-miterlimit="1" stroke-width="7"/></g></svg>`;

        function renderServersList(type) {
            const servers = settingsServers.filter(s => s.type === type);
            const logo = type === 'radarr' ? radarrLogoSvg : sonarrLogoSvg;
            const typeName = type === 'radarr' ? 'Radarr' : 'Sonarr';

            // Build cards HTML
            let cardsHtml = servers.map(server => {
                // Generate badges
                let badges = '';
                if (server.is_default && !server.is_4k) {
                    badges += '<span class="server-badge">Default</span>';
                }
                if (server.is_default && server.is_4k) {
                    badges += '<span class="server-badge server-badge-4k">Default 4K</span>';
                }
                if (!server.is_default && server.is_4k) {
                    badges += '<span class="server-badge server-badge-4k">4K</span>';
                }

                return `
                    <div class="server-card">
                        <div class="server-card-content">
                            <div class="server-card-info">
                                <div class="server-card-name">
                                    <h4><a href="${server.url}" target="_blank" rel="noopener noreferrer">${server.name}</a></h4>
                                    ${badges}
                                </div>
                                <div class="server-card-details">
                                    <div class="server-card-detail">
                                        <strong>Address</strong>
                                        <a href="${server.url}" target="_blank" rel="noopener noreferrer">${server.url}</a>
                                    </div>
                                    ${server.quality_profile_name ? `
                                        <div class="server-card-detail">
                                            <strong>Active Profile</strong>
                                            <span>${server.quality_profile_name}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            <a href="${server.url}" target="_blank" rel="noopener noreferrer" class="server-card-logo">
                                ${logo}
                            </a>
                        </div>
                        <div class="server-card-actions">
                            <button class="server-card-btn" onclick="showAddServerModal('${type}', ${server.id})">
                                <i class="fas fa-pencil-alt"></i>
                                <span>Edit</span>
                            </button>
                            <button class="server-card-btn" onclick="deleteServer(${server.id})">
                                <i class="fas fa-trash"></i>
                                <span>Delete</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Add the "Add Server" card
            cardsHtml += `
                <div class="server-add-card" onclick="showAddServerModal('${type}')">
                    <button class="server-add-btn">
                        <i class="fas fa-plus"></i>
                        <span>Add ${typeName} Server</span>
                    </button>
                </div>
            `;

            return `<div class="servers-grid">${cardsHtml}</div>`;
        }

        async function loadRequestSettings(container) {
            container.innerHTML = '<div class="request-loading"><div class="request-loading-spinner"></div><div class="request-loading-text">Loading settings...</div></div>';

            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
                const response = await fetch('/api/v2/request-site/settings', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                let settings = {};
                if (response.ok) {
                    settings = await response.json();
                }

                container.innerHTML = `
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h3><i class="fas fa-check-circle"></i> Auto-Approval</h3>
                        </div>
                        <div class="settings-form">
                            <p class="settings-description">Configure which types of requests should be automatically approved without admin review.</p>
                            <div class="settings-row">
                                <label class="settings-checkbox">
                                    <input type="checkbox" id="auto-approve-movies" ${settings.auto_approve_movies === '1' ? 'checked' : ''}>
                                    <span>Auto-approve movie requests</span>
                                </label>
                            </div>
                            <div class="settings-row">
                                <label class="settings-checkbox">
                                    <input type="checkbox" id="auto-approve-tv" ${settings.auto_approve_tv === '1' ? 'checked' : ''}>
                                    <span>Auto-approve TV show requests</span>
                                </label>
                            </div>
                            <div class="settings-row">
                                <label class="settings-checkbox">
                                    <input type="checkbox" id="auto-approve-4k" ${settings.auto_approve_4k === '1' ? 'checked' : ''}>
                                    <span>Auto-approve 4K requests</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h3><i class="fas fa-tachometer-alt"></i> Request Limits (Default)</h3>
                        </div>
                        <div class="settings-form">
                            <p class="settings-description">Set default request limits for all users. Individual user limits can be configured per-user.</p>

                            <div class="settings-limit-grid">
                                <div class="settings-limit-row">
                                    <div class="settings-limit-label">
                                        <i class="fas fa-film"></i>
                                        <span>Movie Requests</span>
                                    </div>
                                    <div class="settings-limit-inputs">
                                        <input type="number" id="movie-limit" class="settings-input-small" min="0" value="${settings.movie_quota_limit || 0}">
                                        <span>requests per</span>
                                        <input type="number" id="movie-limit-days" class="settings-input-small" min="1" value="${settings.movie_quota_days || 7}">
                                        <span>days</span>
                                    </div>
                                </div>

                                <div class="settings-limit-row">
                                    <div class="settings-limit-label">
                                        <i class="fas fa-tv"></i>
                                        <span>TV Show Requests</span>
                                    </div>
                                    <div class="settings-limit-inputs">
                                        <input type="number" id="tv-limit" class="settings-input-small" min="0" value="${settings.tv_quota_limit || 0}">
                                        <span>requests per</span>
                                        <input type="number" id="tv-limit-days" class="settings-input-small" min="1" value="${settings.tv_quota_days || 7}">
                                        <span>days</span>
                                    </div>
                                </div>

                                <div class="settings-limit-row">
                                    <div class="settings-limit-label">
                                        <i class="fas fa-list"></i>
                                        <span>TV Seasons</span>
                                    </div>
                                    <div class="settings-limit-inputs">
                                        <input type="number" id="season-limit" class="settings-input-small" min="0" value="${settings.season_quota_limit || 0}">
                                        <span>seasons per</span>
                                        <input type="number" id="season-limit-days" class="settings-input-small" min="1" value="${settings.season_quota_days || 7}">
                                        <span>days</span>
                                    </div>
                                </div>
                            </div>

                            <small class="settings-hint">Set to 0 for unlimited requests</small>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h3><i class="fas fa-gem"></i> 4K Requests</h3>
                        </div>
                        <div class="settings-form">
                            <p class="settings-description">Configure 4K request permissions for different media types. You can enable 4K for movies only, TV only, or both.</p>

                            <div class="settings-4k-grid">
                                <div class="settings-4k-option">
                                    <label class="settings-checkbox">
                                        <input type="checkbox" id="allow-4k-movies" ${settings.default_can_request_4k_movies === '1' ? 'checked' : ''}>
                                        <span><i class="fas fa-film"></i> Allow 4K Movie Requests</span>
                                    </label>
                                    <div class="settings-4k-limits" id="4k-movie-limits" style="display: ${settings.default_can_request_4k_movies === '1' ? 'flex' : 'none'};">
                                        <input type="number" id="4k-movie-limit" class="settings-input-small" min="0" value="${settings.movie_4k_quota_limit || 0}">
                                        <span>requests per</span>
                                        <input type="number" id="4k-movie-limit-days" class="settings-input-small" min="1" value="${settings.movie_4k_quota_days || 7}">
                                        <span>days</span>
                                    </div>
                                </div>

                                <div class="settings-4k-option">
                                    <label class="settings-checkbox">
                                        <input type="checkbox" id="allow-4k-tv" ${settings.default_can_request_4k_tv === '1' ? 'checked' : ''}>
                                        <span><i class="fas fa-tv"></i> Allow 4K TV Show Requests</span>
                                    </label>
                                    <div class="settings-4k-limits-container" id="4k-tv-limits" style="display: ${settings.default_can_request_4k_tv === '1' ? 'block' : 'none'};">
                                        <div class="settings-4k-limits" style="margin-bottom: 8px;">
                                            <span style="min-width: 60px;">Shows:</span>
                                            <input type="number" id="4k-tv-limit" class="settings-input-small" min="0" value="${settings.tv_4k_quota_limit || 0}">
                                            <span>per</span>
                                            <input type="number" id="4k-tv-limit-days" class="settings-input-small" min="1" value="${settings.tv_4k_quota_days || 7}">
                                            <span>days</span>
                                        </div>
                                        <div class="settings-4k-limits">
                                            <span style="min-width: 60px;">Seasons:</span>
                                            <input type="number" id="4k-season-limit" class="settings-input-small" min="0" value="${settings.season_4k_quota_limit || 0}">
                                            <span>per</span>
                                            <input type="number" id="4k-season-limit-days" class="settings-input-small" min="1" value="${settings.season_4k_quota_days || 7}">
                                            <span>days</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <small class="settings-hint" style="margin-top: 16px; display: block;">Set quota to 0 for unlimited 4K requests. Leave unchecked to disable 4K for that media type.</small>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h3><i class="fab fa-plex"></i> Plex Watchlist</h3>
                        </div>
                        <div class="settings-form">
                            <p class="settings-description">Automatically request media when users add items to their Plex watchlist.</p>
                            <div class="settings-row">
                                <label class="settings-checkbox">
                                    <input type="checkbox" id="plex-watchlist-sync" ${settings.plex_watchlist_sync === '1' ? 'checked' : ''}>
                                    <span>Enable Plex Watchlist sync</span>
                                </label>
                            </div>
                            <div class="settings-row" id="plex-watchlist-options" style="margin-left: 24px; display: ${settings.plex_watchlist_sync === '1' ? 'block' : 'none'};">
                                <label class="settings-checkbox">
                                    <input type="checkbox" id="plex-watchlist-auto-request" ${settings.plex_watchlist_auto_request === '1' ? 'checked' : ''}>
                                    <span>Auto-request watchlist items not on Plex</span>
                                </label>
                            </div>
                            <div class="settings-row" id="plex-sync-interval-row" style="margin-top: 16px; display: ${settings.plex_watchlist_sync === '1' ? 'flex' : 'none'};">
                                <div class="settings-field">
                                    <label>Sync interval</label>
                                    <select id="plex-sync-interval" class="settings-select">
                                        <option value="15" ${settings.plex_sync_interval === '15' ? 'selected' : ''}>Every 15 minutes</option>
                                        <option value="30" ${settings.plex_sync_interval === '30' ? 'selected' : ''}>Every 30 minutes</option>
                                        <option value="60" ${(settings.plex_sync_interval === '60' || !settings.plex_sync_interval) ? 'selected' : ''}>Every hour</option>
                                        <option value="360" ${settings.plex_sync_interval === '360' ? 'selected' : ''}>Every 6 hours</option>
                                        <option value="1440" ${settings.plex_sync_interval === '1440' ? 'selected' : ''}>Every 24 hours</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h3><i class="fas fa-cog"></i> Default Server Settings</h3>
                        </div>
                        <div class="settings-form">
                            <p class="settings-description">Set default Radarr/Sonarr servers for new requests.</p>
                            <div class="settings-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="settings-field">
                                    <label>Default Radarr Server</label>
                                    <select id="default-radarr-server" class="settings-select">
                                        <option value="">Select server...</option>
                                    </select>
                                </div>
                                <div class="settings-field">
                                    <label>Default Sonarr Server</label>
                                    <select id="default-sonarr-server" class="settings-select">
                                        <option value="">Select server...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="settings-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="settings-field">
                                    <label>Default 4K Radarr Server</label>
                                    <select id="default-radarr-4k-server" class="settings-select">
                                        <option value="">Select server...</option>
                                    </select>
                                </div>
                                <div class="settings-field">
                                    <label>Default 4K Sonarr Server</label>
                                    <select id="default-sonarr-4k-server" class="settings-select">
                                        <option value="">Select server...</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-actions">
                        <button class="settings-btn settings-btn-primary" onclick="saveRequestSettings(event)">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                `;

                // Toggle Plex watchlist options visibility
                document.getElementById('plex-watchlist-sync')?.addEventListener('change', function() {
                    document.getElementById('plex-watchlist-options').style.display = this.checked ? 'block' : 'none';
                    document.getElementById('plex-sync-interval-row').style.display = this.checked ? 'flex' : 'none';
                });

                // Toggle 4K limits visibility based on checkbox state
                document.getElementById('allow-4k-movies')?.addEventListener('change', function() {
                    document.getElementById('4k-movie-limits').style.display = this.checked ? 'flex' : 'none';
                });
                document.getElementById('allow-4k-tv')?.addEventListener('change', function() {
                    document.getElementById('4k-tv-limits').style.display = this.checked ? 'block' : 'none';
                });

                // Load server dropdowns
                loadDefaultServerOptions(settings);

            } catch (error) {
                console.error('Failed to load request settings:', error);
                container.innerHTML = `
                    <div class="request-empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Failed to Load Settings</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadDefaultServerOptions(settings) {
            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
                const response = await fetch('/api/v2/request-site/servers', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const servers = data.servers || [];

                    const radarrServers = servers.filter(s => s.type === 'radarr');
                    const sonarrServers = servers.filter(s => s.type === 'sonarr');

                    // Populate Radarr dropdowns
                    const radarrSelect = document.getElementById('default-radarr-server');
                    const radarr4kSelect = document.getElementById('default-radarr-4k-server');
                    if (radarrSelect) {
                        radarrSelect.innerHTML = '<option value="">Select server...</option>' +
                            radarrServers.map(s => `<option value="${s.id}" ${settings.default_radarr_server == s.id ? 'selected' : ''}>${s.name}</option>`).join('');
                    }
                    if (radarr4kSelect) {
                        radarr4kSelect.innerHTML = '<option value="">Select server...</option>' +
                            radarrServers.map(s => `<option value="${s.id}" ${settings.default_radarr_4k_server == s.id ? 'selected' : ''}>${s.name}</option>`).join('');
                    }

                    // Populate Sonarr dropdowns
                    const sonarrSelect = document.getElementById('default-sonarr-server');
                    const sonarr4kSelect = document.getElementById('default-sonarr-4k-server');
                    if (sonarrSelect) {
                        sonarrSelect.innerHTML = '<option value="">Select server...</option>' +
                            sonarrServers.map(s => `<option value="${s.id}" ${settings.default_sonarr_server == s.id ? 'selected' : ''}>${s.name}</option>`).join('');
                    }
                    if (sonarr4kSelect) {
                        sonarr4kSelect.innerHTML = '<option value="">Select server...</option>' +
                            sonarrServers.map(s => `<option value="${s.id}" ${settings.default_sonarr_4k_server == s.id ? 'selected' : ''}>${s.name}</option>`).join('');
                    }
                }
            } catch (e) {
                console.error('Error loading server options:', e);
            }
        }

        // ============ Users Settings Tab ============
        let usersPermissionsData = { users: [], defaults: {} };
        let usersPermissionsFilter = 'all'; // 'all' or 'overrides'

        async function loadUsersSettings(container) {
            container.innerHTML = '<div class="request-loading"><div class="request-loading-spinner"></div><div class="request-loading-text">Loading users...</div></div>';

            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
                const response = await fetch(`/api/v2/request-site/permissions/users?filter=${usersPermissionsFilter}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    usersPermissionsData = await response.json();
                }

                renderUsersSettings(container);
            } catch (error) {
                console.error('Error loading users:', error);
                container.innerHTML = '<div class="settings-card"><p style="color: #ef4444;">Failed to load users</p></div>';
            }
        }

        function renderUsersSettings(container) {
            const { users, defaults, total, withOverrides } = usersPermissionsData;

            container.innerHTML = `
                <div class="settings-card">
                    <div class="settings-card-header">
                        <h3><i class="fas fa-users-cog"></i> User Permissions</h3>
                        <div class="settings-header-actions">
                            <span class="settings-count">${total} users (${withOverrides} with overrides)</span>
                            <select id="users-filter" class="settings-filter-select" onchange="filterUsersPermissions(this.value)">
                                <option value="all" ${usersPermissionsFilter === 'all' ? 'selected' : ''}>All Users</option>
                                <option value="overrides" ${usersPermissionsFilter === 'overrides' ? 'selected' : ''}>Users with Overrides</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-form">
                        <p class="settings-description">Manage individual user permissions. Users without custom permissions use the defaults from Request Settings.</p>

                        <div class="users-permissions-list">
                            ${users.length === 0 ? '<p class="settings-empty">No users found</p>' : users.map(user => `
                                <div class="user-permission-row ${user.has_custom_permissions ? 'has-override' : ''}" data-user-id="${user.id}">
                                    <div class="user-info">
                                        <div class="user-avatar" style="background: ${getAvatarColor(user.name)};">
                                            ${(user.name || 'U').charAt(0).toUpperCase()}
                                        </div>
                                        <div class="user-details">
                                            <div class="user-name">
                                                ${user.name || 'Unknown User'}
                                                ${user.role === 'admin' ? '<span class="admin-badge"><i class="fas fa-crown"></i> Admin</span>' : ''}
                                                ${user.has_custom_permissions ? '<span class="override-badge"><i class="fas fa-asterisk"></i> Custom</span>' : ''}
                                            </div>
                                            <div class="user-email">${user.email || user.plex_username || 'No email'}</div>
                                        </div>
                                    </div>
                                    <div class="user-permissions-summary">
                                        <span class="perm-badge ${user.permissions.can_request_movies ? 'enabled' : 'disabled'}" title="Movies">
                                            <i class="fas fa-film"></i>
                                        </span>
                                        <span class="perm-badge ${user.permissions.can_request_tv ? 'enabled' : 'disabled'}" title="TV Shows">
                                            <i class="fas fa-tv"></i>
                                        </span>
                                        <span class="perm-badge ${user.permissions.can_request_4k_movie ? 'enabled' : 'disabled'}" title="4K Movies">
                                            <i class="fas fa-gem"></i><i class="fas fa-film" style="font-size: 8px; margin-left: 2px;"></i>
                                        </span>
                                        <span class="perm-badge ${user.permissions.can_request_4k_tv ? 'enabled' : 'disabled'}" title="4K TV">
                                            <i class="fas fa-gem"></i><i class="fas fa-tv" style="font-size: 8px; margin-left: 2px;"></i>
                                        </span>
                                        <span class="perm-badge ${user.permissions.auto_approve_movies || user.permissions.auto_approve_tv ? 'enabled' : 'disabled'}" title="Auto-approve">
                                            <i class="fas fa-check-double"></i>
                                        </span>
                                        <span class="perm-badge ${user.permissions.can_approve_movies || user.permissions.can_approve_tv || user.permissions.can_approve_4k_movies || user.permissions.can_approve_4k_tv ? 'enabled' : 'disabled'}" title="Approval Rights" style="${user.permissions.can_approve_movies || user.permissions.can_approve_tv || user.permissions.can_approve_4k_movies || user.permissions.can_approve_4k_tv ? 'background: rgba(52, 211, 153, 0.2); border-color: #34d399;' : ''}">
                                            <i class="fas fa-user-shield" style="${user.permissions.can_approve_movies || user.permissions.can_approve_tv || user.permissions.can_approve_4k_movies || user.permissions.can_approve_4k_tv ? 'color: #34d399;' : ''}"></i>
                                        </span>
                                    </div>
                                    <div class="user-actions">
                                        <button class="settings-btn settings-btn-small" onclick="editUserPermissions(${user.id})">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        ${user.has_custom_permissions ? `
                                            <button class="settings-btn settings-btn-small settings-btn-danger" onclick="resetUserPermissions(${user.id}, '${(user.name || 'User').replace(/'/g, "\\'")}')">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function filterUsersPermissions(filter) {
            usersPermissionsFilter = filter;
            loadUsersSettings(document.getElementById('settings-tab-content'));
        }

        async function editUserPermissions(userId) {
            const user = usersPermissionsData.users.find(u => u.id === userId);
            if (!user) return;

            const defaults = usersPermissionsData.defaults;

            // Create modal
            const modal = document.createElement('div');
            modal.className = 'request-modal';
            modal.innerHTML = `
                <div class="request-modal-content" style="max-width: 600px;">
                    <div class="request-modal-header">
                        <h3><i class="fas fa-user-cog"></i> Edit Permissions: ${user.name || 'User'}</h3>
                        <button class="request-modal-close" onclick="this.closest('.request-modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="request-modal-body">
                        <div class="settings-form" style="padding: 0;">
                            <div class="settings-row">
                                <label class="settings-checkbox">
                                    <input type="checkbox" id="user-perm-custom" ${user.has_custom_permissions ? 'checked' : ''} onchange="toggleUserCustomPermissions(this.checked)">
                                    <span><strong>Use custom permissions</strong> (override defaults)</span>
                                </label>
                            </div>

                            <div id="user-perm-fields" style="opacity: ${user.has_custom_permissions ? '1' : '0.5'}; pointer-events: ${user.has_custom_permissions ? 'auto' : 'none'};">
                                <hr style="border-color: #374151; margin: 16px 0;">

                                <h4 style="color: #9ca3af; margin-bottom: 12px; font-size: 14px;">Request Permissions</h4>
                                <div class="settings-row">
                                    <label class="settings-checkbox">
                                        <input type="checkbox" id="user-perm-movies" ${user.permissions.can_request_movies ? 'checked' : ''}>
                                        <span><i class="fas fa-film"></i> Can request movies</span>
                                    </label>
                                </div>
                                <div class="settings-row">
                                    <label class="settings-checkbox">
                                        <input type="checkbox" id="user-perm-tv" ${user.permissions.can_request_tv ? 'checked' : ''}>
                                        <span><i class="fas fa-tv"></i> Can request TV shows</span>
                                    </label>
                                </div>
                                <div class="settings-row">
                                    <label class="settings-checkbox">
                                        <input type="checkbox" id="user-perm-4k-movie" ${user.permissions.can_request_4k_movie ? 'checked' : ''}>
                                        <span><i class="fas fa-gem"></i><i class="fas fa-film" style="font-size: 10px; margin-left: 4px;"></i> Can request 4K movies</span>
                                    </label>
                                </div>
                                <div class="settings-row">
                                    <label class="settings-checkbox">
                                        <input type="checkbox" id="user-perm-4k-tv" ${user.permissions.can_request_4k_tv ? 'checked' : ''}>
                                        <span><i class="fas fa-gem"></i><i class="fas fa-tv" style="font-size: 10px; margin-left: 4px;"></i> Can request 4K TV shows</span>
                                    </label>
                                </div>

                                <hr style="border-color: #374151; margin: 16px 0;">

                                <h4 style="color: #9ca3af; margin-bottom: 12px; font-size: 14px;">Auto-Approval</h4>
                                <div class="settings-row">
                                    <label class="settings-checkbox">
                                        <input type="checkbox" id="user-perm-auto-movies" ${user.permissions.auto_approve_movies ? 'checked' : ''}>
                                        <span>Auto-approve movie requests</span>
                                    </label>
                                </div>
                                <div class="settings-row">
                                    <label class="settings-checkbox">
                                        <input type="checkbox" id="user-perm-auto-tv" ${user.permissions.auto_approve_tv ? 'checked' : ''}>
                                        <span>Auto-approve TV requests</span>
                                    </label>
                                </div>

                                <hr style="border-color: #374151; margin: 16px 0;">

                                <h4 style="color: #9ca3af; margin-bottom: 12px; font-size: 14px;">Request Limits <span style="font-weight: normal; font-size: 12px;">(0 = unlimited)</span></h4>

                                <div class="perm-limit-grid">
                                    <div class="perm-limit-item">
                                        <div class="perm-limit-icon"><i class="fas fa-film"></i></div>
                                        <div class="perm-limit-fields">
                                            <input type="number" id="user-perm-movie-limit" min="0" value="${user.permissions.movie_limit_per_week || 0}">
                                            <span>movies per</span>
                                            <input type="number" id="user-perm-movie-limit-days" min="1" value="${user.permissions.movie_limit_days || 7}">
                                            <span>days</span>
                                        </div>
                                    </div>
                                    <div class="perm-limit-item">
                                        <div class="perm-limit-icon"><i class="fas fa-tv"></i></div>
                                        <div class="perm-limit-fields">
                                            <input type="number" id="user-perm-tv-show-limit" min="0" value="${user.permissions.tv_show_limit || 0}">
                                            <span>shows per</span>
                                            <input type="number" id="user-perm-tv-show-limit-days" min="1" value="${user.permissions.tv_show_limit_days || 7}">
                                            <span>days</span>
                                        </div>
                                        <div class="perm-limit-hint">Limits TV shows regardless of seasons</div>
                                    </div>
                                    <div class="perm-limit-item">
                                        <div class="perm-limit-icon"><i class="fas fa-layer-group"></i></div>
                                        <div class="perm-limit-fields">
                                            <input type="number" id="user-perm-tv-season-limit" min="0" value="${user.permissions.tv_season_limit || 0}">
                                            <span>seasons per</span>
                                            <input type="number" id="user-perm-tv-season-limit-days" min="1" value="${user.permissions.tv_season_limit_days || 7}">
                                            <span>days</span>
                                        </div>
                                        <div class="perm-limit-hint">Limits total seasons across all shows</div>
                                    </div>
                                </div>

                                <hr style="border-color: #374151; margin: 16px 0;">

                                <h4 style="color: #c4b5fd; margin-bottom: 12px; font-size: 14px;"><i class="fas fa-gem" style="margin-right: 6px;"></i>4K Request Limits <span style="font-weight: normal; font-size: 12px; color: #9ca3af;">(0 = unlimited)</span></h4>

                                <div class="perm-limit-grid">
                                    <div class="perm-limit-item" style="border-color: rgba(139, 92, 246, 0.3);">
                                        <div class="perm-limit-icon" style="color: #c4b5fd;"><i class="fas fa-film"></i></div>
                                        <div class="perm-limit-fields">
                                            <input type="number" id="user-perm-4k-movie-limit" min="0" value="${user.permissions.movie_4k_limit || 0}">
                                            <span>4K movies per</span>
                                            <input type="number" id="user-perm-4k-movie-limit-days" min="1" value="${user.permissions.movie_4k_limit_days || 7}">
                                            <span>days</span>
                                        </div>
                                    </div>
                                    <div class="perm-limit-item" style="border-color: rgba(139, 92, 246, 0.3);">
                                        <div class="perm-limit-icon" style="color: #c4b5fd;"><i class="fas fa-tv"></i></div>
                                        <div class="perm-limit-fields">
                                            <input type="number" id="user-perm-4k-tv-show-limit" min="0" value="${user.permissions.tv_show_4k_limit || 0}">
                                            <span>4K shows per</span>
                                            <input type="number" id="user-perm-4k-tv-show-limit-days" min="1" value="${user.permissions.tv_show_4k_limit_days || 7}">
                                            <span>days</span>
                                        </div>
                                        <div class="perm-limit-hint">Limits 4K TV shows regardless of seasons</div>
                                    </div>
                                    <div class="perm-limit-item" style="border-color: rgba(139, 92, 246, 0.3);">
                                        <div class="perm-limit-icon" style="color: #c4b5fd;"><i class="fas fa-layer-group"></i></div>
                                        <div class="perm-limit-fields">
                                            <input type="number" id="user-perm-4k-tv-season-limit" min="0" value="${user.permissions.tv_season_4k_limit || 0}">
                                            <span>4K seasons per</span>
                                            <input type="number" id="user-perm-4k-tv-season-limit-days" min="1" value="${user.permissions.tv_season_4k_limit_days || 7}">
                                            <span>days</span>
                                        </div>
                                        <div class="perm-limit-hint">Limits total 4K seasons across all shows</div>
                                    </div>
                                </div>

                                <hr style="border-color: #374151; margin: 16px 0;">

                                <h4 style="color: #34d399; margin-bottom: 12px; font-size: 14px;"><i class="fas fa-user-shield" style="margin-right: 6px;"></i>Approval Rights <span style="font-weight: normal; font-size: 12px; color: #9ca3af;">(grant admin-like approval permissions)</span></h4>
                                <p style="color: #6b7280; font-size: 12px; margin-bottom: 12px;">Users with approval rights can approve requests in the Manage Requests section</p>
                                <div class="settings-row">
                                    <label class="settings-checkbox">
                                        <input type="checkbox" id="user-perm-approve-movies" ${user.permissions.can_approve_movies ? 'checked' : ''}>
                                        <span><i class="fas fa-film" style="color: #34d399;"></i> Can approve movies</span>
                                    </label>
                                </div>
                                <div class="settings-row">
                                    <label class="settings-checkbox">
                                        <input type="checkbox" id="user-perm-approve-tv" ${user.permissions.can_approve_tv ? 'checked' : ''}>
                                        <span><i class="fas fa-tv" style="color: #34d399;"></i> Can approve TV shows</span>
                                    </label>
                                </div>
                                <div class="settings-row">
                                    <label class="settings-checkbox">
                                        <input type="checkbox" id="user-perm-approve-4k-movies" ${user.permissions.can_approve_4k_movies ? 'checked' : ''}>
                                        <span><i class="fas fa-gem" style="color: #c4b5fd;"></i><i class="fas fa-film" style="font-size: 10px; margin-left: 4px; color: #34d399;"></i> Can approve 4K movies</span>
                                    </label>
                                </div>
                                <div class="settings-row">
                                    <label class="settings-checkbox">
                                        <input type="checkbox" id="user-perm-approve-4k-tv" ${user.permissions.can_approve_4k_tv ? 'checked' : ''}>
                                        <span><i class="fas fa-gem" style="color: #c4b5fd;"></i><i class="fas fa-tv" style="font-size: 10px; margin-left: 4px; color: #34d399;"></i> Can approve 4K TV shows</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="request-modal-footer">
                        <button class="settings-btn" onclick="this.closest('.request-modal').remove()">Cancel</button>
                        <button class="settings-btn settings-btn-primary" onclick="saveUserPermissions(${userId}, event)">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function toggleUserCustomPermissions(enabled) {
            const fields = document.getElementById('user-perm-fields');
            if (fields) {
                fields.style.opacity = enabled ? '1' : '0.5';
                fields.style.pointerEvents = enabled ? 'auto' : 'none';
            }
        }

        async function saveUserPermissions(userId, event) {
            // Find save button in modal
            const btn = event?.target || document.querySelector('.request-modal [onclick*="saveUserPermissions"]');
            if (btn?.disabled) return; // Prevent double-click

            setButtonLoading(btn, true);
            const hasCustom = document.getElementById('user-perm-custom').checked;

            const data = {
                has_custom_permissions: hasCustom,
                can_request_movies: document.getElementById('user-perm-movies').checked,
                can_request_tv: document.getElementById('user-perm-tv').checked,
                can_request_4k_movie: document.getElementById('user-perm-4k-movie').checked,
                can_request_4k_tv: document.getElementById('user-perm-4k-tv').checked,
                auto_approve_movies: document.getElementById('user-perm-auto-movies').checked,
                auto_approve_tv: document.getElementById('user-perm-auto-tv').checked,
                movie_limit_per_week: parseInt(document.getElementById('user-perm-movie-limit').value) || 0,
                movie_limit_days: parseInt(document.getElementById('user-perm-movie-limit-days').value) || 7,
                tv_show_limit: parseInt(document.getElementById('user-perm-tv-show-limit').value) || 0,
                tv_show_limit_days: parseInt(document.getElementById('user-perm-tv-show-limit-days').value) || 7,
                tv_season_limit: parseInt(document.getElementById('user-perm-tv-season-limit').value) || 0,
                tv_season_limit_days: parseInt(document.getElementById('user-perm-tv-season-limit-days').value) || 7,
                // 4K limits
                movie_4k_limit: parseInt(document.getElementById('user-perm-4k-movie-limit').value) || 0,
                movie_4k_limit_days: parseInt(document.getElementById('user-perm-4k-movie-limit-days').value) || 7,
                tv_show_4k_limit: parseInt(document.getElementById('user-perm-4k-tv-show-limit').value) || 0,
                tv_show_4k_limit_days: parseInt(document.getElementById('user-perm-4k-tv-show-limit-days').value) || 7,
                tv_season_4k_limit: parseInt(document.getElementById('user-perm-4k-tv-season-limit').value) || 0,
                tv_season_4k_limit_days: parseInt(document.getElementById('user-perm-4k-tv-season-limit-days').value) || 7,
                // Approval rights
                can_approve_movies: document.getElementById('user-perm-approve-movies').checked,
                can_approve_tv: document.getElementById('user-perm-approve-tv').checked,
                can_approve_4k_movies: document.getElementById('user-perm-approve-4k-movies').checked,
                can_approve_4k_tv: document.getElementById('user-perm-approve-4k-tv').checked
            };

            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
                const response = await fetch(`/api/v2/request-site/permissions/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    document.querySelector('.request-modal')?.remove();
                    loadUsersSettings(document.getElementById('settings-tab-content'));
                    showRequestToast('User permissions saved successfully', 'success');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showRequestToast('Failed to save permissions: ' + (errorData.error || 'Unknown error'), 'error');
                    setButtonLoading(btn, false);
                }
            } catch (error) {
                console.error('Error saving user permissions:', error);
                showRequestToast('Error saving permissions: ' + error.message, 'error');
                setButtonLoading(btn, false);
            }
        }

        async function resetUserPermissions(userId, userName) {
            if (!confirm(`Reset ${userName}'s permissions to defaults?`)) return;

            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
                const response = await fetch(`/api/v2/request-site/permissions/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    loadUsersSettings(document.getElementById('settings-tab-content'));
                    alert('User reset to defaults');
                } else {
                    alert('Failed to reset permissions');
                }
            } catch (error) {
                console.error('Error resetting user permissions:', error);
                alert('Error resetting permissions: ' + error.message);
            }
        }

        function getAvatarColor(name) {
            const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#3b82f6', '#8b5cf6', '#ec4899'];
            const hash = (name || 'U').split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            return colors[hash % colors.length];
        }

        async function loadNotificationSettings(container) {
            container.innerHTML = `
                <div class="settings-card">
                    <div class="settings-card-header">
                        <h3><i class="fas fa-envelope"></i> Email Notifications</h3>
                    </div>
                    <div class="settings-form">
                        <div class="settings-row">
                            <label class="settings-checkbox">
                                <input type="checkbox" id="notify-new-request" checked>
                                <span>Notify admins when new requests are submitted</span>
                            </label>
                        </div>
                        <div class="settings-row">
                            <label class="settings-checkbox">
                                <input type="checkbox" id="notify-request-approved" checked>
                                <span>Notify users when their request is approved</span>
                            </label>
                        </div>
                        <div class="settings-row">
                            <label class="settings-checkbox">
                                <input type="checkbox" id="notify-request-available" checked>
                                <span>Notify users when their requested media is available</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="settings-actions">
                    <button class="settings-btn settings-btn-primary" onclick="saveNotificationSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            `;
        }

        async function saveRequestSettings(event) {
            // Find the save button (either from event or by selector)
            const btn = event?.target || document.querySelector('[onclick*="saveRequestSettings"]');
            if (btn?.disabled) return; // Prevent double-click

            setButtonLoading(btn, true);
            const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');

            const settings = {
                // Auto-approval
                auto_approve_movies: document.getElementById('auto-approve-movies')?.checked ? '1' : '0',
                auto_approve_tv: document.getElementById('auto-approve-tv')?.checked ? '1' : '0',
                auto_approve_4k: document.getElementById('auto-approve-4k')?.checked ? '1' : '0',

                // Request limits
                movie_quota_limit: document.getElementById('movie-limit')?.value || '0',
                movie_quota_days: document.getElementById('movie-limit-days')?.value || '7',
                tv_quota_limit: document.getElementById('tv-limit')?.value || '0',
                tv_quota_days: document.getElementById('tv-limit-days')?.value || '7',
                season_quota_limit: document.getElementById('season-limit')?.value || '0',
                season_quota_days: document.getElementById('season-limit-days')?.value || '7',

                // 4K settings (granular per media type)
                default_can_request_4k_movies: document.getElementById('allow-4k-movies')?.checked ? '1' : '0',
                default_can_request_4k_tv: document.getElementById('allow-4k-tv')?.checked ? '1' : '0',
                movie_4k_quota_limit: document.getElementById('4k-movie-limit')?.value || '0',
                movie_4k_quota_days: document.getElementById('4k-movie-limit-days')?.value || '7',
                tv_4k_quota_limit: document.getElementById('4k-tv-limit')?.value || '0',
                tv_4k_quota_days: document.getElementById('4k-tv-limit-days')?.value || '7',
                season_4k_quota_limit: document.getElementById('4k-season-limit')?.value || '0',
                season_4k_quota_days: document.getElementById('4k-season-limit-days')?.value || '7',

                // Plex watchlist
                plex_watchlist_sync: document.getElementById('plex-watchlist-sync')?.checked ? '1' : '0',
                plex_watchlist_auto_request: document.getElementById('plex-watchlist-auto-request')?.checked ? '1' : '0',
                plex_sync_interval: document.getElementById('plex-sync-interval')?.value || '60',

                // Default servers
                default_radarr_server: document.getElementById('default-radarr-server')?.value || '',
                default_sonarr_server: document.getElementById('default-sonarr-server')?.value || '',
                default_radarr_4k_server: document.getElementById('default-radarr-4k-server')?.value || '',
                default_sonarr_4k_server: document.getElementById('default-sonarr-4k-server')?.value || ''
            };

            try {
                const response = await fetch('/api/v2/request-site/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    showRequestToast('Settings saved successfully', 'success');
                } else {
                    throw new Error('Failed to save settings');
                }
            } catch (error) {
                showRequestToast('Failed to save settings', 'error');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        function showAddServerModal(type, serverId = null) {
            const modal = document.getElementById('server-modal');
            const title = document.getElementById('server-modal-title');
            const form = document.getElementById('server-form');

            // Reset form
            form.reset();
            document.getElementById('server-id').value = serverId || '';
            document.getElementById('server-type').value = type;

            // Update title
            const serverTypeName = type === 'radarr' ? 'Radarr' : 'Sonarr';
            title.innerHTML = `<i class="fas fa-${type === 'radarr' ? 'film' : 'tv'}"></i> ${serverId ? 'Edit' : 'Add'} ${serverTypeName} Server`;

            // Show/hide type-specific fields
            const isSonarr = type === 'sonarr';
            document.getElementById('server-language-row').style.display = isSonarr ? 'block' : 'none';
            document.getElementById('server-availability-row').style.display = isSonarr ? 'none' : 'block';
            document.getElementById('server-series-type-row').style.display = isSonarr ? 'block' : 'none';
            document.getElementById('server-anime-section').style.display = isSonarr ? 'block' : 'none';
            document.getElementById('server-season-folders-row').style.display = isSonarr ? 'block' : 'none';

            // Reset profile/folder dropdowns
            document.getElementById('server-quality-profile').innerHTML = '<option value="">Test connection to load profiles...</option>';
            document.getElementById('server-root-folder').innerHTML = '<option value="">Test connection to load folders...</option>';
            document.getElementById('server-language-profile').innerHTML = '<option value="">Test connection to load profiles...</option>';
            document.getElementById('server-anime-quality-profile').innerHTML = '<option value="">Select quality profile...</option>';
            document.getElementById('server-anime-root-folder').innerHTML = '<option value="">Select root folder...</option>';
            document.getElementById('server-anime-language-profile').innerHTML = '<option value="">Select language profile...</option>';

            // Reset new fields to defaults
            document.getElementById('server-min-availability').value = 'released';
            document.getElementById('server-enable-scan').checked = true;
            document.getElementById('server-auto-search').checked = true;
            document.getElementById('server-tag-requests').checked = false;
            document.getElementById('server-season-folders').checked = false;
            document.getElementById('server-series-type').value = 'standard';
            document.getElementById('server-anime-series-type').value = 'standard';
            document.getElementById('server-base-url').value = '';
            document.getElementById('server-external-url').value = '';
            document.getElementById('server-anime-tags').value = '';

            // If editing, load server data
            if (serverId) {
                loadServerData(serverId);
            }

            modal.classList.add('show');
        }

        async function loadServerData(serverId) {
            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
                const response = await fetch(`/api/v2/request-site/servers/${serverId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const server = await response.json();

                    // Basic fields
                    document.getElementById('server-name').value = server.name || '';
                    document.getElementById('server-url').value = server.url || '';
                    document.getElementById('server-api-key').value = server.api_key || '';
                    document.getElementById('server-ssl').checked = server.use_ssl === 1;
                    document.getElementById('server-default').checked = server.is_default === 1;
                    document.getElementById('server-is-4k').checked = server.is_4k === 1;
                    document.getElementById('server-tags').value = server.tags || '';
                    document.getElementById('server-min-availability').value = server.minimum_availability || 'released';
                    document.getElementById('server-enable-scan').checked = server.enable_scan !== 0;
                    document.getElementById('server-auto-search').checked = server.search_on_add !== 0;

                    // Extended fields
                    document.getElementById('server-base-url').value = server.base_url || '';
                    document.getElementById('server-external-url').value = server.external_url || '';
                    document.getElementById('server-tag-requests').checked = server.tag_requests === 1;
                    document.getElementById('server-series-type').value = server.series_type || 'standard';
                    document.getElementById('server-anime-series-type').value = server.anime_series_type || 'standard';
                    document.getElementById('server-anime-tags').value = server.anime_tags || '';
                    document.getElementById('server-season-folders').checked = server.enable_season_folders === 1;

                    // Load profiles if we have connection info
                    if (server.url && server.api_key) {
                        await testServerConnection(true);

                        // Select saved values after profiles are loaded
                        setTimeout(() => {
                            if (server.quality_profile_id) {
                                document.getElementById('server-quality-profile').value = server.quality_profile_id;
                            }
                            if (server.root_folder_path) {
                                document.getElementById('server-root-folder').value = server.root_folder_path;
                            }
                            if (server.language_profile_id) {
                                document.getElementById('server-language-profile').value = server.language_profile_id;
                            }
                            // Anime fields (Sonarr only)
                            if (server.anime_quality_profile_id) {
                                document.getElementById('server-anime-quality-profile').value = server.anime_quality_profile_id;
                            }
                            if (server.anime_root_folder_path) {
                                document.getElementById('server-anime-root-folder').value = server.anime_root_folder_path;
                            }
                            if (server.anime_language_profile_id) {
                                document.getElementById('server-anime-language-profile').value = server.anime_language_profile_id;
                            }
                        }, 500);
                    }
                }
            } catch (e) {
                console.error('Error loading server data:', e);
            }
        }

        function closeServerModal() {
            document.getElementById('server-modal').classList.remove('show');
        }

        async function testServerConnection(silent = false) {
            const url = document.getElementById('server-url').value;
            const apiKey = document.getElementById('server-api-key').value;
            const type = document.getElementById('server-type').value;

            if (!url || !apiKey) {
                if (!silent) showRequestToast('Please enter URL and API key first', 'error');
                return false;
            }

            const testBtn = document.querySelector('.server-modal-footer .settings-btn-secondary:first-child');
            if (testBtn && !silent) {
                testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
                testBtn.disabled = true;
            }

            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
                const response = await fetch('/api/v2/request-site/servers/test-connection', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url, api_key: apiKey, type })
                });

                const result = await response.json();

                if (result.success) {
                    if (!silent) showRequestToast(`Connection successful! ${type === 'radarr' ? 'Radarr' : 'Sonarr'} v${result.version}`, 'success');

                    // Build option HTML for profiles and folders
                    const qualityOptions = '<option value="">Select quality profile...</option>' +
                        (result.qualityProfiles || []).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                    const rootOptions = '<option value="">Select root folder...</option>' +
                        (result.rootFolders || []).map(f => `<option value="${f.path}">${f.path} (${formatBytes(f.freeSpace)})</option>`).join('');

                    // Populate quality profiles
                    document.getElementById('server-quality-profile').innerHTML = qualityOptions;

                    // Populate root folders
                    document.getElementById('server-root-folder').innerHTML = rootOptions;

                    // Populate language profiles (Sonarr only)
                    if (type === 'sonarr' && result.languageProfiles) {
                        const langOptions = '<option value="">Select language profile...</option>' +
                            result.languageProfiles.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                        document.getElementById('server-language-profile').innerHTML = langOptions;
                        // Also populate anime language profile
                        document.getElementById('server-anime-language-profile').innerHTML = langOptions;
                    }

                    // Populate anime dropdowns (Sonarr only) - same options as regular
                    if (type === 'sonarr') {
                        document.getElementById('server-anime-quality-profile').innerHTML = qualityOptions;
                        document.getElementById('server-anime-root-folder').innerHTML = rootOptions;
                    }

                    return true;
                } else {
                    if (!silent) showRequestToast('Connection failed: ' + (result.error || 'Unknown error'), 'error');
                    return false;
                }
            } catch (e) {
                if (!silent) showRequestToast('Connection error: ' + e.message, 'error');
                return false;
            } finally {
                if (testBtn) {
                    testBtn.innerHTML = '<i class="fas fa-plug"></i> Test Connection';
                    testBtn.disabled = false;
                }
            }
        }

        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i] + ' free';
        }

        async function saveServer() {
            const serverId = document.getElementById('server-id').value;
            const type = document.getElementById('server-type').value;

            // Get quality profile names from the select elements
            const qualityProfileSelect = document.getElementById('server-quality-profile');
            const qualityProfileName = qualityProfileSelect.selectedIndex >= 0
                ? qualityProfileSelect.options[qualityProfileSelect.selectedIndex]?.text || null
                : null;

            const animeQualityProfileSelect = document.getElementById('server-anime-quality-profile');
            const animeQualityProfileName = animeQualityProfileSelect.selectedIndex >= 0
                ? animeQualityProfileSelect.options[animeQualityProfileSelect.selectedIndex]?.text || null
                : null;

            const serverData = {
                name: document.getElementById('server-name').value,
                url: document.getElementById('server-url').value,
                api_key: document.getElementById('server-api-key').value,
                type: type,
                use_ssl: document.getElementById('server-ssl').checked ? 1 : 0,
                is_default: document.getElementById('server-default').checked ? 1 : 0,
                is_4k: document.getElementById('server-is-4k').checked ? 1 : 0,
                quality_profile_id: document.getElementById('server-quality-profile').value || null,
                quality_profile_name: qualityProfileName,
                root_folder: document.getElementById('server-root-folder').value || null,
                language_profile_id: document.getElementById('server-language-profile').value || null,
                minimum_availability: document.getElementById('server-min-availability').value || 'released',
                enable_scan: document.getElementById('server-enable-scan').checked ? 1 : 0,
                enable_auto_search: document.getElementById('server-auto-search').checked ? 1 : 0,
                tags: document.getElementById('server-tags').value || null,
                // Extended options
                base_url: document.getElementById('server-base-url').value || null,
                external_url: document.getElementById('server-external-url').value || null,
                tag_requests: document.getElementById('server-tag-requests').checked ? 1 : 0,
                // Sonarr-specific options
                series_type: type === 'sonarr' ? document.getElementById('server-series-type').value : null,
                anime_series_type: type === 'sonarr' ? document.getElementById('server-anime-series-type').value : null,
                anime_quality_profile_id: type === 'sonarr' ? (document.getElementById('server-anime-quality-profile').value || null) : null,
                anime_quality_profile_name: type === 'sonarr' ? animeQualityProfileName : null,
                anime_root_folder_path: type === 'sonarr' ? (document.getElementById('server-anime-root-folder').value || null) : null,
                anime_language_profile_id: type === 'sonarr' ? (document.getElementById('server-anime-language-profile').value || null) : null,
                anime_tags: type === 'sonarr' ? (document.getElementById('server-anime-tags').value || null) : null,
                enable_season_folders: type === 'sonarr' ? (document.getElementById('server-season-folders').checked ? 1 : 0) : 0
            };

            if (!serverData.name || !serverData.url || !serverData.api_key) {
                showRequestToast('Please fill in all required fields', 'error');
                return;
            }

            const saveBtn = document.querySelector('.server-modal-footer .settings-btn-primary');
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveBtn.disabled = true;

            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
                const url = serverId
                    ? `/api/v2/request-site/servers/${serverId}`
                    : '/api/v2/request-site/servers';
                const method = serverId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(serverData)
                });

                if (response.ok) {
                    showRequestToast(`Server ${serverId ? 'updated' : 'added'} successfully`, 'success');
                    closeServerModal();
                    loadSettingsTabContent();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save server');
                }
            } catch (e) {
                showRequestToast('Error saving server: ' + e.message, 'error');
            } finally {
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Server';
                saveBtn.disabled = false;
            }
        }

        function editServer(serverId, type) {
            showAddServerModal(type, serverId);
        }

        async function testServer(serverId) {
            const statusEl = document.getElementById(`server-status-${serverId}`);
            if (!statusEl) return;

            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';

            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
                const response = await fetch(`/api/v2/request-site/servers/${serverId}/test`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();

                if (result.success) {
                    statusEl.className = 'server-status online';
                    statusEl.innerHTML = `<i class="fas fa-check-circle"></i> v${result.version || 'OK'}`;
                } else {
                    statusEl.className = 'server-status offline';
                    statusEl.innerHTML = '<i class="fas fa-times-circle"></i> Offline';
                }
            } catch (error) {
                statusEl.className = 'server-status offline';
                statusEl.innerHTML = '<i class="fas fa-times-circle"></i> Error';
            }
        }

        async function deleteServer(serverId) {
            if (!confirm('Are you sure you want to remove this server?')) return;

            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
                const response = await fetch(`/api/v2/request-site/servers/${serverId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showRequestToast('Server removed', 'success');
                    loadSettingsTabContent();
                } else {
                    throw new Error('Failed to remove server');
                }
            } catch (error) {
                showRequestToast('Failed to remove server', 'error');
            }
        }

        // Utility function to set button loading state (prevents double-clicks)
        function setButtonLoading(button, loading, originalText = null) {
            if (!button) return;
            if (loading) {
                button.disabled = true;
                button.dataset.originalHtml = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                button.style.opacity = '0.7';
                button.style.cursor = 'not-allowed';
            } else {
                button.disabled = false;
                button.innerHTML = originalText || button.dataset.originalHtml || button.innerHTML;
                button.style.opacity = '';
                button.style.cursor = '';
            }
        }

        function showRequestToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `request-toast request-toast-${type}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Save auto-scan preference for a Plex server
        async function saveAutoScanPreference(serverId, enabled) {
            const statusEl = document.getElementById('auto-scan-save-status');
            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
                const response = await fetch(`/api/v2/request-site/plex/servers/${serverId}/auto-scan`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });

                if (response.ok) {
                    // Show saved indicator
                    if (statusEl) {
                        statusEl.style.display = 'block';
                        setTimeout(() => {
                            statusEl.style.display = 'none';
                        }, 2000);
                    }
                } else {
                    const result = await response.json();
                    throw new Error(result.error || 'Failed to save');
                }
            } catch (error) {
                console.error('Failed to save auto-scan preference:', error);
                showRequestToast('Failed to save auto-scan preference', 'error');
            }
        }

        async function scanPlexLibraries() {
            const btn = document.getElementById('plex-scan-btn');
            const progress = document.getElementById('plex-scan-progress');

            // Get selected server IDs from checkboxes
            const selectedServers = [];
            document.querySelectorAll('input[name="plex-scan-server"]:checked').forEach(checkbox => {
                selectedServers.push(parseInt(checkbox.value));
            });

            if (selectedServers.length === 0) {
                showRequestToast('Please select at least one Plex server to scan', 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scanning...';
            progress.style.display = 'flex';
            progress.style.alignItems = 'center';

            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
                const response = await fetch('/api/v2/request-site/plex/scan', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ serverIds: selectedServers })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showRequestToast(`Scan complete! Found ${result.totalMovies} movies and ${result.totalTVShows} TV shows`, 'success');
                    // Reload the servers tab to show updated stats
                    loadSettingsTabContent();
                } else {
                    throw new Error(result.error || result.message || 'Scan failed');
                }
            } catch (error) {
                console.error('Plex scan error:', error);
                showRequestToast(`Scan failed: ${error.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync"></i> Scan Plex Libraries';
                progress.style.display = 'none';
            }
        }

        // ============ Media Managers Settings Tab ============
        let settingsManagers = [];
        const managerIcons = {
            sonarr: { icon: 'fa-tv', color: '#3b82f6' },
            radarr: { icon: 'fa-film', color: '#f59e0b' },
            qbittorrent: { icon: 'fa-magnet', color: '#a855f7' },
            sabnzbd: { icon: 'fa-download', color: '#f97316' }
        };

        async function loadManagersSettings(container) {
            container.innerHTML = '<div class="request-loading"><div class="request-loading-spinner"></div><div class="request-loading-text">Loading tools...</div></div>';

            try {
                const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
                const response = await fetch('/api/v2/media-managers', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                settingsManagers = data.managers || [];

                container.innerHTML = `
                    <div class="settings-section">
                        <div class="settings-section-header">
                            <h3><i class="fas fa-tools"></i> Media Managers</h3>
                            <button class="settings-btn settings-btn-primary" onclick="showAddManagerModal()">
                                <i class="fas fa-plus"></i> Add Tool
                            </button>
                        </div>
                        <p class="settings-description">Configure external tools like Sonarr, Radarr, qBittorrent, and SABnzbd. These appear in the Tools dropdown menu for quick access.</p>
                        <div id="managers-list" class="settings-card-list">
                            ${renderManagersList()}
                        </div>
                    </div>
                `;

                // Check statuses
                settingsManagers.forEach(m => checkManagerStatus(m.id));
            } catch (error) {
                console.error('Failed to load managers:', error);
                container.innerHTML = '<div class="settings-error"><i class="fas fa-exclamation-triangle"></i> Failed to load tools</div>';
            }
        }

        function renderManagersList() {
            if (settingsManagers.length === 0) {
                return `
                    <div class="settings-empty-state">
                        <i class="fas fa-tools"></i>
                        <h3>No Tools Configured</h3>
                        <p>Add Sonarr, Radarr, qBittorrent, or SABnzbd for quick access from the Tools menu</p>
                    </div>
                `;
            }

            return settingsManagers.map(manager => {
                const iconInfo = managerIcons[manager.type] || { icon: 'fa-server', color: '#6b7280' };
                return `
                    <div class="settings-card">
                        <div class="settings-card-icon" style="background: linear-gradient(135deg, ${iconInfo.color} 0%, ${adjustManagerColor(iconInfo.color, -20)} 100%);">
                            <i class="fas ${iconInfo.icon}"></i>
                        </div>
                        <div class="settings-card-info">
                            <div class="settings-card-title">
                                ${escapeHtml(manager.name)}
                                <span class="settings-badge">${manager.type}</span>
                                <span class="settings-badge">${manager.connection_mode}</span>
                                ${!manager.is_enabled ? '<span class="settings-badge settings-badge-disabled">Disabled</span>' : ''}
                            </div>
                            <div class="settings-card-subtitle">${escapeHtml(manager.url)}</div>
                        </div>
                        <div class="settings-card-status" id="manager-status-${manager.id}">
                            <i class="fas fa-circle"></i> Checking...
                        </div>
                        <div class="settings-card-actions">
                            <button class="settings-btn settings-btn-sm" onclick="openManager(${manager.id})" title="Open">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                            <button class="settings-btn settings-btn-sm" onclick="editManager(${manager.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="settings-btn settings-btn-sm settings-btn-danger" onclick="deleteManager(${manager.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function adjustManagerColor(hex, amount) {
            const num = parseInt(hex.replace('#', ''), 16);
            const r = Math.max(0, Math.min(255, (num >> 16) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
            const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
            return '#' + (1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1);
        }

        async function checkManagerStatus(managerId) {
            const statusEl = document.getElementById(`manager-status-${managerId}`);
            if (!statusEl) return;

            const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
            try {
                const response = await fetch(`/api/v2/media-managers/${managerId}/test`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();

                if (result.success) {
                    statusEl.className = 'settings-card-status settings-status-online';
                    statusEl.innerHTML = `<i class="fas fa-circle"></i> ${result.version || 'Online'}`;
                } else {
                    statusEl.className = 'settings-card-status settings-status-offline';
                    statusEl.innerHTML = '<i class="fas fa-circle"></i> Offline';
                }
            } catch (error) {
                statusEl.className = 'settings-card-status settings-status-offline';
                statusEl.innerHTML = '<i class="fas fa-circle"></i> Error';
            }
        }

        function showAddManagerModal() {
            const modal = document.getElementById('manager-modal');
            if (!modal) createManagerModal();

            document.getElementById('manager-modal-title').textContent = 'Add Tool';
            document.getElementById('manager-form').reset();
            document.getElementById('manager-id').value = '';
            document.getElementById('manager-enabled').checked = true;
            onManagerTypeChange();
            document.getElementById('manager-modal').classList.add('show');
        }

        function closeManagerModal() {
            document.getElementById('manager-modal').classList.remove('show');
        }

        function createManagerModal() {
            const modalHtml = `
                <div id="manager-modal" class="request-modal">
                    <div class="request-modal-content" style="max-width: 500px;">
                        <div class="request-modal-header">
                            <h2 id="manager-modal-title">Add Tool</h2>
                            <button class="request-modal-close" onclick="closeManagerModal()">&times;</button>
                        </div>
                        <form id="manager-form" onsubmit="saveManager(event)">
                            <input type="hidden" id="manager-id">
                            <div class="form-group">
                                <label for="manager-type">Type</label>
                                <select id="manager-type" class="form-select" required onchange="onManagerTypeChange()">
                                    <option value="">Select type...</option>
                                    <option value="sonarr">Sonarr (TV Shows)</option>
                                    <option value="radarr">Radarr (Movies)</option>
                                    <option value="qbittorrent">qBittorrent</option>
                                    <option value="sabnzbd">SABnzbd</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="manager-name">Name</label>
                                <input type="text" id="manager-name" class="form-control" placeholder="e.g., My Sonarr" required>
                            </div>
                            <div class="form-group">
                                <label for="manager-url">URL</label>
                                <input type="url" id="manager-url" class="form-control" placeholder="http://192.168.1.100:8989" required>
                            </div>
                            <div id="manager-apikey-group" class="form-group">
                                <label for="manager-api-key">API Key</label>
                                <input type="password" id="manager-api-key" class="form-control" placeholder="Enter API key">
                            </div>
                            <div id="manager-credentials-group" class="form-group" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label for="manager-username">Username</label>
                                        <input type="text" id="manager-username" class="form-control" placeholder="Username">
                                    </div>
                                    <div>
                                        <label for="manager-password">Password</label>
                                        <input type="password" id="manager-password" class="form-control" placeholder="Password">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="manager-connection-mode">Connection Mode</label>
                                <select id="manager-connection-mode" class="form-select">
                                    <option value="proxy">Proxy (Recommended)</option>
                                    <option value="direct">Direct (Iframe)</option>
                                </select>
                                <small style="color: #94a3b8; font-size: 12px; margin-top: 4px; display: block;">Proxy mode routes through your server to avoid CORS issues.</small>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="manager-enabled" checked>
                                    <span>Enabled</span>
                                </label>
                            </div>
                            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                                <button type="button" class="settings-btn" onclick="testManagerConnection()">
                                    <i class="fas fa-plug"></i> Test Connection
                                </button>
                                <button type="submit" class="settings-btn settings-btn-primary">
                                    <i class="fas fa-save"></i> Save
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function onManagerTypeChange() {
            const type = document.getElementById('manager-type').value;
            const apiKeyGroup = document.getElementById('manager-apikey-group');
            const credentialsGroup = document.getElementById('manager-credentials-group');

            if (type === 'qbittorrent') {
                apiKeyGroup.style.display = 'none';
                credentialsGroup.style.display = 'block';
            } else {
                apiKeyGroup.style.display = 'block';
                credentialsGroup.style.display = 'none';
            }
        }

        async function editManager(managerId) {
            const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
            try {
                const response = await fetch(`/api/v2/media-managers/${managerId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                const manager = data.manager;

                if (!document.getElementById('manager-modal')) createManagerModal();

                document.getElementById('manager-modal-title').textContent = 'Edit Tool';
                document.getElementById('manager-id').value = manager.id;
                document.getElementById('manager-type').value = manager.type;
                document.getElementById('manager-name').value = manager.name;
                document.getElementById('manager-url').value = manager.url;
                document.getElementById('manager-api-key').value = manager.api_key || '';
                document.getElementById('manager-username').value = manager.username || '';
                document.getElementById('manager-password').value = manager.password || '';
                document.getElementById('manager-connection-mode').value = manager.connection_mode;
                document.getElementById('manager-enabled').checked = manager.is_enabled;

                onManagerTypeChange();
                document.getElementById('manager-modal').classList.add('show');
            } catch (error) {
                showRequestToast('Failed to load tool details', 'error');
            }
        }

        async function saveManager(e) {
            e.preventDefault();

            const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
            const managerId = document.getElementById('manager-id').value;
            const isEdit = !!managerId;

            const managerData = {
                name: document.getElementById('manager-name').value,
                type: document.getElementById('manager-type').value,
                url: document.getElementById('manager-url').value,
                api_key: document.getElementById('manager-api-key').value || null,
                username: document.getElementById('manager-username').value || null,
                password: document.getElementById('manager-password').value || null,
                connection_mode: document.getElementById('manager-connection-mode').value,
                is_enabled: document.getElementById('manager-enabled').checked
            };

            try {
                const url = isEdit ? `/api/v2/media-managers/${managerId}` : '/api/v2/media-managers';
                const method = isEdit ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(managerData)
                });

                if (response.ok) {
                    showRequestToast(isEdit ? 'Tool updated' : 'Tool added', 'success');
                    closeManagerModal();
                    loadSettingsTabContent();
                    loadToolsDropdown(); // Refresh tools dropdown
                } else {
                    const error = await response.json();
                    showRequestToast(error.error || 'Failed to save tool', 'error');
                }
            } catch (error) {
                showRequestToast('Failed to save tool', 'error');
            }
        }

        async function deleteManager(managerId) {
            if (!confirm('Are you sure you want to remove this tool?')) return;

            const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
            try {
                const response = await fetch(`/api/v2/media-managers/${managerId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showRequestToast('Tool removed', 'success');
                    loadSettingsTabContent();
                    loadToolsDropdown(); // Refresh tools dropdown
                } else {
                    throw new Error('Failed to remove tool');
                }
            } catch (error) {
                showRequestToast('Failed to remove tool', 'error');
            }
        }

        async function testManagerConnection() {
            const type = document.getElementById('manager-type').value;
            const url = document.getElementById('manager-url').value;
            const apiKey = document.getElementById('manager-api-key').value;
            const username = document.getElementById('manager-username').value;
            const password = document.getElementById('manager-password').value;

            if (!type || !url) {
                showRequestToast('Please fill in type and URL', 'error');
                return;
            }

            if (type === 'qbittorrent' && (!username || !password)) {
                showRequestToast('Please enter username and password for qBittorrent', 'error');
                return;
            }

            if (type !== 'qbittorrent' && !apiKey) {
                showRequestToast('Please enter API key', 'error');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';

            const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');

            try {
                const response = await fetch('/api/v2/media-managers/test-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ type, url, api_key: apiKey, username, password })
                });

                const result = await response.json();

                if (result.success) {
                    showRequestToast(result.message || 'Connection successful!', 'success');
                } else {
                    showRequestToast(result.error || 'Connection failed', 'error');
                }
            } catch (error) {
                showRequestToast('Connection test failed', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plug"></i> Test Connection';
            }
        }

        async function openManager(managerId) {
            const token = localStorage.getItem('sessionToken') || sessionStorage.getItem('sessionToken');
            try {
                const response = await fetch(`/api/v2/media-managers/${managerId}/open-url`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.connection_mode === 'proxy') {
                    window.open(`/admin/tool-proxy.html?id=${managerId}`, '_blank');
                } else {
                    window.open(data.url, '_blank');
                }
            } catch (error) {
                showRequestToast('Failed to open tool', 'error');
            }
        }

        function saveNotificationSettings() {
            showRequestToast('Notification settings saved', 'success');
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeMediaModal();
            }
        });

        // Close modal on backdrop click
        document.getElementById('media-modal').addEventListener('click', (e) => {
            if (e.target.id === 'media-modal') {
                closeMediaModal();
            }
        });
    </script>
</body>
</html>
